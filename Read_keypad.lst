                 -1   $MODMAX10
0000              1   ;--------------------------------------------------------
0000              2   ; Special Function Registers
0000              3   ;--------------------------------------------------------
0000              4   P0             DATA 0x80
0000              5   SP             DATA 0x81
0000              6   DPL            DATA 0x82
0000              7   DPH            DATA 0x83
0000              8   PCON           DATA 0x87
0000              9   TCON           DATA 0x88
0000             10   TMOD           DATA 0x89
0000             11   TL0            DATA 0x8a
0000             12   TL1            DATA 0x8b
0000             13   TH0            DATA 0x8c
0000             14   TH1            DATA 0x8d
0000             15   P1             DATA 0x90
0000             16   SCON           DATA 0x98
0000             17   SBUF           DATA 0x99
0000             18   P2             DATA 0xa0
0000             19   IE             DATA 0xa8
0000             20   P3             DATA 0xb0
0000             21   IP             DATA 0xb8
0000             22   PSW            DATA 0xd0
0000             23   ACC            DATA 0xe0
0000             24   B              DATA 0xf0
0000             25   T2CON          DATA 0xc8
0000             26   RCAP2L         DATA 0xca
0000             27   RCAP2H         DATA 0xcb
0000             28   TL2            DATA 0xcc
0000             29   TH2            DATA 0xcd
0000             30   DPS            DATA 0x86
0000             31   DPH1           DATA 0x85
0000             32   DPL1           DATA 0x84
0000             33   HEX0           DATA 0x91
0000             34   HEX1           DATA 0x92
0000             35   HEX2           DATA 0x93
0000             36   HEX3           DATA 0x94
0000             37   HEX4           DATA 0x8e
0000             38   HEX5           DATA 0x8f
0000             39   LEDRA          DATA 0xe8
0000             40   LEDRB          DATA 0x95
0000             41   SWA            DATA 0xe8
0000             42   SWB            DATA 0x95
0000             43   KEY            DATA 0xf8
0000             44   P0MOD          DATA 0x9a
0000             45   P1MOD          DATA 0x9b
0000             46   P2MOD          DATA 0x9c
0000             47   P3MOD          DATA 0x9d
0000             48   REP_ADD_L      DATA 0xf1
0000             49   REP_ADD_H      DATA 0xf2
0000             50   REP_VALUE      DATA 0xf3
0000             51   DEBUG_CALL_L   DATA 0xfa
0000             52   DEBUG_CALL_H   DATA 0xfb
0000             53   BPC            DATA 0xfc
0000             54   BPS            DATA 0xfd
0000             55   BPAL           DATA 0xfe
0000             56   BPAH           DATA 0xff
0000             57   LBPAL          DATA 0xfa
0000             58   LBPAH          DATA 0xfb
0000             59   P4             DATA 0xc0
0000             60   P4MOD          DATA 0xc1
0000             61   XRAMUSEDAS     DATA 0xc3
0000             62   UFM_ADD0       DATA 0xe1
0000             63   UFM_ADD1       DATA 0xe2
0000             64   UFM_ADD2       DATA 0xe3
0000             65   UFM_DATA0      DATA 0xe4
0000             66   UFM_DATA1      DATA 0xe5
0000             67   UFM_DATA2      DATA 0xe6
0000             68   UFM_DATA3      DATA 0xe7
0000             69   UFM_CONTROL0   DATA 0xe9
0000             70   UFM_CONTROL1   DATA 0xea
0000             71   UFM_CONTROL2   DATA 0xeb
0000             72   UFM_CONTROL3   DATA 0xec
0000             73   UFM_DATA_CMD   DATA 0xed
0000             74   UFM_DATA_STATUS DATA 0xee
0000             75   UFM_CONTROL_CMD DATA 0xef
0000             76   ADC_C          DATA 0xa1
0000             77   ADC_L          DATA 0xa2
0000             78   ADC_H          DATA 0xa3
0000             79   
0000             80   ;--------------------------------------------------------
0000             81   ; special function bits
0000             82   ;--------------------------------------------------------
0000             83   P0_0           BIT 0x80
0000             84   P0_1           BIT 0x81
0000             85   P0_2           BIT 0x82
0000             86   P0_3           BIT 0x83
0000             87   P0_4           BIT 0x84
0000             88   P0_5           BIT 0x85
0000             89   P0_6           BIT 0x86
0000             90   P0_7           BIT 0x87
0000             91   IT0            BIT 0x88
0000             92   IE0            BIT 0x89
0000             93   IT1            BIT 0x8a
0000             94   IE1            BIT 0x8b
0000             95   TR0            BIT 0x8c
0000             96   TF0            BIT 0x8d
0000             97   TR1            BIT 0x8e
0000             98   TF1            BIT 0x8f
0000             99   P1_0           BIT 0x90
0000            100   P1_1           BIT 0x91
0000            101   P1_2           BIT 0x92
0000            102   P1_3           BIT 0x93
0000            103   P1_4           BIT 0x94
0000            104   P1_5           BIT 0x95
0000            105   P1_6           BIT 0x96
0000            106   P1_7           BIT 0x97
0000            107   RI             BIT 0x98
0000            108   TI             BIT 0x99
0000            109   RB8            BIT 0x9a
0000            110   TB8            BIT 0x9b
0000            111   REN            BIT 0x9c
0000            112   SM2            BIT 0x9d
0000            113   SM1            BIT 0x9e
0000            114   SM0            BIT 0x9f
0000            115   P2_0           BIT 0xa0
0000            116   P2_1           BIT 0xa1
0000            117   P2_2           BIT 0xa2
0000            118   P2_3           BIT 0xa3
0000            119   P2_4           BIT 0xa4
0000            120   P2_5           BIT 0xa5
0000            121   P2_6           BIT 0xa6
0000            122   P2_7           BIT 0xa7
0000            123   EX0            BIT 0xa8
0000            124   ET0            BIT 0xa9
0000            125   EX1            BIT 0xaa
0000            126   ET1            BIT 0xab
0000            127   ES             BIT 0xac
0000            128   ET2            BIT 0xad
0000            129   EA             BIT 0xaf
0000            130   P3_0           BIT 0xb0
0000            131   P3_1           BIT 0xb1
0000            132   P3_2           BIT 0xb2
0000            133   P3_3           BIT 0xb3
0000            134   P3_4           BIT 0xb4
0000            135   P3_5           BIT 0xb5
0000            136   P3_6           BIT 0xb6
0000            137   P3_7           BIT 0xb7
0000            138   RXD            BIT 0xb0
0000            139   TXD            BIT 0xb1
0000            140   INT0           BIT 0xb2
0000            141   INT1           BIT 0xb3
0000            142   T0             BIT 0xb4
0000            143   T1             BIT 0xb5
0000            144   WR             BIT 0xb6
0000            145   RD             BIT 0xb7
0000            146   PX0            BIT 0xb8
0000            147   PT0            BIT 0xb9
0000            148   PX1            BIT 0xba
0000            149   PT1            BIT 0xbb
0000            150   PS             BIT 0xbc
0000            151   PT2            BIT 0xbd
0000            152   P              BIT 0xd0
0000            153   F1             BIT 0xd1
0000            154   OV             BIT 0xd2
0000            155   RS0            BIT 0xd3
0000            156   RS1            BIT 0xd4
0000            157   F0             BIT 0xd5
0000            158   AC             BIT 0xd6
0000            159   CY             BIT 0xd7
0000            160   T2CON_0        BIT 0xc8
0000            161   T2CON_1        BIT 0xc9
0000            162   T2CON_2        BIT 0xca
0000            163   T2CON_3        BIT 0xcb
0000            164   T2CON_4        BIT 0xcc
0000            165   T2CON_5        BIT 0xcd
0000            166   T2CON_6        BIT 0xce
0000            167   T2CON_7        BIT 0xcf
0000            168   CP_RL2         BIT 0xc8
0000            169   C_T2           BIT 0xc9
0000            170   TR2            BIT 0xca
0000            171   EXEN2          BIT 0xcb
0000            172   TCLK           BIT 0xcc
0000            173   RCLK           BIT 0xcd
0000            174   EXF2           BIT 0xce
0000            175   TF2            BIT 0xcf
0000            176   LEDRA_0        BIT 0xe8
0000            177   LEDRA_1        BIT 0xe9
0000            178   LEDRA_2        BIT 0xea
0000            179   LEDRA_3        BIT 0xeb
0000            180   LEDRA_4        BIT 0xec
0000            181   LEDRA_5        BIT 0xed
0000            182   LEDRA_6        BIT 0xee
0000            183   LEDRA_7        BIT 0xef
0000            184   SWA_0          BIT 0xe8
0000            185   SWA_1          BIT 0xe9
0000            186   SWA_2          BIT 0xea
0000            187   SWA_3          BIT 0xeb
0000            188   SWA_4          BIT 0xec
0000            189   SWA_5          BIT 0xed
0000            190   SWA_6          BIT 0xee
0000            191   SWA_7          BIT 0xef
0000            192   KEY_0          BIT 0xf8
0000            193   KEY_1          BIT 0xf9
0000            194   KEY_2          BIT 0xfa
0000            195   KEY_3          BIT 0xfb
0000            196   P4_0           BIT 0xc0
0000            197   P4_1           BIT 0xc1
0000            198   P4_2           BIT 0xc2
0000            199   P4_3           BIT 0xc3
0000            200   P4_4           BIT 0xc4
0000            201   P4_5           BIT 0xc5
0000            202   P4_6           BIT 0xc6
0000            203   P4_7           BIT 0xc7
0000              2   
0000              3            CSEG at 0
0000 02027C       4            ljmp main_code
0003              5   
0030              6            DSEG at 30H
0030              7   bcd:     ds 5
0035              8   
0003              9            CSEG
0003             10   
0003             11   ; Look-up table for 7-seg displays
0003             12   myLUT:
0003 C0F9A4B0    13       DB 0xC0, 0xF9, 0xA4, 0xB0, 0x99        ; 0 TO 4
     99
0008 9282F880    14       DB 0x92, 0x82, 0xF8, 0x80, 0x90        ; 4 TO 9
     90
000D 8883C6A1    15       DB 0x88, 0x83, 0xC6, 0xA1, 0x86, 0x8E  ; A to F
     868E
0013             16   
                 17   showBCD MAC
                 18   	; Display LSD
                 19       mov A, %0
                 20       anl a, #0fh
                 21       movc A, @A+dptr
                 22       mov %1, A
                 23   	; Display MSD
                 24       mov A, %0
                 25       swap a
                 26       anl a, #0fh
                 27       movc A, @A+dptr
                 28       mov %2, A
                 29   ENDMAC
0013             30   
0013             31   Display:
0013 900003      32            mov dptr, #myLUT
0016             33            
                 33   	$MESSAGE TIP: If digits 10, 9, 8, and 7 are not zero, LEDR7: on
0016             35            
0016 E533        36            mov a, bcd+3
0018 4534        37            orl a, bcd+4
001A 6004        38            jz Display_L1
001C D2EF        39            setb LEDRA.7 ; Non-zero digits alert
001E 8002        40            sjmp Display_L2
0020             41   Display_L1:
0020 C2EF        42            clr LEDRA.7
0022             43   Display_L2:
0022             44   
                 44   	$MESSAGE TIP: Pressing KEY3, displays the most significant digits of the 10-digit number
0022             46            
0022 30FB2F      47            jnb key.3, Display_high_digits
0025             48            ; Display LSD
0025 E530        48       mov A, bcd+0
0027 540F        48       anl a, #0fh
0029 93          48       movc A, @A+dptr
002A F591        48       mov HEX0, A
002C             48            ; Display MSD
002C E530        48       mov A, bcd+0
002E C4          48       swap a
002F 540F        48       anl a, #0fh
0031 93          48       movc A, @A+dptr
0032 F592        48       mov HEX1, A
0034             49            ; Display LSD
0034 E531        49       mov A, bcd+1
0036 540F        49       anl a, #0fh
0038 93          49       movc A, @A+dptr
0039 F593        49       mov HEX2, A
003B             49            ; Display MSD
003B E531        49       mov A, bcd+1
003D C4          49       swap a
003E 540F        49       anl a, #0fh
0040 93          49       movc A, @A+dptr
0041 F594        49       mov HEX3, A
0043             50            ; Display LSD
0043 E532        50       mov A, bcd+2
0045 540F        50       anl a, #0fh
0047 93          50       movc A, @A+dptr
0048 F58E        50       mov HEX4, A
004A             50            ; Display MSD
004A E532        50       mov A, bcd+2
004C C4          50       swap a
004D 540F        50       anl a, #0fh
004F 93          50       movc A, @A+dptr
0050 F58F        50       mov HEX5, A
0052 8024        51            sjmp Display_end
0054             52   
0054             53   Display_high_digits:
0054             54            ; Display LSD
0054 E533        54       mov A, bcd+3
0056 540F        54       anl a, #0fh
0058 93          54       movc A, @A+dptr
0059 F591        54       mov HEX0, A
005B             54            ; Display MSD
005B E533        54       mov A, bcd+3
005D C4          54       swap a
005E 540F        54       anl a, #0fh
0060 93          54       movc A, @A+dptr
0061 F592        54       mov HEX1, A
0063             55            ; Display LSD
0063 E534        55       mov A, bcd+4
0065 540F        55       anl a, #0fh
0067 93          55       movc A, @A+dptr
0068 F593        55       mov HEX2, A
006A             55            ; Display MSD
006A E534        55       mov A, bcd+4
006C C4          55       swap a
006D 540F        55       anl a, #0fh
006F 93          55       movc A, @A+dptr
0070 F594        55       mov HEX3, A
0072 758EFF      56            mov HEX4, #0xff         
0075 758FFF      57            mov HEX5, #0xff         
0078             58            
0078             59   Display_end:
0078 22          60       ret
0079             61   
                 62   MYRLC MAC
                 63   	mov a, %0
                 64   	rlc a
                 65   	mov %0, a
                 66   ENDMAC
0079             67   
0079             68   Shift_Digits_Left:
0079 7804        69            mov R0, #4 ; shift left four bits
007B             70            ; Uncomment the following four lines if you want to limit input to 10 digits
007B             71            ; mov a, bcd+4
007B             72            ; anl a, #0xf0
007B             73            ; jz Shift_Digits_Left_L0
007B             74            ; ret
007B             75   Shift_Digits_Left_L0:
007B C3          76            clr c
007C E530        77            mov a, bcd+0
007E 33          77            rlc a
007F F530        77            mov bcd+0, a
0081 E531        78            mov a, bcd+1
0083 33          78            rlc a
0084 F531        78            mov bcd+1, a
0086 E532        79            mov a, bcd+2
0088 33          79            rlc a
0089 F532        79            mov bcd+2, a
008B E533        80            mov a, bcd+3
008D 33          80            rlc a
008E F533        80            mov bcd+3, a
0090 E534        81            mov a, bcd+4
0092 33          81            rlc a
0093 F534        81            mov bcd+4, a
0095 D8E4        82            djnz R0, Shift_Digits_Left_L0
0097             83            ; R7 has the new bcd digit      
0097 EF          84            mov a, R7
0098 4530        85            orl a, bcd+0
009A F530        86            mov bcd+0, a
009C 22          87            ret
009D             88            
                 89   MYRRC MAC
                 90   	mov a, %0
                 91   	rrc a
                 92   	mov %0, a
                 93   ENDMAC
009D             94   
009D             95   Shift_Digits_Right:
009D 7804        96            mov R0, #4 ; shift right four bits
009F             97   
009F             98   Shift_Digits_Right_L0:
009F C3          99            clr c
00A0 E534       100            mov a, bcd+4
00A2 13         100            rrc a
00A3 F534       100            mov bcd+4, a
00A5 E533       101            mov a, bcd+3
00A7 13         101            rrc a
00A8 F533       101            mov bcd+3, a
00AA E532       102            mov a, bcd+2
00AC 13         102            rrc a
00AD F532       102            mov bcd+2, a
00AF E531       103            mov a, bcd+1
00B1 13         103            rrc a
00B2 F531       103            mov bcd+1, a
00B4 E530       104            mov a, bcd+0
00B6 13         104            rrc a
00B7 F530       104            mov bcd+0, a
00B9 D8E4       105            djnz R0, Shift_Digits_Right_L0
00BB 22         106            ret
00BC            107   
00BC            108   Wait25ms:
00BC            109   ;33.33MHz, 1 clk per cycle: 0.03us
00BC 780F       110            mov R0, #15
00BE 794A       111   L3: mov R1, #74
00C0 7AFA       112   L2: mov R2, #250
00C2 DAFE       113   L1: djnz R2, L1 ;3*250*0.03us=22.5us
00C4 D9FA       114       djnz R1, L2 ;74*22.5us=1.665ms
00C6 D8F6       115       djnz R0, L3 ;1.665ms*15=25ms
00C8 22         116       ret
00C9            117   
                118   CHECK_COLUMN MAC
                119   	jb %0, CHECK_COL_%M
                120   	mov R7, %1
                121   	jnb %0, $ ; wait for key release
                122   	setb c
                123   	ret
                124   CHECK_COL_%M:
                125   ENDMAC
00C9            126   
00C9            127   Configure_Keypad_Pins:
00C9            128            ; Configure the row pins as output and the column pins as inputs
00C9 439B54     129            orl P1MOD, #0b_01010100 ; P1.6, P1.4, P1.2 output
00CC 439C01     130            orl P2MOD, #0b_00000001 ; P2.0 output
00CF 539CAB     131            anl P2MOD, #0b_10101011 ; P2.6, P2.4, P2.2 input
00D2 539DFE     132            anl P3MOD, #0b_11111110 ; P3.0 input
00D5 22         133            ret
00D6            134   
00D6            135   ; These are the pins used for the keypad in this program:
00D6            136   ROW1 EQU P1.2
00D6            137   ROW2 EQU P1.4
00D6            138   ROW3 EQU P1.6
00D6            139   ROw4 EQU P2.0
00D6            140   COL1 EQU P2.2
00D6            141   COL2 EQU P2.4
00D6            142   COL3 EQU P2.6
00D6            143   COL4 EQU P3.0
00D6            144   
00D6            145   ; This subroutine scans a 4x4 keypad.  If a key is pressed sets the carry
00D6            146   ; to one and returns the key code in register R7.
00D6            147   ; It works with both a default keypad or a modified keypad with the labels
00D6            148   ; rotated 90 deg ccw.  The type of keypad is determined by SW0, which is bit SWA.0
00D6            149   Keypad:
00D6            150            ; First check the backspace/correction pushbutton.  We use KEY1 for this function.
                150   	$MESSAGE TIP: KEY1 is the erase key
00D6 20F90E     152            jb KEY.1, keypad_L0
00D9 1200BC     153            lcall Wait25ms ; debounce
00DC 20F908     154            jb KEY.1, keypad_L0
00DF 30F9FD     155            jnb KEY.1, $ ; The key was pressed, wait for release
00E2 12009D     156            lcall Shift_Digits_Right
00E5 C3         157            clr c
00E6 22         158            ret
00E7            159            
00E7            160   keypad_L0:
00E7            161            ; Make all the rows zero.  If any column is zero then a key is pressed.
00E7 C292       162            clr ROW1
00E9 C294       163            clr ROW2
00EB C296       164            clr ROW3
00ED C2A0       165            clr ROW4
00EF A2A2       166            mov c, COL1
00F1 82A4       167            anl c, COL2
00F3 82A6       168            anl c, COL3
00F5 82B0       169            anl c, COL4
00F7 5002       170            jnc Keypad_Debounce
00F9 C3         171            clr c
00FA 22         172            ret
00FB            173                    
00FB            174   Keypad_Debounce:
00FB            175            ; A key maybe pressed.  Wait and check again to discard bounces.
00FB 1200BC     176            lcall Wait25ms ; debounce
00FE A2A2       177            mov c, COL1
0100 82A4       178            anl c, COL2
0102 82A6       179            anl c, COL3
0104 82B0       180            anl c, COL4
0106 5002       181            jnc Keypad_Key_Code
0108 C3         182            clr c
0109 22         183            ret
010A            184            
010A            185   Keypad_Key_Code:         
010A            186            ; A key is pressed.  Find out which one by checking each possible column and row combination.
010A            187   
010A D292       188            setb ROW1
010C D294       189            setb ROW2
010E D296       190            setb ROW3
0110 D2A0       191            setb ROW4
0112            192            
                192   	$MESSAGE TIP: SW0 is used to control the layout of the keypad. SW0=0: unmodified keypad. SW0=1: keypad rotated 90 deg CCW
0112            194   
0112 30E803     195            jnb SWA.0, keypad_default
0115 0201CA     196            ljmp keypad_90deg
0118            197            
0118            198            ; This check section is for an un-modified keypad
0118            199   keypad_default:  
0118            200            ; Check row 1   
0118 C292       201            clr ROW1
011A 20A207     202            jb COL1, CHECK_COL_16
011D 7F01       202            mov R7, #01H
011F 30A2FD     202            jnb COL1, $ ; wait for key release
0122 D3         202            setb c
0123 22         202            ret
0124            202   CHECK_COL_16:
0124 20A407     203            jb COL2, CHECK_COL_17
0127 7F02       203            mov R7, #02H
0129 30A4FD     203            jnb COL2, $ ; wait for key release
012C D3         203            setb c
012D 22         203            ret
012E            203   CHECK_COL_17:
012E 20A607     204            jb COL3, CHECK_COL_18
0131 7F03       204            mov R7, #03H
0133 30A6FD     204            jnb COL3, $ ; wait for key release
0136 D3         204            setb c
0137 22         204            ret
0138            204   CHECK_COL_18:
0138 20B007     205            jb COL4, CHECK_COL_19
013B 7F0A       205            mov R7, #0AH
013D 30B0FD     205            jnb COL4, $ ; wait for key release
0140 D3         205            setb c
0141 22         205            ret
0142            205   CHECK_COL_19:
0142 D292       206            setb ROW1
0144            207   
0144            208            ; Check row 2   
0144 C294       209            clr ROW2
0146 20A207     210            jb COL1, CHECK_COL_20
0149 7F04       210            mov R7, #04H
014B 30A2FD     210            jnb COL1, $ ; wait for key release
014E D3         210            setb c
014F 22         210            ret
0150            210   CHECK_COL_20:
0150 20A407     211            jb COL2, CHECK_COL_21
0153 7F05       211            mov R7, #05H
0155 30A4FD     211            jnb COL2, $ ; wait for key release
0158 D3         211            setb c
0159 22         211            ret
015A            211   CHECK_COL_21:
015A 20A607     212            jb COL3, CHECK_COL_22
015D 7F06       212            mov R7, #06H
015F 30A6FD     212            jnb COL3, $ ; wait for key release
0162 D3         212            setb c
0163 22         212            ret
0164            212   CHECK_COL_22:
0164 20B007     213            jb COL4, CHECK_COL_23
0167 7F0B       213            mov R7, #0BH
0169 30B0FD     213            jnb COL4, $ ; wait for key release
016C D3         213            setb c
016D 22         213            ret
016E            213   CHECK_COL_23:
016E D294       214            setb ROW2
0170            215   
0170            216            ; Check row 3   
0170 C296       217            clr ROW3
0172 20A207     218            jb COL1, CHECK_COL_24
0175 7F07       218            mov R7, #07H
0177 30A2FD     218            jnb COL1, $ ; wait for key release
017A D3         218            setb c
017B 22         218            ret
017C            218   CHECK_COL_24:
017C 20A407     219            jb COL2, CHECK_COL_25
017F 7F08       219            mov R7, #08H
0181 30A4FD     219            jnb COL2, $ ; wait for key release
0184 D3         219            setb c
0185 22         219            ret
0186            219   CHECK_COL_25:
0186 20A607     220            jb COL3, CHECK_COL_26
0189 7F09       220            mov R7, #09H
018B 30A6FD     220            jnb COL3, $ ; wait for key release
018E D3         220            setb c
018F 22         220            ret
0190            220   CHECK_COL_26:
0190 20B007     221            jb COL4, CHECK_COL_27
0193 7F0C       221            mov R7, #0CH
0195 30B0FD     221            jnb COL4, $ ; wait for key release
0198 D3         221            setb c
0199 22         221            ret
019A            221   CHECK_COL_27:
019A D296       222            setb ROW3
019C            223   
019C            224            ; Check row 4   
019C C2A0       225            clr ROW4
019E 20A207     226            jb COL1, CHECK_COL_28
01A1 7F0E       226            mov R7, #0EH
01A3 30A2FD     226            jnb COL1, $ ; wait for key release
01A6 D3         226            setb c
01A7 22         226            ret
01A8            226   CHECK_COL_28:
01A8 20A407     227            jb COL2, CHECK_COL_29
01AB 7F00       227            mov R7, #00H
01AD 30A4FD     227            jnb COL2, $ ; wait for key release
01B0 D3         227            setb c
01B1 22         227            ret
01B2            227   CHECK_COL_29:
01B2 20A607     228            jb COL3, CHECK_COL_30
01B5 7F0F       228            mov R7, #0FH
01B7 30A6FD     228            jnb COL3, $ ; wait for key release
01BA D3         228            setb c
01BB 22         228            ret
01BC            228   CHECK_COL_30:
01BC 20B007     229            jb COL4, CHECK_COL_31
01BF 7F0D       229            mov R7, #0DH
01C1 30B0FD     229            jnb COL4, $ ; wait for key release
01C4 D3         229            setb c
01C5 22         229            ret
01C6            229   CHECK_COL_31:
01C6 D2A0       230            setb ROW4
01C8            231   
01C8 C3         232            clr c
01C9 22         233            ret
01CA            234            
01CA            235            ; This check section is for a keypad with the labels rotated 90 deg ccw
01CA            236   keypad_90deg:
01CA            237            ; Check row 1   
01CA C292       238            clr ROW1
01CC 20A207     239            jb COL1, CHECK_COL_32
01CF 7F0A       239            mov R7, #0AH
01D1 30A2FD     239            jnb COL1, $ ; wait for key release
01D4 D3         239            setb c
01D5 22         239            ret
01D6            239   CHECK_COL_32:
01D6 20A407     240            jb COL2, CHECK_COL_33
01D9 7F0B       240            mov R7, #0BH
01DB 30A4FD     240            jnb COL2, $ ; wait for key release
01DE D3         240            setb c
01DF 22         240            ret
01E0            240   CHECK_COL_33:
01E0 20A607     241            jb COL3, CHECK_COL_34
01E3 7F0C       241            mov R7, #0CH
01E5 30A6FD     241            jnb COL3, $ ; wait for key release
01E8 D3         241            setb c
01E9 22         241            ret
01EA            241   CHECK_COL_34:
01EA 20B007     242            jb COL4, CHECK_COL_35
01ED 7F0D       242            mov R7, #0DH
01EF 30B0FD     242            jnb COL4, $ ; wait for key release
01F2 D3         242            setb c
01F3 22         242            ret
01F4            242   CHECK_COL_35:
01F4 D292       243            setb ROW1
01F6            244   
01F6            245            ; Check row 2   
01F6 C294       246            clr ROW2
01F8 20A207     247            jb COL1, CHECK_COL_36
01FB 7F03       247            mov R7, #03H
01FD 30A2FD     247            jnb COL1, $ ; wait for key release
0200 D3         247            setb c
0201 22         247            ret
0202            247   CHECK_COL_36:
0202 20A407     248            jb COL2, CHECK_COL_37
0205 7F06       248            mov R7, #06H
0207 30A4FD     248            jnb COL2, $ ; wait for key release
020A D3         248            setb c
020B 22         248            ret
020C            248   CHECK_COL_37:
020C 20A607     249            jb COL3, CHECK_COL_38
020F 7F09       249            mov R7, #09H
0211 30A6FD     249            jnb COL3, $ ; wait for key release
0214 D3         249            setb c
0215 22         249            ret
0216            249   CHECK_COL_38:
0216 20B007     250            jb COL4, CHECK_COL_39
0219 7F0F       250            mov R7, #0FH
021B 30B0FD     250            jnb COL4, $ ; wait for key release
021E D3         250            setb c
021F 22         250            ret
0220            250   CHECK_COL_39:
0220 D294       251            setb ROW2
0222            252   
0222            253            ; Check row 3   
0222 C296       254            clr ROW3
0224 20A207     255            jb COL1, CHECK_COL_40
0227 7F02       255            mov R7, #02H
0229 30A2FD     255            jnb COL1, $ ; wait for key release
022C D3         255            setb c
022D 22         255            ret
022E            255   CHECK_COL_40:
022E 20A407     256            jb COL2, CHECK_COL_41
0231 7F05       256            mov R7, #05H
0233 30A4FD     256            jnb COL2, $ ; wait for key release
0236 D3         256            setb c
0237 22         256            ret
0238            256   CHECK_COL_41:
0238 20A607     257            jb COL3, CHECK_COL_42
023B 7F08       257            mov R7, #08H
023D 30A6FD     257            jnb COL3, $ ; wait for key release
0240 D3         257            setb c
0241 22         257            ret
0242            257   CHECK_COL_42:
0242 20B007     258            jb COL4, CHECK_COL_43
0245 7F00       258            mov R7, #00H
0247 30B0FD     258            jnb COL4, $ ; wait for key release
024A D3         258            setb c
024B 22         258            ret
024C            258   CHECK_COL_43:
024C D296       259            setb ROW3
024E            260   
024E            261            ; Check row 4   
024E C2A0       262            clr ROW4
0250 20A207     263            jb COL1, CHECK_COL_44
0253 7F01       263            mov R7, #01H
0255 30A2FD     263            jnb COL1, $ ; wait for key release
0258 D3         263            setb c
0259 22         263            ret
025A            263   CHECK_COL_44:
025A 20A407     264            jb COL2, CHECK_COL_45
025D 7F04       264            mov R7, #04H
025F 30A4FD     264            jnb COL2, $ ; wait for key release
0262 D3         264            setb c
0263 22         264            ret
0264            264   CHECK_COL_45:
0264 20A607     265            jb COL3, CHECK_COL_46
0267 7F07       265            mov R7, #07H
0269 30A6FD     265            jnb COL3, $ ; wait for key release
026C D3         265            setb c
026D 22         265            ret
026E            265   CHECK_COL_46:
026E 20B007     266            jb COL4, CHECK_COL_47
0271 7F0E       266            mov R7, #0EH
0273 30B0FD     266            jnb COL4, $ ; wait for key release
0276 D3         266            setb c
0277 22         266            ret
0278            266   CHECK_COL_47:
0278 D2A0       267            setb ROW4
027A            268   
027A C3         269            clr c
027B 22         270            ret
027C            271            
027C            272   main_code:
027C 75817F     273            mov SP, #7FH
027F E4         274            clr a
0280 F5E8       275            mov LEDRA, a
0282 F595       276            mov LEDRB, a
0284 F530       277            mov bcd+0, a
0286 F531       278            mov bcd+1, a
0288 F532       279            mov bcd+2, a
028A F533       280            mov bcd+3, a
028C F534       281            mov bcd+4, a
028E 1200C9     282            lcall Configure_Keypad_Pins
0291            283   
0291            284   forever:
0291 1200D6     285            lcall Keypad
0294 120013     286            lcall Display
0297 50F8       287            jnc forever
0299 120079     288            lcall Shift_Digits_Left
029C 020291     289            ljmp forever
029F            290            
029F            291   end
