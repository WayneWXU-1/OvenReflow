                  2   $LIST
0000              4   
0000              5   CLK           EQU 33333333 ; Microcontroller system crystal frequency in Hz
0000              6   TIMER0_RATE   EQU 4096     ; 2048Hz squarewave (peak amplitude of CEM-1203 speaker)
0000              7   TIMER0_RELOAD EQU ((65536-(CLK/(12*TIMER0_RATE)))) ; The prescaler in the CV-8052 is always 12 unlike the N76E003 where is selectable.
0000              8   TIMER2_RATE   EQU 1000     ; 1000Hz, for a timer tick of 1ms
0000              9   TIMER2_RELOAD EQU ((65536-(CLK/(12*TIMER2_RATE))))
0000             10   BAND          EQU 2 ;for flat states
0000             11   LEAD2              EQU 0
0000             12   LEAD          EQU 20 ;for ramp sates
0000             13   
0000             14   BAUD   EQU 57600
0000             15   T1_LOAD EQU 256-(2*CLK) / (32*12*BAUD) ;Load 253 so it counts 3 counts before overflowing, which gives us a 57600 baud rate with a 33.333MHz clock
0000             16   
0000             17   
0000             18   ; ********* Buttons ***********
0000             19   SELECT_BUTTON equ KEY_1
0000             20   RESET_BUTTON  equ KEY_3
0000             21   START_BUTTON  equ P3_5 ; left on board
0000             22   STOP_BUTTON   equ P3_7 ; right on board
0000             23   PARAM_BUTTON  equ KEY_2
0000             24   
0000             25   OVEN_PIN      equ P0.0
0000             26   SOUND_OUT     equ P1.5 ; Speaker attached to this pin
0000             27   UPDOWN        equ SWA.0
0000             28   TENS          equ SWA.1
0000             29   
0000             30   ; Reset vector
0000             31   org 0x0000
0000 02073F      32       ljmp main
0003             33   
0003             34   ; External interrupt 0 vector (not used in this code)
0003             35   org 0x0003
0003 32          36            reti
0004             37   
0004             38   ; Timer/Counter 0 overflow interrupt vector
000B             39   org 0x000B
000B 02056C      40            ljmp Timer0_ISR
000E             41   
000E             42   ; External interrupt 1 vector (not used in this code)
0013             43   org 0x0013
0013 32          44            reti
0014             45   
0014             46   ; Timer/Counter 1 overflow interrupt vector (not used in this code)
001B             47   org 0x001B
001B 32          48            reti
001C             49   
001C             50   ; Serial port receive/transmit interrupt vector (not used in this code)
0023             51   org 0x0023 
0023 32          52            reti
0024             53            
0024             54   ; Timer/Counter 2 overflow interrupt vector
002B             55   org 0x002B
002B 02058E      56            ljmp Timer2_ISR
002E             57   
002E             58   
002E             59   ;--- DATA RAM ---
0030             60   dseg at 0x30
0030             61   STATE_VAR_1:     DS 1 
0031             62   STATE_VAR_2:     DS 1
0032             63   SECOND_COUNTER:  DS 1 
0033             64   TEMP_HIGH_BYTE:  DS 1 
0034             65   TEMP_LOW_BYTE:   DS 1 
0035             66   
0035             67   
0035             68   TEMP:            DS 5
003A             69   TIME:            DS 2
003C             70   POWER:           DS 2
003E             71   DEGREES60:       DS 2
0040             72   DEGREES150:      DS 2
0042             73   DEGREES220:      DS 2
0044             74   TARGET:           DS 2
0046             75   ;*** Variables ***
0046             76   SOAK_TEMP_set:       ds 2
0048             77   SOAK_TIME_set:       ds 2
004A             78   reflow_temp_set:     ds 2
004C             79   REFLOW_TIME_set:     ds 2
004E             80   
004E             81   soak_time:       ds 2
0050             82   REFLOW_TIME:     ds 2
0052             83   
0052             84   beep_count:      ds 1
0053             85   
0053             86   ; PWM variables
0053             87   LOW_LIMIT:  ds 2
0055             88   HIGH_LIMIT: ds 2
0057             89   THRESHOLD:  ds 2
0059             90   
0059             91   x:               ds      4 ;used for 32 bit math for temperature conversion
005D             92   y:               ds      4 ;used for 32 bit math for temperature conversion
0061             93   bcd:    ds  5 ; <--- ADD THIS: math32 needs 5 bytes for BCD conversions
0066             94   
0066             95   ;--ISR RELATED--;
0066             96   Count1ms:     ds 2 ; Used to determine when half second has passed
0068             97   BCD_counter:  ds 1 ; The BCD counter incrememted in the ISR and displayed in the main loop
0069             98   
0069             99   
0000            100   bseg
0000            101   START_FLAG:         DBIT 1  ; Use DBIT for single bits in bseg
0001            102   half_seconds_flag:  DBIT 1  ; half second flag
0002            103   SECONDS_FLAG:       DBIT 1  ; can change later depending on how fast we want it
0003            104   SELECT_BUTTON_FLAG: DBIT 1
0004            105   PARAM_BUTTON_FLAG:  DBIT 1
0005            106   mf:     dbit 1 ; <--- ADD THIS: math32 uses this as a status flag
0006            107   
002E            108   cseg
002E            109   ; These 'equ' must match the hardware wiring
002E            110   ; None of these are implemented yet, we need to match these assignments to the wiring
002E            111   ELCD_RS equ P1.7
002E            112   ;LCD_RW equ PX.X ; Not used in this code, connect the pin to GND
002E            113   ELCD_E equ  P1.1
002E            114   ELCD_D4 equ P0.7
002E            115   ELCD_D5 equ P0.5
002E            116   ELCD_D6 equ P0.3
002E            117   ELCD_D7 equ P0.1
002E            118   
002E            119   ;Keypad pin assignments
002E            120   ROW1 EQU P1.2
002E            121   ROW2 EQU P1.4
002E            122   ROW3 EQU P1.6
002E            123   ROw4 EQU P2.0
002E            124   COL1 EQU P2.2
002E            125   COL2 EQU P2.4
002E            126   COL3 EQU P2.6
002E            127   COL4 EQU P3.0
002E            128   
002E            129   ;                           1234567890123456
002E 20202020   130   blank_row:              db '                ', 0
     20202020
     20202020
     20202020
     00
003F 53656C65   131   param_message:          db 'Select Parameter', 0
     63742050
     6172616D
     65746572
     00
0050 536F616B   132   soak_temp_message:      db 'Soak Temp: xxx C', 0
     2054656D
     703A2078
     78782043
     00
0061 536F616B   133   soak_time_message:      db 'Soak Time: xx  s', 0
     2054696D
     653A2078
     78202073
     00
0072 52666C77   134   reflow_temp_message:    db 'Rflw Temp: xxx C', 0
     2054656D
     703A2078
     78782043
     00
0083 52666C77   135   reflow_time_message:    db 'Rflw Time: xx  s', 0
     2054696D
     653A2078
     78202073
     00
0094 52656164   136   ready_message:          db 'Ready to Start! ', 0
     7920746F
     20537461
     72742120
     00
00A5 53746174   137   state0_message:         db 'State 0 Placehold', 0
     65203020
     506C6163
     65686F6C
     6400
00B7 53746174   138   state1_message:         db 'State 1 Placehold', 0
     65203120
     506C6163
     65686F6C
     6400
00C9 53746174   139   state2_message:         db 'State 2 Placehold', 0
     65203220
     506C6163
     65686F6C
     6400
00DB 53746174   140   state3_message:         db 'State 3 Placehold', 0
     65203320
     506C6163
     65686F6C
     6400
00ED 53746174   141   state4_message:         db 'State 4 Placehold', 0
     65203420
     506C6163
     65686F6C
     6400
00FF 53746174   142   state5_message:         db 'State 5 Placehold', 0
     65203520
     506C6163
     65686F6C
     6400
0111 41424F52   143   abortcondition_message: db 'ABORT', 0
     5400
0117 54494D45   144   reflow_message:         db 'TIME: XX TEMP: XX', 0
     3A205858
     2054454D
     503A2058
     5800
0129 5265666C   145   reflowdone_message:     db 'Reflow Complete!', 0
     6F772043
     6F6D706C
     65746521
     00
013A 52535420   146   restart_message:        db 'RST To Bake Again', 0
     546F2042
     616B6520
     41676169
     6E00
014C            147   
                149   	$LIST
0203            151   
                614   $LIST
                154   $LIST
04F5            156   
04F5            157   ;-----------------------INTIALIZE SERIAL PORT FOR INPUT OUTUUT-----------------------;
04F5            158   ;--Setting baud rate to 57600 with 33.33MHz clock--;
04F5            159   ;-----------EXPLANATION------------
04F5            160   ;Crystal oscillates at 33.33Mhz, the CV-8052 has a fixed prescaler of 12 for timers
04F5            161   ;So the effective clock for timers is 33.33MHz/12 = 2.7775MHzl
04F5            162   ;SMOD is set to 1 in PCON so using 1/16th the clock for baud rate generation
04F5            163   ;That means the baud rate clock is 2.7775MHz/16 = 173.611kHz
04F5            164   ;Since we have 253 out of 256 its three clicks 
04F5            165   ;per bit, the baud rate is 173.611kHz/3 = 57.870kbps which is close enough to 57600bps
04F5            166   ;-----------------------------------
04F5            167   
04F5            168   InitSerialPort:
04F5            169            ; Configure serial port and baud rate
04F5 C28E       170       clr TR1 ; Disable timer 1
04F7 E589       171       mov a, TMOD
04F9 540F       172       anl a, #0x0f ; Clear the bits for timer 1
04FB 4420       173       orl a, #0x20 ; Configure timer 1 as 8-bit autoreload
04FD F589       174       mov TMOD, a ; Set timer 1 mode
04FF            175   
04FF 758DFD     176       mov TH1, #T1_LOAD ; Load the timer value for the desired baud rate
0502 758BFD     177       mov TL1, #T1_LOAD ;Doesnt matter what we load in TL1 because it is in autoreload mode, but we need to load it with something to prevent it from overflowing immediately
0505            178       ;Leave it as you found it, make SMOD = 1 for double baud rate
0505 E587       179       mov a, PCON ; Set SMOD to 1
0507 4480       180       orl a, #0x80
0509 F587       181       mov PCON, a
050B D28E       182       setb TR1 ; Enable timer 1
050D 759852     183       mov SCON, #01010010B ; Mode 1, 8-bit UART, enable receiver
0510 22         184            ret
0511            185   
0511            186   Display_Voltage_Serial:
0511 853559     187            mov x+0, TEMP+0 ; reloads the temp into x which will be converted to bcd
0514 85365A     188       mov x+1, TEMP+1
0517 755B00     189       mov x+2, #0
051A 755C00     190       mov x+3, #0
051D 120203     191       lcall hex2bcd ; standard math32.asm function
0520            192       
0520 7454       193            mov a, #'T'
0522 120551     194            lcall putchar
0525 743D       195            mov a, #'='
0527 120551     196            lcall putchar
052A            197            
052A E562       198            mov a, bcd+1
052C 540F       199            anl a, #0FH
052E 4430       200            orl a, #'0'
0530 120551     201            lcall putchar
0533            202   
0533 E561       203            mov a, bcd+0
0535 C4         204            swap a
0536 540F       205            anl a, #0FH
0538 4430       206            orl a, #'0'
053A 120551     207            lcall putchar
053D            208            
053D E561       209            mov a, bcd+0
053F 540F       210            anl a, #0FH
0541 4430       211            orl a, #'0'
0543 120551     212            lcall putchar
0546            213   
0546 740D       214            mov a, #'\r'
0548 120551     215            lcall putchar
054B 740A       216            mov a, #'\n'
054D 120551     217            lcall putchar
0550            218            
0550 22         219            ret
0551            220   
0551            221   
0551            222   
0551            223   ; Function to stransmit accumulator value into the serial buffer register after previous completion
0551            224   putchar:
0551 3099FD     225       jnb TI, putchar ; TI is the transmit interrupt, it will loop until it is high and we know the previous bit is sent
0554            226       
0554 C299       227       clr TI  ; Reset back to 0 to indicate we are transmitting 
0556 F599       228       mov SBUF, a ; accumulator will have output chharacter already stored on it
0558 22         229       ret
0559            230   
0559            231   
0559            232   ; ******************************* TIMER ISRS ************************************
0559            233   
0559            234   Timer0_Init:
0559 E589       235            mov a, TMOD
055B 54F0       236            anl a, #0xf0 ; Clear the bits for timer 0
055D 4401       237            orl a, #0x01 ; Configure timer 0 as 16-timer
055F F589       238            mov TMOD, a
0561 758CFD     239            mov TH0, #high(TIMER0_RELOAD)
0564 758A5A     240            mov TL0, #low(TIMER0_RELOAD)
0567            241            ; Enable the timer and interrupts
0567 D2A9       242       setb ET0  ; Enable timer 0 interrupt
0569 D28C       243       setb TR0  ; Start timer 0
056B 22         244            ret
056C            245   
056C            246   ;---------------------------------;
056C            247   ; ISR for timer 0.  Set to execute;
056C            248   ; every 1/4096Hz to generate a    ;
056C            249   ; 2048 Hz square wave at pin P1.5 ;
056C            250   ;---------------------------------;
056C            251   Timer0_ISR:
056C            252            ;clr TF0  ; According to the data sheet this is done for us already.
056C 758CFD     253            mov TH0, #high(TIMER0_RELOAD) ; Timer 0 doesn't have autoreload in the CV-8052
056F 758A5A     254            mov TL0, #low(TIMER0_RELOAD)
0572 B295       255            cpl SOUND_OUT ; Connect speaker to P1.5
0574 32         256            reti
0575            257   
0575            258   ;---------------------------------;
0575            259   ; Routine to initialize the ISR   ;
0575            260   ; for timer 2                     ;
0575            261   ;---------------------------------;
0575            262   Timer2_Init:
0575 75C800     263            mov T2CON, #0 ; Stop timer/counter.  Autoreload mode.
0578 75CDF5     264            mov TH2, #high(TIMER2_RELOAD)
057B 75CC27     265            mov TL2, #low(TIMER2_RELOAD)
057E            266            ; Set the reload value
057E 75CBF5     267            mov RCAP2H, #high(TIMER2_RELOAD)
0581 75CA27     268            mov RCAP2L, #low(TIMER2_RELOAD)
0584            269            ; Init One millisecond interrupt counter.  It is a 16-bit variable made with two 8-bit parts
0584 E4         270            clr a
0585 F566       271            mov Count1ms+0, a
0587 F567       272            mov Count1ms+1, a
0589            273            ; Enable the timer and interrupts
0589 D2AD       274       setb ET2  ; Enable timer 2 interrupt
058B D2CA       275       setb TR2  ; Enable timer 2
058D 22         276            ret
058E            277   
058E            278   ;---------------------------------;
058E            279   ; ISR for timer 2                 ;
058E            280   ;---------------------------------;
058E            281   Timer2_ISR:
058E C2CF       282            clr TF2  ; Timer 2 doesn't clear TF2 automatically. Do it in ISR
0590            283            
0590            284            ; The two registers used in the ISR must be saved in the stack
0590 C0E0       285            push acc
0592 C0D0       286            push psw
0594            287            
0594            288            ; Increment the 16-bit one mili second counter
0594 0566       289            inc Count1ms+0    ; Increment the low 8-bits first
0596 E566       290            mov a, Count1ms+0 ; If the low 8-bits overflow, then increment high 8-bits
0598 7002       291            jnz Inc_Done
059A 0567       292            inc Count1ms+1 ;increment high 8-bits if low 8-bits overflowed
059C            293   
059C            294   Inc_Done:
059C            295            ; Check if full second has passed
059C E566       296            mov a, Count1ms+0
059E B4E86D     297            cjne a, #low(1000), Timer2_ISR_Midpoint ; Warning: this instruction changes the carry flag!
05A1 E567       298            mov a, Count1ms+1
05A3 B40368     299            cjne a, #high(1000), Timer2_ISR_Midpoint
05A6            300       
05A6            301       
05A6 75A100     302            mov ADC_C, #00000000b
05A9            303            
05A9            304   
05A9 755C00     305       mov x+3, #0
05AC 755B00     306            mov x+2, #0
05AF 85A35A     307            mov x+1, ADC_H
05B2 85A259     308            mov x+0, ADC_L
05B5            309       ; Convert ADC reading to temperature in Celsius
05B5            310       ; Voltage = (ADC_value * 5000) / 4096
05B5 755D88     311            mov y+0, #low (5000 % 0x10000) 
05B8 755E13     311            mov y+1, #high(5000 % 0x10000) 
05BB 755F00     311            mov y+2, #low (5000 / 0x10000) 
05BE 756000     311            mov y+3, #high(5000 / 0x10000) 
05C1 120361     312            lcall mul32
05C4 755D00     313            mov y+0, #low (4096 % 0x10000) 
05C7 755E10     313            mov y+1, #high(4096 % 0x10000) 
05CA 755F00     313            mov y+2, #low (4096 / 0x10000) 
05CD 756000     313            mov y+3, #high(4096 / 0x10000) 
05D0 120455     314            lcall div32
05D3            315       ; Result is in 'x'
05D3            316   
05D3 755DE8     317            mov y+0, #low (1000 % 0x10000) 
05D6 755E03     317            mov y+1, #high(1000 % 0x10000) 
05D9 755F00     317            mov y+2, #low (1000 / 0x10000) 
05DC 756000     317            mov y+3, #high(1000 / 0x10000)  ; convert to microvolts
05DF 120361     318       lcall mul32
05E2 755D0C     319            mov y+0, #low (12300 % 0x10000) 
05E5 755E30     319            mov y+1, #high(12300 % 0x10000) 
05E8 755F00     319            mov y+2, #low (12300 / 0x10000) 
05EB 756000     319            mov y+3, #high(12300 / 0x10000)  ; 41 * 300
05EE 120455     320       lcall div32
05F1            321   
05F1 755D16     322            mov y+0, #low (22 % 0x10000) 
05F4 755E00     322            mov y+1, #high(22 % 0x10000) 
05F7 755F00     322            mov y+2, #low (22 / 0x10000) 
05FA 756000     322            mov y+3, #high(22 / 0x10000)  ; add cold junction temperature
05FD 1202A8     323       lcall add32
0600            324       ;do your displays and stuff
0600            325       ;result is still in x
0600 855935     326       mov TEMP+0, x+0
0603 855A36     327       mov TEMP+1, x+1
0606            328       
0606 120511     329       lcall Display_Voltage_Serial
0609 120686     330       lcall Display_BCD_7_seg
060C            331   
060C 8003       332       sjmp Timer2_ISR_Bypass
060E            333   
060E            334   Timer2_ISR_Midpoint:
060E 020651     335   ljmp Timer2_ISR_done
0611            336   Timer2_ISR_Bypass:
0611            337   
0611            338   ;---------------------------------------------------------------------;
0611            339            
0611            340            ;1 second have passed.  Set a flag so the main program knows
0611 D202       341            setb seconds_flag ; Let the main program know one second had passed
0613            342            ; Toggle LEDR0 so it blinks
0613 053A       343       inc TIME ; Increment the TIME Variable
0615 B2E8       344            cpl LEDRA.0
0617 E4         345            clr a
0618 F566       346            mov Count1ms+0, a
061A F567       347            mov Count1ms+1, a
061C            348       
061C            349       ;Call PWM funcions
061C            350   Checkforstate1:
061C E530       351       MOV A, STATE_VAR_1
061E B40105     352       CJNE A, #1, NOT_STATE_1
0621 1206FB     353       LCALL pwm_for_ramp
0624 8016       354       SJMP PWM_EXIT
0626            355   NOT_STATE_1:
0626 B40305     356       CJNE A, #3, NOT_STATE_3
0629 120717     357       LCALL pwm_for_ramp2
062C 800E       358       SJMP PWM_EXIT
062E            359   NOT_STATE_3:
062E B40205     360       CJNE A, #2, NOT_STATE_2
0631 1206CF     361       LCALL pwm_for_flatstates
0634 8006       362       SJMP PWM_EXIT
0636            363   NOT_STATE_2:
0636 B40403     364       CJNE A, #4, PWM_EXIT     ; If not 4, do nothing and exit
0639 1206CF     365       LCALL pwm_for_flatstates
063C            366   PWM_EXIT:
063C            367   
063C            368   
063C            369       
063C            370            ; Increment the BCD counter
063C E568       371            mov a, BCD_counter
063E 20E80B     372            jb UPDOWN, Timer2_ISR_decrement
0641 2401       373            add a, #0x01; Increment the BCD counter
0643 E568       374            mov a, BCD_counter
0645 20E804     375            jb UPDOWN, Timer2_ISR_decrement
0648 2401       376            add a, #0x01
064A 8002       377            sjmp Timer2_ISR_da
064C            378   Timer2_ISR_decrement:
064C 2499       379            add a, #0x99 ; Adding the 10-complement of -1 is like subtracting 1.
064E            380   Timer2_ISR_da:
064E D4         381            da a ; Decimal adjust instruction.  Check datasheet for more details!
064F F568       382            mov BCD_counter, a
0651            383   
0651            384            
0651            385   Timer2_ISR_done:
0651 D0D0       386            pop psw
0653 D0E0       387            pop acc
0655 32         388            reti
0656            389   
0656            390   INITIALIZE:
0656            391   
0656 759AAB     392            mov P0MOD, #10101011b ; P0.0(OVEN_PIN), P0.1, P0.3, P0.5, P0.7(LCD) are outputs. 
0659 759BF6     393       mov P1MOD, #11110110b ; P1.7, P1.5, P1.1(LCD), 1.2, 1.4, 1.6(ROW) are outputs
065C 759C01     394       mov P2MOD, #00000001b ; 2.0(ROW), 2.2, 2.4, 2.6(COL)
065F 759D01     395       mov P3MOD, #00000001b ; 3.0 (COL)
0662            396       ; for keypad, (ROWS as output-1)1.2, 1.4, 1.6, 2.0 - (COLS as input-0) 2.2, 2.4, 2.6, 3.0
0662 75A100     397       mov ADC_C, #0x00      ; Select ADC Channel 0
0665 75A180     398       mov ADC_C, #10000000b ; ADC Enable = 1 test******
0668 22         399       ret                   ; Added RET so it doesn't crash after initializing
0669            400   
0669            401   ; ************************** FUNCTIONS ***********************************
0669            402   
0669            403   Wait50ms:
0669            404   ;33.33MHz, 1 clk per cycle: 0.03us
0669 781E       405            mov R0, #30
066B            406   Wait50ms_L3:
066B 794A       407            mov R1, #74
066D            408   Wait50ms_L2:
066D 7AFA       409            mov R2, #250
066F            410   Wait50ms_L1:
066F DAFE       411            djnz R2, Wait50ms_L1 ;3*250*0.03us=22.5us
0671 D9FA       412       djnz R1, Wait50ms_L2 ;74*22.5us=1.665ms
0673 D8F6       413       djnz R0, Wait50ms_L3 ;1.665ms*30=50ms
0675 22         414       ret
0676            415   
0676            416   
0676            417   ; **************************** KEYPAD *******************************
0676            418   
0676            419   
0676            420   
0676            421   
0676            422   ; Look-up table for the 7-seg displays. (Segments are turn on with zero) 
0676            423   T_7seg:
0676 C0F9A4B0   424       DB 0xC0, 0xF9, 0xA4, 0xB0, 0x99        ; 0 TO 4
     99
067B 9282F880   425       DB 0x92, 0x82, 0xF8, 0x80, 0x90        ; 4 TO 9
     90
0680 8883C6A1   426       DB 0x88, 0x83, 0xC6, 0xA1, 0x86, 0x8E  ; A to F
     868E
0686            427   
0686            428   ; Displays a BCD number in HEX1-HEX0
0686            429   Display_BCD_7_Seg:
0686            430   
0686 C0E0       431       push acc
0688 C0D0       432       push psw
068A            433            
068A 853559     434            mov x+0, TEMP+0
068D 85365A     435            mov x+1, TEMP+1
0690 120203     436            lcall hex2bcd
0693            437            
0693 900676     438            mov dptr, #T_7seg
0696            439   
0696 E562       440       mov a, bcd+1
0698 540F       441       anl a, #0FH
069A 93         442       movc a, @a+dptr
069B F593       443       mov HEX2, a
069D            444   
069D E561       445            mov a, bcd
069F C4         446            swap a
06A0 540F       447            anl a, #0FH
06A2 93         448            movc a, @a+dptr
06A3 F592       449            mov HEX1, a
06A5            450            
06A5 E561       451            mov a, bcd
06A7 540F       452            anl a, #0FH
06A9 93         453            movc a, @a+dptr
06AA F591       454            mov HEX0, a
06AC            455   
06AC D0D0       456       pop psw
06AE D0E0       457       pop acc
06B0            458            
06B0 22         459            ret
06B1            460   
06B1            461   
06B1            462   Check_Select_Button_Press:
06B1            463   
06B1 20F90B     464       jb SELECT_BUTTON, Not_Pressed
06B4 120669     465       lcall Wait50ms
06B7 20F905     466       jb SELECT_BUTTON, Not_Pressed
06BA            467   
06BA D203       468       setb SELECT_BUTTON_FLAG
06BC            469   
06BC 30F9FD     470       jnb SELECT_BUTTON, $
06BF            471   
06BF            472       Not_Pressed:
06BF 22         473           ret
06C0            474   
06C0            475   
06C0            476   Check_Param_Button_Press:
06C0            477   
06C0 20FA0B     478       jb PARAM_BUTTON, Not_Pressed_2
06C3 120669     479       lcall Wait50ms
06C6 20FA05     480       jb PARAM_BUTTON, Not_Pressed_2
06C9            481   
06C9 D204       482       setb PARAM_BUTTON_FLAG
06CB            483   
06CB 30FAFD     484       jnb PARAM_BUTTON, $
06CE            485   
06CE            486       Not_Pressed_2:
06CE 22         487           ret
06CF            488   
06CF            489   
06CF            490       
06CF            491       ;---------------READ KEYPAD-------------------;
06CF            492       ;A Macro essentially works like CHECK_COL(COL#, Literal value coloumn represents)
06CF            493       ;If the column is pressed, R7 will contain the column number (1-4)
06CF            494       
06CF            495   
06CF            496   ;**************************PWM**************************;
06CF            497   pwm_for_flatstates:
06CF            498   ; ---- LOW_LIM = max(0, T_TGT - T_BAND)
06CF E544       499           MOV     A, TARGET          
06D1 C3         500           CLR     C                 ;clear carry
06D2 9402       501           SUBB    A, #BAND         ; A = A - BAND
06D4 5002       502           JNC     flat_low_ok       
06D6 7400       503           MOV     A, #00h           
06D8            504   flat_low_ok:
06D8 F553       505           MOV     LOW_LIMIT, A        ; Store low limit in RAM
06DA            506   
06DA            507           ;compute high limit
06DA E544       508           MOV     A, TARGET          
06DC 2402       509           ADD     A, #BAND         
06DE 5002       510           JNC     flat_high_ok      
06E0 74FF       511           MOV     A, #0FFh          
06E2            512   flat_high_ok:
06E2 F555       513           MOV     HIGH_LIMIT, A       
06E4            514   
06E4            515           ;turn oven on if curren temp is less than low limit
06E4 E535       516           MOV     A, TEMP          ;make sure this variables is right!!!!!!!
06E6 C3         517           CLR     C               
06E7 9553       518           SUBB    A, LOW_LIMIT       
06E9            519                                    
06E9 400A       520           JC      flat_on       ;temp is less than low limit so turn power on since there is carry
06EB            521   
06EB            522           ;if current temp is greater than high lim turn off
06EB E535       523           MOV     A, TEMP
06ED C3         524           CLR     C                 
06EE 9555       525           SUBB    A, HIGH_LIMIT       
06F0            526                                    
06F0 6002       527           JZ      flat_done         ; If equal to HIGH_LIMit do nothing
06F2 5004       528           JNC     flat_off      ; If no borrow and not zero T_CUR > HIGH_LIM so turn off
06F4            529   
06F4            530   flat_done:
06F4 22         531           RET                       ; Inside band do nothing, holds prev values
06F5            532   flat_on:
06F5 D280       533           SETB p0.0      ;turn power on
06F7 22         534           RET
06F8            535   
06F8            536   flat_off:
06F8 C280       537           CLR p0.0      ;power off
06FA 22         538           RET
06FB            539   
06FB            540   
06FB            541   
06FB            542   
06FB            543   pwm_for_ramp:
06FB E544       544                    MOV     A, TARGET          
06FD C3         545           CLR     C                 
06FE 9414       546           SUBB    A, #LEAD         
0700            547                                    
0700 5002       548           JNC     ramp_thresh_ok    
0702 7400       549           MOV     A, #00h           
0704            550   ramp_thresh_ok:
0704 F557       551           MOV     THRESHOLD, A         
0706            552   
0706            553           ;if less than threshold turn power on 
0706 E535       554           MOV     A, TEMP          
0708 C3         555           CLR     C                 
0709 9557       556           SUBB    A, THRESHOLD         ; A = curren temp - threshold(target-lead)
070B            557                                    
070B 4004       558           JC      ramp_force_on     ; If below threshold force on and return
070D            559   
070D 020714     560           ljmp     ramp_set_off     
0710            561   
0710            562   
0710            563   ramp_done:
0710 22         564           RET                      
0711            565   
0711            566   ramp_force_on:
0711 D280       567           SETB p0.0      ;power on
0713 22         568           RET
0714            569   
0714            570   ramp_set_off:
0714 C280       571           CLR p0.0
0716 22         572           RET 
0717            573           
0717            574   
0717            575   pwm_for_ramp2:
0717 E544       576                    MOV     A, TARGET          
0719 C3         577           CLR     C                 
071A 9400       578           SUBB    A, #LEAD2         
071C            579                                    
071C 5002       580           JNC     ramp_thresh_ok2    
071E 7400       581           MOV     A, #00h           
0720            582   ramp_thresh_ok2:
0720 F557       583           MOV     THRESHOLD, A         
0722            584   
0722            585           ;if less than threshold turn power on 
0722 E535       586           MOV     A, TEMP          
0724 C3         587           CLR     C                 
0725 9557       588           SUBB    A, THRESHOLD         ; A = curren temp - threshold(target-lead)
0727            589                                    
0727 4004       590           JC      ramp_force_on2     ; If below threshold force on and return
0729            591   
0729 020730     592           ljmp     ramp_set_off2     
072C            593   
072C            594   
072C            595   ramp_done2:
072C 22         596           RET                      
072D            597   
072D            598   ramp_force_on2:
072D D280       599           SETB p0.0      ;power on
072F 22         600           RET
0730            601   
0730            602   ramp_set_off2:
0730 C280       603           CLR p0.0
0732 22         604           RET 
0733            605   
0733            606   ;==============SPEAKER FUNCTIONS==============;
0733            607   
0733            608   BeepSpeaker:
0733 D28C       609       setb TR0
0735 7B07       610       mov R3, #7
0737            611   WaitLoop:
0737 120669     612       lcall Wait50ms
073A DBFB       613       djnz R3, WaitLoop 
073C            614   UnbeepSpeaker:
073C C28C       615       clr TR0
073E 22         616       ret
073F            617   
073F            618   ;--- MAIN PROGRAM START ---
073F            619   
073F            620   ; **************************************** Initializations ***********************************************
073F            621   
073F            622   MAIN:
073F 75817F     623       mov SP, #0x7F         ; Initialize Stack Pointer (Good practice)
0742 120656     624       lcall INITIALIZE      ; intialize pins and adc, for now
0745            625   
0745 120559     626       lcall Timer0_Init
0748 120575     627       lcall Timer2_Init
074B D2AF       628       setB EA ; Enable global interrupts
074D 1201A8     629       lcall ELCD_4BIT ; Intialize LCD
0750 1204F5     630       lcall InitSerialPort
0753            631       
0753 C202       632       clr seconds_flag
0755 C200       633       clr START_FLAG
0757 C280       634       clr p0.0 ; Make sure oven is off to start
0759            635   
0759 754696     636       mov soak_temp_set, #150
075C 75483C     637       mov soak_time_set, #60
075F 754ADC     638       mov reflow_temp_set, #220
0762 754C1E     639       mov reflow_time_set, #30
0765            640   
0765 753000     641       mov STATE_VAR_1, #0x0000
0768 753100     642       mov STATE_VAR_2, #0x0000
076B 753A00     643       mov TIME, #0
076E 753500     644       mov TEMP, #0000
0771 753C00     645       mov POWER, #0
0774 753E3C     646       mov DEGREES60, #60
0777 754096     647       mov DEGREES150, #150
077A 7542DC     648       mov DEGREES220, #220
077D 754400     649       mov TARGET,       #0
0780            650   
0780 756100     651       mov bcd, #0x0000
0783            652   
0783            653   MAIN_LOOP:
0783            654   
0783            655   PARAM_FSM:
0783            656   
0783            657   
0783            658   ; **************************** FSM for selecting parameters *************************
0783            659   ; 4 main states ->  A: select soak temp
0783            660   ;                   B: select soak time
0783            661   ;                   C: select reflow temp
0783            662   ;                   D: select reflow time
0783            663   ;
0783            664   ; move to other FSM when start button turns on start flag
0783            665   
0783            666   
0783            667   
0783            668   StateAInit:
0783 C0E0       669            push acc
0785 7401       669            mov a, #1
0787 14         669            dec a
0788 1201E8     669            lcall ?Set_Cursor_1 ; Select column and row
078B D0E0       669            pop acc
078D C083       670            push dph
078F C082       670            push dpl
0791 C0E0       670            push acc
0793 90003F     670            mov dptr, #param_message
0796 1201DB     670            lcall ?Send_Constant_String
0799 D0E0       670            pop acc
079B D082       670            pop dpl
079D D083       670            pop dph
079F C0E0       671            push acc
07A1 7401       671            mov a, #1
07A3 14         671            dec a
07A4 1201E6     671            lcall ?Set_Cursor_2 ; Select column and row
07A7 D0E0       671            pop acc
07A9 C083       672            push dph
07AB C082       672            push dpl
07AD C0E0       672            push acc
07AF 900050     672            mov dptr, #soak_temp_message
07B2 1201DB     672            lcall ?Send_Constant_String
07B5 D0E0       672            pop acc
07B7 D082       672            pop dpl
07B9 D083       672            pop dph
07BB            673   StateA:
07BB E531       674       mov a, STATE_VAR_2
07BD            675   
07BD B40065     676       cjne a, #0, StateBInit
07C0 1206B1     677       lcall Check_Select_Button_Press
07C3 200356     678       jb SELECT_BUTTON_FLAG, StateADone
07C6            679   
07C6 854659     680       mov x+0, soak_temp_set+0
07C9 85475A     681       mov x+1, soak_temp_set+1
07CC 755B00     682       mov x+2, #0
07CF 755C00     683       mov x+3, #0
07D2 120203     684       lcall hex2bcd
07D5            685   
07D5 C0E0       686            push acc
07D7 740C       686            mov a, #12
07D9 14         686            dec a
07DA 1201E6     686            lcall ?Set_Cursor_2 ; Select column and row
07DD D0E0       686            pop acc
07DF C000       687            push ar0
07E1 A862       687            mov r0, bcd+1
07E3 1201ED     687            lcall ?Display_BCD
07E6 D000       687            pop ar0
07E8 C000       688            push ar0
07EA A861       688            mov r0, bcd+0
07EC 1201ED     688            lcall ?Display_BCD
07EF D000       688            pop ar0
07F1            689   
07F1 1206C0     690       lcall Check_Param_Button_Press
07F4 200402     691       jb PARAM_BUTTON_FLAG, Inc_Soak_Temp
07F7            692       
07F7            693   StateA_Keypad:
07F7            694   
07F7            695       ;lcall Keypad
07F7            696       ;jnc StateA
07F7            697   
07F7            698       ;lcall Shift_Digits_Left
07F7            699   
07F7            700       ;mov soak_temp_set+0, bcd+0
07F7            701       ;mov soak_temp_set+1, bcd+1
07F7            702   
07F7 80C2       703       sjmp StateA
07F9            704   
07F9            705       Inc_Soak_Temp:
07F9            706           
07F9 C204       707           clr PARAM_BUTTON_FLAG
07FB            708   
07FB E546       709           mov a, soak_temp_set
07FD            710   
07FD 20E80B     711           jb UPDOWN, Dec_Soak_Temp
0800 20E904     712           jb TENS, Inc_Soak_Temp_Tens
0803            713   
0803 2401       714           add a, #1
0805 8011       715           sjmp Soak_Temp_Tens_Done
0807            716   
0807            717       Inc_Soak_Temp_Tens:
0807 240A       718           add a, #10
0809 800D       719           sjmp Soak_Temp_Tens_Done
080B            720   
080B            721       Dec_Soak_Temp:
080B 20E905     722           jb TENS, Dec_Soak_Temp_Tens
080E            723           
080E C3         724           clr c
080F 9401       725           subb a, #1
0811 8005       726           sjmp Soak_Temp_Tens_Done
0813            727   
0813            728       Dec_Soak_Temp_Tens:
0813 C3         729           clr c  
0814 940A       730           subb a, #10
0816 8000       731           sjmp Soak_Temp_Tens_Done
0818            732   
0818            733       Soak_Temp_Tens_Done:
0818 F546       734           mov soak_temp_set, a
081A 809F       735           sjmp StateA
081C            736       
081C            737   StateADone:
081C 120733     738       lcall BeepSpeaker
081F 0531       739       inc STATE_VAR_2
0821 C203       740       clr SELECT_BUTTON_FLAG
0823 8096       741       sjmp StateA
0825            742   
0825            743   
0825            744   
0825            745   StateBInit:
0825 C0E0       746            push acc
0827 7401       746            mov a, #1
0829 14         746            dec a
082A 1201E6     746            lcall ?Set_Cursor_2 ; Select column and row
082D D0E0       746            pop acc
082F C083       747            push dph
0831 C082       747            push dpl
0833 C0E0       747            push acc
0835 900061     747            mov dptr, #soak_time_message
0838 1201DB     747            lcall ?Send_Constant_String
083B D0E0       747            pop acc
083D D082       747            pop dpl
083F D083       747            pop dph
0841            748   StateB:
0841 E531       749       mov a, STATE_VAR_2
0843            750   
0843 B40156     751       cjne a, #1, StateCInit
0846 1206B1     752       lcall Check_Select_Button_Press
0849 200347     753       jb SELECT_BUTTON_FLAG, StateBDone
084C            754   
084C 854859     755       mov x+0, soak_time_set+0
084F 755A00     756       mov x+1, #0
0852 755B00     757       mov x+2, #0
0855 755C00     758       mov x+3, #0
0858 120203     759       lcall hex2bcd
085B            760   
085B C0E0       761            push acc
085D 740C       761            mov a, #12
085F 14         761            dec a
0860 1201E6     761            lcall ?Set_Cursor_2 ; Select column and row
0863 D0E0       761            pop acc
0865 C000       762            push ar0
0867 A861       762            mov r0, bcd+0
0869 1201ED     762            lcall ?Display_BCD
086C D000       762            pop ar0
086E            763       
086E            764   StateB_Keypad:
086E            765   
086E            766       ;lcall Keypad
086E            767       ;jnc StateB
086E            768   
086E            769       ;lcall Shift_Digits_Left
086E            770   
086E            771       ;mov soak_time_set+0, bcd+0
086E            772       ;mov soak_time_set+1, bcd+1
086E            773       
086E 80D1       774       sjmp StateB
0870            775   
0870            776       Inc_Soak_Time:
0870            777           
0870 C204       778           clr PARAM_BUTTON_FLAG
0872            779   
0872 E548       780           mov a, soak_time_set
0874            781   
0874 20E80B     782           jb UPDOWN, Dec_Soak_Time
0877 20E904     783           jb TENS, Inc_Soak_Time_Tens
087A            784   
087A 2401       785           add a, #1
087C 8011       786           sjmp Soak_Time_Tens_Done
087E            787   
087E            788       Inc_Soak_Time_Tens:
087E 240A       789           add a, #10
0880 800D       790           sjmp Soak_Time_Tens_Done
0882            791   
0882            792       Dec_Soak_Time:
0882 20E905     793           jb TENS, Dec_Soak_Time_Tens
0885            794           
0885 C3         795           clr c
0886 9401       796           subb a, #1
0888 8005       797           sjmp Soak_Time_Tens_Done
088A            798   
088A            799       Dec_Soak_Time_Tens:
088A C3         800           clr c
088B 940A       801           subb a, #10
088D 8000       802           sjmp Soak_Time_Tens_Done
088F            803   
088F            804       Soak_Time_Tens_Done:
088F F548       805           mov soak_time_set, a
0891 80AE       806           sjmp StateB
0893            807       
0893            808   StateBDone:
0893 120733     809       lcall BeepSpeaker
0896 0531       810       inc STATE_VAR_2
0898 C203       811       clr SELECT_BUTTON_FLAG
089A 80A5       812       sjmp StateB
089C            813   
089C            814   StateCInit:
089C C0E0       815            push acc
089E 7401       815            mov a, #1
08A0 14         815            dec a
08A1 1201E6     815            lcall ?Set_Cursor_2 ; Select column and row
08A4 D0E0       815            pop acc
08A6 C083       816            push dph
08A8 C082       816            push dpl
08AA C0E0       816            push acc
08AC 900072     816            mov dptr, #reflow_temp_message
08AF 1201DB     816            lcall ?Send_Constant_String
08B2 D0E0       816            pop acc
08B4 D082       816            pop dpl
08B6 D083       816            pop dph
08B8            817   StateC:
08B8 E531       818       mov a, STATE_VAR_2
08BA            819   
08BA B4025F     820       cjne a, #2, StateDInit
08BD 1206B1     821       lcall Check_Select_Button_Press
08C0 200350     822       jb SELECT_BUTTON_FLAG, StateCDone
08C3            823   
08C3 854A59     824       mov x+0, reflow_temp_set+0
08C6 854B5A     825       mov x+1, reflow_temp_set+1
08C9 755B00     826       mov x+2, #0
08CC 755C00     827       mov x+3, #0
08CF 120203     828       lcall hex2bcd
08D2            829   
08D2 C0E0       830            push acc
08D4 740C       830            mov a, #12
08D6 14         830            dec a
08D7 1201E6     830            lcall ?Set_Cursor_2 ; Select column and row
08DA D0E0       830            pop acc
08DC C000       831            push ar0
08DE A862       831            mov r0, bcd+1
08E0 1201ED     831            lcall ?Display_BCD
08E3 D000       831            pop ar0
08E5 C000       832            push ar0
08E7 A861       832            mov r0, bcd+0
08E9 1201ED     832            lcall ?Display_BCD
08EC D000       832            pop ar0
08EE            833   
08EE            834   StateC_Keypad:
08EE            835   
08EE            836       ;lcall Keypad
08EE            837       ;jnc StateC
08EE            838   
08EE            839       ;lcall Shift_Digits_Left
08EE            840   
08EE            841       ;mov reflow_temp_set+0, bcd+0
08EE            842       ;mov reflow_temp_set+1, bcd+1
08EE            843   
08EE 80C8       844       sjmp StateC
08F0            845   
08F0            846       Inc_Reflow_Temp:
08F0            847           
08F0 C204       848           clr PARAM_BUTTON_FLAG
08F2            849   
08F2 E54A       850           mov a, reflow_temp_set
08F4            851   
08F4 20E80B     852           jb UPDOWN, Dec_Reflow_Temp
08F7 20E904     853           jb TENS, Inc_Reflow_Temp_Tens
08FA            854   
08FA 2401       855           add a, #1
08FC 8011       856           sjmp Reflow_Temp_Tens_Done
08FE            857   
08FE            858       Inc_Reflow_Temp_Tens:
08FE 240A       859           add a, #10
0900 800D       860           sjmp Reflow_Temp_Tens_Done
0902            861   
0902            862       Dec_Reflow_Temp:
0902 20E905     863           jb TENS, Dec_Reflow_Temp_Tens
0905            864           
0905 C3         865           clr c
0906 9401       866           subb a, #1
0908 8005       867           sjmp Reflow_Temp_Tens_Done
090A            868   
090A            869       Dec_Reflow_Temp_Tens:
090A C3         870           clr c
090B 940A       871           subb a, #10
090D 8000       872           sjmp Reflow_Temp_Tens_Done
090F            873   
090F            874       Reflow_Temp_Tens_Done:
090F F54A       875           mov reflow_temp_set, a
0911 80A5       876           sjmp StateC
0913            877       
0913            878   StateCDone:
0913 120733     879       lcall BeepSpeaker
0916 0531       880       inc STATE_VAR_2
0918 C203       881       clr SELECT_BUTTON_FLAG
091A 809C       882       sjmp StateC
091C            883   
091C            884   StateDInit:
091C C0E0       885            push acc
091E 7401       885            mov a, #1
0920 14         885            dec a
0921 1201E6     885            lcall ?Set_Cursor_2 ; Select column and row
0924 D0E0       885            pop acc
0926 C083       886            push dph
0928 C082       886            push dpl
092A C0E0       886            push acc
092C 900083     886            mov dptr, #reflow_time_message
092F 1201DB     886            lcall ?Send_Constant_String
0932 D0E0       886            pop acc
0934 D082       886            pop dpl
0936 D083       886            pop dph
0938            887   StateD:
0938 E531       888       mov a, STATE_VAR_2
093A            889   
093A B40356     890       cjne a, #3, ReadyStateInit
093D 1206B1     891       lcall Check_Select_Button_Press
0940 200347     892       jb SELECT_BUTTON_FLAG, StateDDone
0943            893   
0943 854C59     894       mov x+0, reflow_time_set+0
0946 755A00     895       mov x+1, #0
0949 755B00     896       mov x+2, #0
094C 755C00     897       mov x+3, #0
094F 120203     898       lcall hex2bcd
0952            899   
0952 C0E0       900            push acc
0954 740C       900            mov a, #12
0956 14         900            dec a
0957 1201E6     900            lcall ?Set_Cursor_2 ; Select column and row
095A D0E0       900            pop acc
095C C000       901            push ar0
095E A861       901            mov r0, bcd+0
0960 1201ED     901            lcall ?Display_BCD
0963 D000       901            pop ar0
0965            902   
0965            903   StateD_Keypad:
0965            904   
0965            905       ;lcall Keypad 
0965            906       ;jnc StateD
0965            907   
0965            908       ;lcall Shift_Digits_Left
0965            909   
0965            910       ;mov reflow_time_set+0, bcd+0
0965            911       ;mov reflow_time_set+1, bcd+1
0965            912   
0965 80D1       913       sjmp StateD
0967            914   
0967            915       Inc_Reflow_Time:
0967            916           
0967 C204       917           clr PARAM_BUTTON_FLAG
0969            918   
0969 E54C       919           mov a, reflow_time_set
096B            920   
096B 20E80B     921           jb UPDOWN, Dec_Reflow_Time
096E 20E904     922           jb TENS, Inc_Reflow_Time_Tens
0971            923   
0971 2401       924           add a, #1
0973 8011       925           sjmp Reflow_Time_Tens_Done
0975            926   
0975            927       Inc_Reflow_Time_Tens:
0975 240A       928           add a, #10
0977 800D       929           sjmp Reflow_Time_Tens_Done
0979            930   
0979            931       Dec_Reflow_Time:
0979 20E905     932           jb TENS, Dec_Reflow_Time_Tens
097C            933           
097C C3         934           clr c
097D 9401       935           subb a, #1
097F 8005       936           sjmp Reflow_Time_Tens_Done
0981            937   
0981            938       Dec_Reflow_Time_Tens:
0981 C3         939           clr c
0982 940A       940           subb a, #10
0984 8000       941           sjmp Reflow_Time_Tens_Done
0986            942   
0986            943       Reflow_Time_Tens_Done:
0986 F54C       944           mov reflow_time_set, a
0988 80AE       945           sjmp StateD
098A            946   
098A            947   StateDDone:
098A 120733     948       lcall BeepSpeaker
098D 0531       949       inc STATE_VAR_2
098F C203       950       clr SELECT_BUTTON_FLAG
0991 80A5       951       sjmp StateD
0993            952   
0993            953   ReadyStateInit:
0993 C0E0       954            push acc
0995 7401       954            mov a, #1
0997 14         954            dec a
0998 1201E8     954            lcall ?Set_Cursor_1 ; Select column and row
099B D0E0       954            pop acc
099D C083       955            push dph
099F C082       955            push dpl
09A1 C0E0       955            push acc
09A3 900094     955            mov dptr, #ready_message
09A6 1201DB     955            lcall ?Send_Constant_String
09A9 D0E0       955            pop acc
09AB D082       955            pop dpl
09AD D083       955            pop dph
09AF C0E0       956            push acc
09B1 7401       956            mov a, #1
09B3 14         956            dec a
09B4 1201E6     956            lcall ?Set_Cursor_2 ; Select column and row
09B7 D0E0       956            pop acc
09B9 C083       957            push dph
09BB C082       957            push dpl
09BD C0E0       957            push acc
09BF 90002E     957            mov dptr, #blank_row
09C2 1201DB     957            lcall ?Send_Constant_String
09C5 D0E0       957            pop acc
09C7 D082       957            pop dpl
09C9 D083       957            pop dph
09CB            958       
09CB            959   ReadyState:
09CB            960       ;jnb seconds_flag, skipSerial_0 *** not too sure what this does
09CB            961   
09CB            962   skipSerial_0:
09CB 20B5FD     963       jb START_BUTTON, ReadyState
09CE 120669     964       lcall wait50ms
09D1 20B5F7     965       jb START_BUTTON, ReadyState
09D4            966   
09D4 C0E0       967            push acc
09D6 7401       967            mov a, #1
09D8 14         967            dec a
09D9 1201E8     967            lcall ?Set_Cursor_1 ; Select column and row
09DC D0E0       967            pop acc
09DE C083       968            push dph
09E0 C082       968            push dpl
09E2 C0E0       968            push acc
09E4 9000A5     968            mov dptr, #state0_message
09E7 1201DB     968            lcall ?Send_Constant_String
09EA D0E0       968            pop acc
09EC D082       968            pop dpl
09EE D083       968            pop dph
09F0            969   
09F0 D200       970       setb START_FLAG
09F2 8000       971       sjmp State0
09F4            972   
09F4            973   
09F4            974   ;==================Reflow Profile FSM==================;
09F4            975   ;Checklist:
09F4            976   ; 1. Implement TEMP and TIME variables - DONE
09F4            977   ; 2. Implement FSM outputs - DONE
09F4            978   ; 3. Implement reset logic - DONE
09F4            979   ; 4. Implement abort condition - DONE
09F4            980   ; 5. Implement LCD Feedback for Each State - In Progress
09F4            981   ; 6. Speaker beeps for state transitions - In Progress
09F4            982   State0:
09F4 30B70C     983       jnb STOP_BUTTON, State0_StopReflow
09F7 C280       984       CLR p0.0 ;oven off
09F9 E530       985       mov a, STATE_VAR_1
09FB B4004D     986       cjne a, #0, State1
09FE 200005     987       jb START_FLAG, State0Done
0A01 80F1       988       sjmp State0
0A03            989   
0A03            990   State0_StopReflow:
0A03 020C86     991   ljmp StopReflow
0A06            992   
0A06            993   State0Done:
0A06 120733     994       lcall BeepSpeaker
0A09 C0E0       995            push acc
0A0B 7401       995            mov a, #1
0A0D 14         995            dec a
0A0E 1201E8     995            lcall ?Set_Cursor_1 ; Select column and row
0A11 D0E0       995            pop acc
0A13 C083       996            push dph
0A15 C082       996            push dpl
0A17 C0E0       996            push acc
0A19 9000B7     996            mov dptr, #state1_message
0A1C 1201DB     996            lcall ?Send_Constant_String
0A1F D0E0       996            pop acc
0A21 D082       996            pop dpl
0A23 D083       996            pop dph
0A25 C0E0       997            push acc
0A27 7401       997            mov a, #1
0A29 14         997            dec a
0A2A 1201E6     997            lcall ?Set_Cursor_2 ; Select column and row
0A2D D0E0       997            pop acc
0A2F C083       998            push dph
0A31 C082       998            push dpl
0A33 C0E0       998            push acc
0A35 900117     998            mov dptr, #reflow_message
0A38 1201DB     998            lcall ?Send_Constant_String
0A3B D0E0       998            pop acc
0A3D D082       998            pop dpl
0A3F D083       998            pop dph
0A41 0530       999       inc STATE_VAR_1
0A43 753C64    1000       mov POWER, #100
0A46 753A00    1001       mov TIME, #0
0A49 80A9      1002       sjmp State0
0A4B           1003   State1:
0A4B 30FB12    1004       jnb RESET_BUTTON, State1_ResetToMain
0A4E 30B712    1005       jnb STOP_BUTTON, State1_StopReflow
0A51 E530      1006       mov a, STATE_VAR_1
0A53 B4015B    1007       cjne a, #1, State2
0A56 854044    1008       mov TARGET, DEGREES150
0A59 E535      1009       mov a, TEMP
0A5B B49608    1010       cjne a, #150, CheckCarryState1
0A5E 80EB      1011       sjmp State1
0A60           1012   
0A60           1013   State1_ResetToMain:
0A60 020C7D    1014   ljmp ResetToMain
0A63           1015   
0A63           1016   State1_StopReflow:
0A63 020C86    1017   ljmp StopReflow
0A66           1018   
0A66           1019   CheckCarryState1:
0A66 4002      1020       jc LessThanState1
0A68 8002      1021       sjmp GreaterThanState1
0A6A           1022   LessThanState1:
0A6A 80DF      1023       sjmp State1
0A6C           1024   GreaterThanState1:
0A6C 120733    1025       lcall BeepSpeaker
0A6F C0E0      1026            push acc
0A71 7401      1026            mov a, #1
0A73 14        1026            dec a
0A74 1201E8    1026            lcall ?Set_Cursor_1 ; Select column and row
0A77 D0E0      1026            pop acc
0A79 C083      1027            push dph
0A7B C082      1027            push dpl
0A7D C0E0      1027            push acc
0A7F 9000C9    1027            mov dptr, #state2_message
0A82 1201DB    1027            lcall ?Send_Constant_String
0A85 D0E0      1027            pop acc
0A87 D082      1027            pop dpl
0A89 D083      1027            pop dph
0A8B C0E0      1028            push acc
0A8D 7401      1028            mov a, #1
0A8F 14        1028            dec a
0A90 1201E6    1028            lcall ?Set_Cursor_2 ; Select column and row
0A93 D0E0      1028            pop acc
0A95 C083      1029            push dph
0A97 C082      1029            push dpl
0A99 C0E0      1029            push acc
0A9B 900117    1029            mov dptr, #reflow_message
0A9E 1201DB    1029            lcall ?Send_Constant_String
0AA1 D0E0      1029            pop acc
0AA3 D082      1029            pop dpl
0AA5 D083      1029            pop dph
0AA7 0530      1030       inc STATE_VAR_1
0AA9 753C14    1031       mov POWER, #20
0AAC 753A00    1032       mov TIME, #0
0AAF 809A      1033       sjmp State1
0AB1           1034   State2:
0AB1 30FB12    1035       jnb RESET_BUTTON, State2_ResetToMain
0AB4 30B712    1036       jnb STOP_BUTTON, State2_StopReflow
0AB7 E530      1037       mov a, STATE_VAR_1
0AB9 B40207    1038       cjne a, #2, State2_State3
0ABC E53A      1039       mov a, TIME
0ABE B43C67    1040       cjne a, #60, CheckCarryState2 
0AC1 800C      1041       sjmp CheckAbortCondition ; Check if Temp. is at least 50 degrees after 60 seconds have passed
0AC3           1042   
0AC3           1043   State2_State3:
0AC3 020B71    1044       ljmp State3
0AC6           1045   
0AC6           1046   State2_ResetToMain:
0AC6 020C7D    1047   ljmp ResetToMain
0AC9           1048   
0AC9           1049   State2_StopReflow:
0AC9 020C86    1050   ljmp StopReflow
0ACC           1051   
0ACC           1052   State2_StopOven:
0ACC 020C89    1053   ljmp STOPOVEN
0ACF           1054   
0ACF           1055   CheckAbortCondition:
0ACF 7932      1056       mov R1, #50
0AD1 E535      1057       mov a, TEMP
0AD3 B4010B    1058       cjne a, #0x01, CheckAbortCarry
0AD6           1059       ; TEMP == 50, good enough to proceed
0AD6 0530      1060       inc STATE_VAR_1
0AD8 753C64    1061       mov POWER, #100       ; Set State3 power
0ADB 753A00    1062       mov TIME, #0          ; Reset timer for State3
0ADE 020B71    1063       ljmp State3
0AE1           1064   CheckAbortCarry:
0AE1 40E9      1065       jc State2_StopOven          
0AE3           1066       ; TEMP > 50, definitely good to proceed
0AE3 120733    1067       lcall BeepSpeaker
0AE6 C0E0      1068            push acc
0AE8 7401      1068            mov a, #1
0AEA 14        1068            dec a
0AEB 1201E8    1068            lcall ?Set_Cursor_1 ; Select column and row
0AEE D0E0      1068            pop acc
0AF0 C083      1069            push dph
0AF2 C082      1069            push dpl
0AF4 C0E0      1069            push acc
0AF6 9000DB    1069            mov dptr, #state3_message
0AF9 1201DB    1069            lcall ?Send_Constant_String
0AFC D0E0      1069            pop acc
0AFE D082      1069            pop dpl
0B00 D083      1069            pop dph
0B02 C0E0      1070            push acc
0B04 7401      1070            mov a, #1
0B06 14        1070            dec a
0B07 1201E6    1070            lcall ?Set_Cursor_2 ; Select column and row
0B0A D0E0      1070            pop acc
0B0C C083      1071            push dph
0B0E C082      1071            push dpl
0B10 C0E0      1071            push acc
0B12 900117    1071            mov dptr, #reflow_message
0B15 1201DB    1071            lcall ?Send_Constant_String
0B18 D0E0      1071            pop acc
0B1A D082      1071            pop dpl
0B1C D083      1071            pop dph
0B1E 0530      1072       inc STATE_VAR_1
0B20 753C64    1073       mov POWER, #100
0B23 753A00    1074       mov TIME, #0
0B26 8049      1075       sjmp State3
0B28           1076   CheckCarryState2:
0B28 4002      1077       jc LessThanState2
0B2A 8002      1078       sjmp GreaterThanState2
0B2C           1079   LessThanState2:
0B2C 8083      1080       sjmp State2
0B2E           1081   GreaterThanState2:
0B2E 120733    1082       lcall BeepSpeaker
0B31 C0E0      1083            push acc
0B33 7401      1083            mov a, #1
0B35 14        1083            dec a
0B36 1201E8    1083            lcall ?Set_Cursor_1 ; Select column and row
0B39 D0E0      1083            pop acc
0B3B C083      1084            push dph
0B3D C082      1084            push dpl
0B3F C0E0      1084            push acc
0B41 9000DB    1084            mov dptr, #state3_message
0B44 1201DB    1084            lcall ?Send_Constant_String
0B47 D0E0      1084            pop acc
0B49 D082      1084            pop dpl
0B4B D083      1084            pop dph
0B4D C0E0      1085            push acc
0B4F 7401      1085            mov a, #1
0B51 14        1085            dec a
0B52 1201E6    1085            lcall ?Set_Cursor_2 ; Select column and row
0B55 D0E0      1085            pop acc
0B57 C083      1086            push dph
0B59 C082      1086            push dpl
0B5B C0E0      1086            push acc
0B5D 900117    1086            mov dptr, #reflow_message
0B60 1201DB    1086            lcall ?Send_Constant_String
0B63 D0E0      1086            pop acc
0B65 D082      1086            pop dpl
0B67 D083      1086            pop dph
0B69 0530      1087       inc STATE_VAR_1
0B6B 753C64    1088       mov POWER, #100
0B6E 020AB1    1089       ljmp State2
0B71           1090   State3:
0B71 30FB12    1091       jnb RESET_BUTTON, State3_ResetToMain
0B74 30B712    1092       jnb STOP_BUTTON, State3_StopReflow
0B77 E530      1093       mov a, STATE_VAR_1
0B79 B4035B    1094       cjne a, #3, State4
0B7C 854244    1095       mov TARGET, DEGREES220
0B7F E535      1096       mov a, TEMP
0B81 B4DC08    1097       cjne a, #220, CheckCarryState3
0B84 80EB      1098       sjmp State3    
0B86           1099   
0B86           1100   State3_ResetToMain:
0B86 020C7D    1101   ljmp ResetToMain
0B89           1102   
0B89           1103   State3_StopReflow:
0B89 020C86    1104   ljmp StopReflow
0B8C           1105   
0B8C           1106   CheckCarryState3:
0B8C 4002      1107       jc LessThanState3
0B8E 8002      1108       sjmp GreaterThanState3
0B90           1109   LessThanState3:
0B90 80DF      1110       sjmp State3
0B92           1111   GreaterThanState3:
0B92 120733    1112       lcall BeepSpeaker
0B95 C0E0      1113            push acc
0B97 7401      1113            mov a, #1
0B99 14        1113            dec a
0B9A 1201E8    1113            lcall ?Set_Cursor_1 ; Select column and row
0B9D D0E0      1113            pop acc
0B9F C083      1114            push dph
0BA1 C082      1114            push dpl
0BA3 C0E0      1114            push acc
0BA5 9000ED    1114            mov dptr, #state4_message
0BA8 1201DB    1114            lcall ?Send_Constant_String
0BAB D0E0      1114            pop acc
0BAD D082      1114            pop dpl
0BAF D083      1114            pop dph
0BB1 C0E0      1115            push acc
0BB3 7401      1115            mov a, #1
0BB5 14        1115            dec a
0BB6 1201E6    1115            lcall ?Set_Cursor_2 ; Select column and row
0BB9 D0E0      1115            pop acc
0BBB C083      1116            push dph
0BBD C082      1116            push dpl
0BBF C0E0      1116            push acc
0BC1 900117    1116            mov dptr, #reflow_message
0BC4 1201DB    1116            lcall ?Send_Constant_String
0BC7 D0E0      1116            pop acc
0BC9 D082      1116            pop dpl
0BCB D083      1116            pop dph
0BCD 0530      1117       inc STATE_VAR_1
0BCF 753C14    1118       mov POWER, #20
0BD2 753A00    1119       mov TIME, #0
0BD5 809A      1120       sjmp State3
0BD7           1121   State4:
0BD7 30FB12    1122       jnb RESET_BUTTON, ResetToMainState4
0BDA 30B70C    1123       jnb STOP_BUTTON, StopReflowState4
0BDD E530      1124       mov a, STATE_VAR_1
0BDF B40455    1125       cjne a, #4, State5
0BE2 E53A      1126       mov a, TIME
0BE4 B42D08    1127       cjne a, #45, CheckCarryState4
0BE7 80EE      1128       sjmp State4
0BE9           1129   StopReflowState4:
0BE9 020C86    1130       ljmp StopReflow
0BEC           1131   ResetToMainState4:
0BEC 020C7D    1132       ljmp ResetToMain
0BEF           1133   CheckCarryState4:
0BEF 4002      1134       jc LessThanState4
0BF1 8002      1135       sjmp GreaterThanState4
0BF3           1136   LessThanState4:
0BF3 80E2      1137       sjmp State4 
0BF5           1138   GreaterThanState4:
0BF5 120733    1139       lcall BeepSpeaker
0BF8 C0E0      1140            push acc
0BFA 7401      1140            mov a, #1
0BFC 14        1140            dec a
0BFD 1201E8    1140            lcall ?Set_Cursor_1 ; Select column and row
0C00 D0E0      1140            pop acc
0C02 C083      1141            push dph
0C04 C082      1141            push dpl
0C06 C0E0      1141            push acc
0C08 9000FF    1141            mov dptr, #state5_message
0C0B 1201DB    1141            lcall ?Send_Constant_String
0C0E D0E0      1141            pop acc
0C10 D082      1141            pop dpl
0C12 D083      1141            pop dph
0C14 C0E0      1142            push acc
0C16 7401      1142            mov a, #1
0C18 14        1142            dec a
0C19 1201E6    1142            lcall ?Set_Cursor_2 ; Select column and row
0C1C D0E0      1142            pop acc
0C1E C083      1143            push dph
0C20 C082      1143            push dpl
0C22 C0E0      1143            push acc
0C24 900117    1143            mov dptr, #reflow_message
0C27 1201DB    1143            lcall ?Send_Constant_String
0C2A D0E0      1143            pop acc
0C2C D082      1143            pop dpl
0C2E D083      1143            pop dph
0C30 0530      1144       inc STATE_VAR_1
0C32 753C00    1145       mov POWER, #0
0C35 80A0      1146       sjmp State4
0C37           1147   State5:
0C37 30FB43    1148       jnb RESET_BUTTON, ResetToMain
0C3A 30B749    1149       jnb STOP_BUTTON, StopReflow
0C3D C280      1150       CLR p0.0 ;turn oven off
0C3F E530      1151       mov a, STATE_VAR_1    
0C41 B4050A    1152       cjne a, #5, State5toDone
0C44 853E44    1153       mov TARGET, DEGREES60
0C47 E535      1154       mov a, TEMP
0C49 B43C24    1155       cjne a, #60, CheckCarryState5
0C4C 80E9      1156       sjmp State5
0C4E           1157       
0C4E           1158   State5toDone:
0C4E 120733    1159       lcall BeepSpeaker
0C51 C0E0      1160            push acc
0C53 7401      1160            mov a, #1
0C55 14        1160            dec a
0C56 1201E8    1160            lcall ?Set_Cursor_1 ; Select column and row
0C59 D0E0      1160            pop acc
0C5B C083      1161            push dph
0C5D C082      1161            push dpl
0C5F C0E0      1161            push acc
0C61 900129    1161            mov dptr, #reflowdone_message
0C64 1201DB    1161            lcall ?Send_Constant_String
0C67 D0E0      1161            pop acc
0C69 D082      1161            pop dpl
0C6B D083      1161            pop dph
0C6D 020CAD    1162       ljmp ReflowDone
0C70           1163   
0C70           1164   CheckCarryState5:
0C70 4002      1165       jc LessThanState5
0C72 8007      1166       sjmp GreaterThanState5
0C74           1167   LessThanState5:
0C74 753000    1168       mov STATE_VAR_1, #0
0C77 C200      1169       clr START_FLAG
0C79 80BC      1170       sjmp State5
0C7B           1171   GreaterThanState5:
0C7B 80BA      1172       sjmp State5
0C7D           1173   
0C7D           1174   ResetToMain:
0C7D 753000    1175       mov STATE_VAR_1, #0
0C80 753C00    1176       mov POWER, #0
0C83 02073F    1177       ljmp MAIN
0C86           1178   
0C86           1179   StopReflow:
0C86 02073F    1180       ljmp MAIN
0C89           1181   
0C89           1182   STOPOVEN:
0C89 C0E0      1183            push acc
0C8B 7401      1183            mov a, #1
0C8D 14        1183            dec a
0C8E 1201E8    1183            lcall ?Set_Cursor_1 ; Select column and row
0C91 D0E0      1183            pop acc
0C93 C083      1184            push dph
0C95 C082      1184            push dpl
0C97 C0E0      1184            push acc
0C99 900111    1184            mov dptr, #abortcondition_message
0C9C 1201DB    1184            lcall ?Send_Constant_String
0C9F D0E0      1184            pop acc
0CA1 D082      1184            pop dpl
0CA3 D083      1184            pop dph
0CA5 30FB02    1185       jnb RESET_BUTTON, RestartProcess
0CA8 80DF      1186       sjmp STOPOVEN ; Infinite loop to stop the oven if abort condition is met
0CAA           1187   
0CAA           1188   RestartProcess:
0CAA 02073F    1189       ljmp MAIN
0CAD           1190       
0CAD           1191   ReflowDone:
0CAD C0E0      1192            push acc
0CAF 7401      1192            mov a, #1
0CB1 14        1192            dec a
0CB2 1201E6    1192            lcall ?Set_Cursor_2 ; Select column and row
0CB5 D0E0      1192            pop acc
0CB7 C083      1193            push dph
0CB9 C082      1193            push dpl
0CBB C0E0      1193            push acc
0CBD 90013A    1193            mov dptr, #restart_message
0CC0 1201DB    1193            lcall ?Send_Constant_String
0CC3 D0E0      1193            pop acc
0CC5 D082      1193            pop dpl
0CC7 D083      1193            pop dph
0CC9 30FBB1    1194       jnb RESET_BUTTON, ResetToMain
0CCC 80DF      1195       sjmp ReflowDone
0CCE           1196   EN
