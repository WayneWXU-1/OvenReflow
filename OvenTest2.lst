                  2   $LIST
0000              4   
0000              5   CLK           EQU 33333333 ; Microcontroller system crystal frequency in Hz
0000              6   TIMER0_RATE   EQU 4096     ; 2048Hz squarewave (peak amplitude of CEM-1203 speaker)
0000              7   TIMER0_RELOAD EQU ((65536-(CLK/(12*TIMER0_RATE)))) ; The prescaler in the CV-8052 is always 12 unlike the N76E003 where is selectable.
0000              8   TIMER2_RATE   EQU 1000     ; 1000Hz, for a timer tick of 1ms
0000              9   TIMER2_RELOAD EQU ((65536-(CLK/(12*TIMER2_RATE))))
0000             10   BAND          EQU 2 ;for flat states
0000             11   LEAD2              EQU 4 ;a too close overshoots currently
0000             12   LEAD          EQU 20 ;for ramp sates
0000             13   
0000             14   BAUD   EQU 57600
0000             15   T1_LOAD EQU 256-(2*CLK) / (32*12*BAUD) ;Load 253 so it counts 3 counts before overflowing, which gives us a 57600 baud rate with a 33.333MHz clock
0000             16   
0000             17   
0000             18   ; ********* Buttons ***********
0000             19   SELECT_BUTTON equ P3_4 ; middle
0000             20   RESET_BUTTON  equ P3_2 ; left
0000             21   START_BUTTON  equ P3_5 ; middle right
0000             22   STOP_BUTTON   equ P3_7 ; right 
0000             23   PARAM_BUTTON  equ P3_3 ; middle left
0000             24   
0000             25   OVEN_PIN      equ P0.0
0000             26   SOUND_OUT     equ P1.5 ; Speaker attached to this pin
0000             27   UPDOWN        equ SWA.0
0000             28   TENS          equ SWA.1
0000             29   
0000             30   ; Reset vector
0000             31   org 0x0000
0000 020A33      32       ljmp MAIN
0003             33   
0003             34   ; External interrupt 0 vector (not used in this code)
0003             35   org 0x0003
0003 32          36            reti
0004             37   
0004             38   ; Timer/Counter 0 overflow interrupt vector
000B             39   org 0x000B
000B 02059D      40            ljmp Timer0_ISR
000E             41   
000E             42   ; External interrupt 1 vector (not used in this code)
0013             43   org 0x0013
0013 32          44            reti
0014             45   
0014             46   ; Timer/Counter 1 overflow interrupt vector (not used in this code)
001B             47   org 0x001B
001B 32          48            reti
001C             49   
001C             50   ; Serial port receive/transmit interrupt vector (not used in this code)
0023             51   org 0x0023 
0023 32          52            reti
0024             53            
0024             54   ; Timer/Counter 2 overflow interrupt vector
002B             55   org 0x002B
002B 0205BF      56            ljmp Timer2_ISR
002E             57   
002E             58   
002E             59   ;--- DATA RAM ---
0030             60   dseg at 0x30
0030             61   STATE_VAR_1:     DS 1 
0031             62   STATE_VAR_2:     DS 1
0032             63   SECOND_COUNTER:  DS 1 
0033             64   TEMP_HIGH_BYTE:  DS 1 
0034             65   TEMP_LOW_BYTE:   DS 1 
0035             66   
0035             67   
0035             68   TEMP:            DS 5
003A             69   TIME:            DS 2
003C             70   POWER:           DS 2
003E             71   DEGREES60:       DS 2
0040             72   DEGREES150:      DS 2
0042             73   DEGREES220:      DS 2
0044             74   TARGET:          DS 2
0046             75   TARGET_TIME:     DS 2
0048             76   ;*** Variables ***
0048             77   SOAK_TEMP_set:       ds 2
004A             78   SOAK_TIME_set:       ds 2
004C             79   reflow_temp_set:     ds 2
004E             80   REFLOW_TIME_set:     ds 2
0050             81   
0050             82   soak_time:       ds 2
0052             83   REFLOW_TIME:     ds 2
0054             84   
0054             85   beep_count:      ds 1
0055             86   
0055             87   ; PWM variables
0055             88   LOW_LIMIT:  ds 2
0057             89   HIGH_LIMIT: ds 2
0059             90   THRESHOLD:  ds 2
005B             91   
005B             92   x:               ds      4 ;used for 32 bit math for temperature conversion
005F             93   y:               ds      4 ;used for 32 bit math for temperature conversion
0063             94   bcd:    ds  5 ; <--- ADD THIS: math32 needs 5 bytes for BCD conversions
0068             95   
0068             96   ;--ISR RELATED--;
0068             97   Count1ms:     ds 2 ; Used to determine when half second has passed
006A             98   BCD_counter:  ds 1 ; The BCD counter incrememted in the ISR and displayed in the main loop
006B             99   
006B            100   
006B            101   ; **** keypad variables ****
006B            102   keypad_digit_count: ds 1
006C            103   
006C            104   
0000            105   bseg
0000            106   START_FLAG:         DBIT 1  ; Use DBIT for single bits in bseg
0001            107   half_seconds_flag:  DBIT 1  ; half second flag
0002            108   SECONDS_FLAG:       DBIT 1  ; can change later depending on how fast we want it
0003            109   SELECT_BUTTON_FLAG: DBIT 1
0004            110   PARAM_BUTTON_FLAG:  DBIT 1
0005            111   KEYPAD_FLAG:        DBIT 1
0006            112   mf:     dbit 1 ; <--- ADD THIS: math32 uses this as a status flag
0007            113   
002E            114   cseg
002E            115   ; These 'equ' must match the hardware wiring
002E            116   ; None of these are implemented yet, we need to match these assignments to the wiring
002E            117   ELCD_RS equ P1.7
002E            118   ;LCD_RW equ PX.X ; Not used in this code, connect the pin to GND
002E            119   ELCD_E equ  P1.1
002E            120   ELCD_D4 equ P0.7
002E            121   ELCD_D5 equ P0.5
002E            122   ELCD_D6 equ P0.3
002E            123   ELCD_D7 equ P0.1
002E            124   
002E            125   ;Keypad pin assignments
002E            126   ROW1 EQU P1.2
002E            127   ROW2 EQU P1.4
002E            128   ROW3 EQU P1.6
002E            129   ROw4 EQU P2.0
002E            130   COL1 EQU P2.2
002E            131   COL2 EQU P2.4
002E            132   COL3 EQU P2.6
002E            133   COL4 EQU P3.0
002E            134   
002E            135   ;                           1234567890123456
002E 20202020   136   blank_row:              db '                ', 0
     20202020
     20202020
     20202020
     00
003F 50726573   137   preset_message:         db 'Presets: 1 2 3 4', 0
     6574733A
     20312032
     20332034
     00
0050 53656C65   138   param_message:          db 'Select Parameter', 0
     63742050
     6172616D
     65746572
     00
0061 536F616B   139   soak_temp_message:      db 'Soak Temp: xxx C', 0
     2054656D
     703A2078
     78782043
     00
0072 536F616B   140   soak_time_message:      db 'Soak Time: xx  s', 0
     2054696D
     653A2078
     78202073
     00
0083 52666C77   141   reflow_temp_message:    db 'Rflw Temp: xxx C', 0
     2054656D
     703A2078
     78782043
     00
0094 52666C77   142   reflow_time_message:    db 'Rflw Time: xx  s', 0
     2054696D
     653A2078
     78202073
     00
00A5 52656164   143   ready_message:          db 'Ready to Start! ', 0
     7920746F
     20537461
     72742120
     00
00B6 2D2D2D2D   144   state0_message:         db '-----State0-----', 0
     2D537461
     7465302D
     2D2D2D2D
     00
00C7 2D2D2D2D   145   state1_message:         db '-----State1-----', 0
     2D537461
     7465312D
     2D2D2D2D
     00
00D8 2D2D2D2D   146   state2_message:         db '-----State2-----', 0
     2D537461
     7465322D
     2D2D2D2D
     00
00E9 2D2D2D2D   147   state3_message:         db '-----State3-----', 0
     2D537461
     7465332D
     2D2D2D2D
     00
00FA 2D2D2D2D   148   state4_message:         db '-----State4-----', 0
     2D537461
     7465342D
     2D2D2D2D
     00
010B 2D2D2D2D   149   state5_message:         db '-----State5-----', 0
     2D537461
     7465352D
     2D2D2D2D
     00
011C 2A2A2A2A   150   abortcondition_message: db '*****ABORT!*****', 0
     2A41424F
     5254212A
     2A2A2A2A
     00
012D 54494D45   151   reflow_message:         db 'TIME:XXXTEMP:XXX', 0
     3A585858
     54454D50
     3A585858
     00
013E 5265666C   152   reflowdone_message:     db 'Reflow Complete!', 0
     6F772043
     6F6D706C
     65746521
     00
014F 52535420   153   restart_message:        db 'RST 2 Bake Again', 0
     32204261
     6B652041
     6761696E
     00
0160            154   
0160 5265666C   155   stop_message:           db 'Reflow Stopped! ', 0
     6F772053
     746F7070
     65642120
     00
0171            156   
0171 54494D45   157   TimeLabel: db 'T','I','M','E',':', 0
     3A00
0177 54454D50   158   TempLabel: db 'T','E','M','P',':', 0
     3A00
017D            159   
                161   	$LIST
0234            163   
                614   $LIST
                166   $LIST
0526            168   
0526            169   ;-----------------------INTIALIZE SERIAL PORT FOR INPUT OUTUUT-----------------------;
0526            170   ;--Setting baud rate to 57600 with 33.33MHz clock--;
0526            171   ;-----------EXPLANATION------------
0526            172   ;Crystal oscillates at 33.33Mhz, the CV-8052 has a fixed prescaler of 12 for timers
0526            173   ;So the effective clock for timers is 33.33MHz/12 = 2.7775MHzl
0526            174   ;SMOD is set to 1 in PCON so using 1/16th the clock for baud rate generation
0526            175   ;That means the baud rate clock is 2.7775MHz/16 = 173.611kHz
0526            176   ;Since we have 253 out of 256 its three clicks 
0526            177   ;per bit, the baud rate is 173.611kHz/3 = 57.870kbps which is close enough to 57600bps
0526            178   ;-----------------------------------
0526            179   
0526            180   InitSerialPort:
0526            181            ; Configure serial port and baud rate
0526 C28E       182       clr TR1 ; Disable timer 1
0528 E589       183       mov a, TMOD
052A 540F       184       anl a, #0x0f ; Clear the bits for timer 1
052C 4420       185       orl a, #0x20 ; Configure timer 1 as 8-bit autoreload
052E F589       186       mov TMOD, a ; Set timer 1 mode
0530            187   
0530 758DFD     188       mov TH1, #T1_LOAD ; Load the timer value for the desired baud rate
0533 758BFD     189       mov TL1, #T1_LOAD ;Doesnt matter what we load in TL1 because it is in autoreload mode, but we need to load it with something to prevent it from overflowing immediately
0536            190       ;Leave it as you found it, make SMOD = 1 for double baud rate
0536 E587       191       mov a, PCON ; Set SMOD to 1
0538 4480       192       orl a, #0x80
053A F587       193       mov PCON, a
053C D28E       194       setb TR1 ; Enable timer 1
053E 759852     195       mov SCON, #01010010B ; Mode 1, 8-bit UART, enable receiver
0541 22         196            ret
0542            197   
0542            198   Display_Voltage_Serial:
0542 85355B     199            mov x+0, TEMP+0 ; reloads the temp into x which will be converted to bcd
0545 85365C     200       mov x+1, TEMP+1
0548 755D00     201       mov x+2, #0
054B 755E00     202       mov x+3, #0
054E 120234     203       lcall hex2bcd ; standard math32.asm function
0551            204       
0551 7454       205            mov a, #'T'
0553 120582     206            lcall putchar
0556 743D       207            mov a, #'='
0558 120582     208            lcall putchar
055B            209            
055B E564       210            mov a, bcd+1
055D 540F       211            anl a, #0FH
055F 4430       212            orl a, #'0'
0561 120582     213            lcall putchar
0564            214   
0564 E563       215            mov a, bcd+0
0566 C4         216            swap a
0567 540F       217            anl a, #0FH
0569 4430       218            orl a, #'0'
056B 120582     219            lcall putchar
056E            220            
056E E563       221            mov a, bcd+0
0570 540F       222            anl a, #0FH
0572 4430       223            orl a, #'0'
0574 120582     224            lcall putchar
0577            225   
0577 740D       226            mov a, #'\r'
0579 120582     227            lcall putchar
057C 740A       228            mov a, #'\n'
057E 120582     229            lcall putchar
0581            230            
0581 22         231            ret
0582            232   
0582            233   
0582            234   
0582            235   ; Function to stransmit accumulator value into the serial buffer register after previous completion
0582            236   putchar:
0582 3099FD     237       jnb TI, putchar ; TI is the transmit interrupt, it will loop until it is high and we know the previous bit is sent
0585            238       
0585 C299       239       clr TI  ; Reset back to 0 to indicate we are transmitting 
0587 F599       240       mov SBUF, a ; accumulator will have output chharacter already stored on it
0589 22         241       ret
058A            242   
058A            243   
058A            244   ; ******************************* TIMER ISRS ************************************
058A            245   
058A            246   Timer0_Init:
058A E589       247            mov a, TMOD
058C 54F0       248            anl a, #0xf0 ; Clear the bits for timer 0
058E 4401       249            orl a, #0x01 ; Configure timer 0 as 16-timer
0590 F589       250            mov TMOD, a
0592 758CFD     251            mov TH0, #high(TIMER0_RELOAD)
0595 758A5A     252            mov TL0, #low(TIMER0_RELOAD)
0598            253            ; Enable the timer and interrupts
0598 D2A9       254       setb ET0  ; Enable timer 0 interrupt
059A D28C       255       setb TR0  ; Start timer 0
059C 22         256            ret
059D            257   
059D            258   ;---------------------------------;
059D            259   ; ISR for timer 0.  Set to execute;
059D            260   ; every 1/4096Hz to generate a    ;
059D            261   ; 2048 Hz square wave at pin P1.5 ;
059D            262   ;---------------------------------;
059D            263   Timer0_ISR:
059D            264            ;clr TF0  ; According to the data sheet this is done for us already.
059D 758CFD     265            mov TH0, #high(TIMER0_RELOAD) ; Timer 0 doesn't have autoreload in the CV-8052
05A0 758A5A     266            mov TL0, #low(TIMER0_RELOAD)
05A3 B295       267            cpl SOUND_OUT ; Connect speaker to P1.5
05A5 32         268            reti
05A6            269   
05A6            270   ;---------------------------------;
05A6            271   ; Routine to initialize the ISR   ;
05A6            272   ; for timer 2                     ;
05A6            273   ;---------------------------------;
05A6            274   Timer2_Init:
05A6 75C800     275            mov T2CON, #0 ; Stop timer/counter.  Autoreload mode.
05A9 75CDF5     276            mov TH2, #high(TIMER2_RELOAD)
05AC 75CC27     277            mov TL2, #low(TIMER2_RELOAD)
05AF            278            ; Set the reload value
05AF 75CBF5     279            mov RCAP2H, #high(TIMER2_RELOAD)
05B2 75CA27     280            mov RCAP2L, #low(TIMER2_RELOAD)
05B5            281            ; Init One millisecond interrupt counter.  It is a 16-bit variable made with two 8-bit parts
05B5 E4         282            clr a
05B6 F568       283            mov Count1ms+0, a
05B8 F569       284            mov Count1ms+1, a
05BA            285            ; Enable the timer and interrupts
05BA D2AD       286       setb ET2  ; Enable timer 2 interrupt
05BC D2CA       287       setb TR2  ; Enable timer 2
05BE 22         288            ret
05BF            289   
05BF            290   ;---------------------------------;
05BF            291   ; ISR for timer 2                 ;
05BF            292   ;---------------------------------;
05BF            293   Timer2_ISR:
05BF C2CF       294            clr TF2  ; Timer 2 doesn't clear TF2 automatically. Do it in ISR
05C1            295            
05C1            296            ; The two registers used in the ISR must be saved in the stack
05C1 C0E0       297            push acc
05C3 C0D0       298            push psw
05C5            299            
05C5            300            ; Increment the 16-bit one mili second counter
05C5 0568       301            inc Count1ms+0    ; Increment the low 8-bits first
05C7 E568       302            mov a, Count1ms+0 ; If the low 8-bits overflow, then increment high 8-bits
05C9 7002       303            jnz Inc_Done
05CB 0569       304            inc Count1ms+1 ;increment high 8-bits if low 8-bits overflowed
05CD            305   
05CD            306   Inc_Done:
05CD            307            ; Check if full second has passed
05CD E568       308            mov a, Count1ms+0
05CF B4E86D     309            cjne a, #low(1000), Timer2_ISR_Midpoint ; Warning: this instruction changes the carry flag!
05D2 E569       310            mov a, Count1ms+1
05D4 B40368     311            cjne a, #high(1000), Timer2_ISR_Midpoint
05D7            312       
05D7            313       
05D7 75A100     314            mov ADC_C, #00000000b
05DA            315            
05DA            316   
05DA 755E00     317       mov x+3, #0
05DD 755D00     318            mov x+2, #0
05E0 85A35C     319            mov x+1, ADC_H
05E3 85A25B     320            mov x+0, ADC_L
05E6            321       ; Convert ADC reading to temperature in Celsius
05E6            322       ; Voltage = (ADC_value * 5000) / 4096
05E6 755F88     323            mov y+0, #low (5000 % 0x10000) 
05E9 756013     323            mov y+1, #high(5000 % 0x10000) 
05EC 756100     323            mov y+2, #low (5000 / 0x10000) 
05EF 756200     323            mov y+3, #high(5000 / 0x10000) 
05F2            323   
05F2 120392     324            lcall mul32
05F5 755F00     325            mov y+0, #low (4096 % 0x10000) 
05F8 756010     325            mov y+1, #high(4096 % 0x10000) 
05FB 756100     325            mov y+2, #low (4096 / 0x10000) 
05FE 756200     325            mov y+3, #high(4096 / 0x10000) 
0601 120486     326            lcall div32
0604            327       ; Result is in 'x'
0604            328   
0604 755FE8     329            mov y+0, #low (1000 % 0x10000) 
0607 756003     329            mov y+1, #high(1000 % 0x10000) 
060A 756100     329            mov y+2, #low (1000 / 0x10000) 
060D 756200     329            mov y+3, #high(1000 / 0x10000)  ; convert to microvolts
0610 120392     330       lcall mul32
0613 755F0C     331            mov y+0, #low (12300 % 0x10000) 
0616 756030     331            mov y+1, #high(12300 % 0x10000) 
0619 756100     331            mov y+2, #low (12300 / 0x10000) 
061C 756200     331            mov y+3, #high(12300 / 0x10000)  ; 41 * 300
061F 120486     332       lcall div32
0622            333   
0622 755F16     334            mov y+0, #low (22 % 0x10000) 
0625 756000     334            mov y+1, #high(22 % 0x10000) 
0628 756100     334            mov y+2, #low (22 / 0x10000) 
062B 756200     334            mov y+3, #high(22 / 0x10000)  ; add cold junction temperature
062E 1202D9     335       lcall add32
0631            336       ;do your displays and stuff
0631            337       ;result is still in x
0631 855B35     338       mov TEMP+0, x+0
0634 855C36     339       mov TEMP+1, x+1
0637            340       
0637 120542     341       lcall Display_Voltage_Serial
063A 1208D1     342       lcall Display_BCD_7_seg
063D            343   
063D 8003       344       sjmp Timer2_ISR_Bypass
063F            345   
063F            346   Timer2_ISR_Midpoint:
063F 020682     347   ljmp Timer2_ISR_done
0642            348   Timer2_ISR_Bypass:
0642            349   
0642            350   ;---------------------------------------------------------------------;
0642            351            
0642            352            ;1 second have passed.  Set a flag so the main program knows
0642 D202       353            setb seconds_flag ; Let the main program know one second had passed
0644            354            ; Toggle LEDR0 so it blinks
0644 053A       355       inc TIME ; Increment the TIME Variable
0646 B2E8       356            cpl LEDRA.0
0648 E4         357            clr a
0649 F568       358            mov Count1ms+0, a
064B F569       359            mov Count1ms+1, a
064D            360       
064D            361       ;Call PWM funcions
064D            362   Checkforstate1:
064D E530       363       MOV A, STATE_VAR_1
064F B40105     364       CJNE A, #1, NOT_STATE_1
0652 120960     365       LCALL pwm_for_ramp
0655 8016       366       SJMP PWM_EXIT
0657            367   NOT_STATE_1:
0657 B40305     368       CJNE A, #3, NOT_STATE_3
065A 12097C     369       LCALL pwm_for_ramp2
065D 800E       370       SJMP PWM_EXIT
065F            371   NOT_STATE_3:
065F B40205     372       CJNE A, #2, NOT_STATE_2
0662 120934     373       LCALL pwm_for_flatstates
0665 8006       374       SJMP PWM_EXIT
0667            375   NOT_STATE_2:
0667 B40403     376       CJNE A, #4, PWM_EXIT     ; If not 4, do nothing and exit
066A 120934     377       LCALL pwm_for_flatstates
066D            378   PWM_EXIT:
066D            379   
066D            380   
066D            381       
066D            382            ; Increment the BCD counter
066D E56A       383            mov a, BCD_counter
066F 20E80B     384            jb UPDOWN, Timer2_ISR_decrement
0672 2401       385            add a, #0x01; Increment the BCD counter
0674 E56A       386            mov a, BCD_counter
0676 20E804     387            jb UPDOWN, Timer2_ISR_decrement
0679 2401       388            add a, #0x01
067B 8002       389            sjmp Timer2_ISR_da
067D            390   Timer2_ISR_decrement:
067D 2499       391            add a, #0x99 ; Adding the 10-complement of -1 is like subtracting 1.
067F            392   Timer2_ISR_da:
067F D4         393            da a ; Decimal adjust instruction.  Check datasheet for more details!
0680 F56A       394            mov BCD_counter, a
0682            395   
0682            396            
0682            397   Timer2_ISR_done:
0682 D0D0       398            pop psw
0684 D0E0       399            pop acc
0686 32         400            reti
0687            401   
0687            402   INITIALIZE:
0687            403   
0687 759AAB     404            mov P0MOD, #10101011b ; P0.0(OVEN_PIN), P0.1, P0.3, P0.5, P0.7(LCD) are outputs. 
068A 759BF7     405       mov P1MOD, #11110111b ; P1.7, P1.5, P1.1(LCD), 1.2, 1.4, 1.6(ROW) are outputs, P1.0
068D 759C01     406       mov P2MOD, #00000001b ; output: 2.0(ROW) input: 2.2, 2.4, 2.6(COL)
0690 759D02     407       mov P3MOD, #00000010b ; input: 3.0 (COL), 3.2, 3.3, 3.4, 3.5, 3.7 out: 3.1
0693            408       ; for keypad, (ROWS as output-1)1.2, 1.4, 1.6, 2.0 - (COLS as input-0) 2.2, 2.4, 2.6, 3.0
0693 75A100     409       mov ADC_C, #0x00      ; Select ADC Channel 0
0696 75A180     410       mov ADC_C, #10000000b ; ADC Enable = 1 test******
0699 22         411       ret                   ; Added RET so it doesn't crash after initializing
069A            412   
069A            413   ; ************************** FUNCTIONS ***********************************
069A            414   
069A            415   Wait50ms:
069A            416   ;33.33MHz, 1 clk per cycle: 0.03us
069A 781E       417            mov R0, #30
069C            418   Wait50ms_L3:
069C 794A       419            mov R1, #74
069E            420   Wait50ms_L2:
069E 7AFA       421            mov R2, #250
06A0            422   Wait50ms_L1:
06A0 DAFE       423            djnz R2, Wait50ms_L1 ;3*250*0.03us=22.5us
06A2 D9FA       424       djnz R1, Wait50ms_L2 ;74*22.5us=1.665ms
06A4 D8F6       425       djnz R0, Wait50ms_L3 ;1.665ms*30=50ms
06A6 22         426       ret
06A7            427   
06A7            428   
06A7            429   ; **************************** KEYPAD *******************************
06A7            430   
06A7            431   myLUT:
06A7 C0F9A4B0   432       DB 0xC0, 0xF9, 0xA4, 0xB0, 0x99        ; 0 TO 4
     99
06AC 9282F880   433       DB 0x92, 0x82, 0xF8, 0x80, 0x90        ; 4 TO 9
     90
06B1 8883C6A1   434       DB 0x88, 0x83, 0xC6, 0xA1, 0x86, 0x8E  ; A to F
     868E
06B7            435   
                436   showBCD MAC
                437   	; Display LSD
                438       mov A, %0
                439       anl a, #0fh
                440       movc A, @A+dptr
                441       mov %1, A
                442   
                443   	; Display MSD
                444       mov A, %0
                445       swap a
                446       anl a, #0fh
                447       movc A, @A+dptr
                448       mov %2, A
                449   ENDMAC
06B7            450   
06B7            451   Display:
06B7 9006A7     452            mov dptr, #myLUT
                452   	$MESSAGE TIP: If digits 10, 9, 8, and 7 are not zero, LEDR7: on
06BA            454   
06BA E566       455            mov a, bcd+3
06BC 4567       456            orl a, bcd+4
06BE 6004       457            jz Display_L1
06C0 D2EF       458            setb LEDRA.7 ; Non-zero digits alert
06C2 8002       459            sjmp Display_L2
06C4            460   
06C4            461   Display_L1:
06C4 C2EF       462            clr LEDRA.7
06C6            463   
06C6            464   Display_L2:
                464   	$MESSAGE TIP: Pressing KEY3, displays the most significant digits of the 10-digit number
06C6            466   
06C6 30FB2F     467            jnb key.3, Display_high_digits
06C9            468            ; Display LSD
06C9 E563       468       mov A, bcd+0
06CB 540F       468       anl a, #0fh
06CD 93         468       movc A, @A+dptr
06CE F591       468       mov HEX0, A
06D0            468   
06D0            468            ; Display MSD
06D0 E563       468       mov A, bcd+0
06D2 C4         468       swap a
06D3 540F       468       anl a, #0fh
06D5 93         468       movc A, @A+dptr
06D6 F592       468       mov HEX1, A
06D8            469            ; Display LSD
06D8 E564       469       mov A, bcd+1
06DA 540F       469       anl a, #0fh
06DC 93         469       movc A, @A+dptr
06DD F593       469       mov HEX2, A
06DF            469   
06DF            469            ; Display MSD
06DF E564       469       mov A, bcd+1
06E1 C4         469       swap a
06E2 540F       469       anl a, #0fh
06E4 93         469       movc A, @A+dptr
06E5 F594       469       mov HEX3, A
06E7            470            ; Display LSD
06E7 E565       470       mov A, bcd+2
06E9 540F       470       anl a, #0fh
06EB 93         470       movc A, @A+dptr
06EC F58E       470       mov HEX4, A
06EE            470   
06EE            470            ; Display MSD
06EE E565       470       mov A, bcd+2
06F0 C4         470       swap a
06F1 540F       470       anl a, #0fh
06F3 93         470       movc A, @A+dptr
06F4 F58F       470       mov HEX5, A
06F6            471   
06F6 8024       472            sjmp Display_end
06F8            473   
06F8            474   Display_high_digits:
06F8            475            ; Display LSD
06F8 E566       475       mov A, bcd+3
06FA 540F       475       anl a, #0fh
06FC 93         475       movc A, @A+dptr
06FD F591       475       mov HEX0, A
06FF            475   
06FF            475            ; Display MSD
06FF E566       475       mov A, bcd+3
0701 C4         475       swap a
0702 540F       475       anl a, #0fh
0704 93         475       movc A, @A+dptr
0705 F592       475       mov HEX1, A
0707            476            ; Display LSD
0707 E567       476       mov A, bcd+4
0709 540F       476       anl a, #0fh
070B 93         476       movc A, @A+dptr
070C F593       476       mov HEX2, A
070E            476   
070E            476            ; Display MSD
070E E567       476       mov A, bcd+4
0710 C4         476       swap a
0711 540F       476       anl a, #0fh
0713 93         476       movc A, @A+dptr
0714 F594       476       mov HEX3, A
0716 758EFF     477            mov HEX4, #0xff         
0719 758FFF     478            mov HEX5, #0xff         
071C            479   
071C            480   Display_end:
071C 22         481       ret
071D            482   
071D            483   
                484   MYRLC MAC
                485   	mov a, %0
                486   	rlc a
                487   	mov %0, a
                488   ENDMAC
071D            489   
071D            490   Shift_Digits_Left:
071D 7804       491            mov R0, #4 ; shift left four bits
071F B4031B     492       cjne a, #3, Shift_Digits_Left_L0
0722 22         493   ret
0723            494   
0723 E531       495       mov a, STATE_VAR_2
0725 B40006     496       cjne a, #0, KCheck_StateC
0728            497   
0728 E56B       498       mov a, keypad_digit_count
072A B40310     499       cjne a, #3, Shift_Digits_Left_L0
072D            500   
072D 22         501       ret
072E            502   
072E            503   KCheck_StateC:
072E B40206     504       cjne a, #2, KCheck_Time_States
0731 E56B       505       mov a, keypad_digit_count
0733 B40307     506       cjne a, #3, Shift_Digits_Left_L0
0736 22         507       ret
0737            508   
0737            509   KCheck_Time_States:
0737 E56B       510       mov a, keypad_digit_count
0739 B40201     511       cjne a, #2, Shift_Digits_Left_L0
073C 22         512       ret
073D            513   
073D            514   Shift_Digits_Left_L0:
073D C3         515            clr c
073E E563       516            mov a, bcd+0
0740 33         516            rlc a
0741 F563       516            mov bcd+0, a
0743 E564       517            mov a, bcd+1
0745 33         517            rlc a
0746 F564       517            mov bcd+1, a
0748 E565       518            mov a, bcd+2
074A 33         518            rlc a
074B F565       518            mov bcd+2, a
074D E566       519            mov a, bcd+3
074F 33         519            rlc a
0750 F566       519            mov bcd+3, a
0752 E567       520            mov a, bcd+4
0754 33         520            rlc a
0755 F567       520            mov bcd+4, a
0757            521   
0757 D8E4       522            djnz R0, Shift_Digits_Left_L0
0759            523            ; R7 has the new bcd digit      
0759 EF         524            mov a, R7
075A 4563       525            orl a, bcd+0
075C F563       526            mov bcd+0, a
075E            527   
075E 056B       528       inc keypad_digit_count
0760 D3         529       setb c
0761            530       
0761            531   Shift_Digits_left_exit:
0761 22         532            ret
0762            533   
0762            534            
                535   MYRRC MAC
                536   	mov a, %0
                537   	rrc a
                538   	mov %0, a
                539   ENDMAC
0762            540   
0762            541   Shift_Digits_Right:
0762 7804       542            mov R0, #4 ; shift right four bits
0764            543   
0764            544   Shift_Digits_Right_L0:
0764 C3         545            clr c
0765 E567       546            mov a, bcd+4
0767 13         546            rrc a
0768 F567       546            mov bcd+4, a
076A E566       547            mov a, bcd+3
076C 13         547            rrc a
076D F566       547            mov bcd+3, a
076F E565       548            mov a, bcd+2
0771 13         548            rrc a
0772 F565       548            mov bcd+2, a
0774 E564       549            mov a, bcd+1
0776 13         549            rrc a
0777 F564       549            mov bcd+1, a
0779 E563       550            mov a, bcd+0
077B 13         550            rrc a
077C F563       550            mov bcd+0, a
077E            551   
077E D8E4       552            djnz R0, Shift_Digits_Right_L0
0780            553   
0780 E56B       554       mov a, keypad_digit_count
0782 6003       555       jz Shift_Digits_Right_Ret
0784 156B       556       dec keypad_digit_count
0786            557   
0786 D3         558       setb c
0787            559   
0787            560   Shift_Digits_Right_Ret:
0787 22         561            ret
0788            562   
0788            563   
0788            564   Wait25ms:
0788            565   ;33.33MHz, 1 clk per cycle: 0.03us
0788 780F       566            mov R0, #15
078A 794A       567   LL3: mov R1, #74
078C 7AFA       568   LL2: mov R2, #250
078E DAFE       569   LL1: djnz R2, LL1 ;3*250*0.03us=22.5us
0790 D9FA       570        djnz R1, LL2 ;74*22.5us=1.665ms
0792 D8F6       571        djnz R0, LL3 ;1.665ms*15=25ms
0794            572   
0794 22         573       ret
0795            574   
0795            575   
0795            576   
                577   CHECK_COLUMN MAC
                578   	jb %0, CHECK_COL_%M
                579   	mov R7, %1
                580   	jnb %0, $ ; wait for key release
                581   	setb c
                582   	ret
                583   CHECK_COL_%M:
                584   ENDMAC
0795            585   
0795            586   Configure_Keypad_Pins:
0795            587            ; Configure the row pins as output and the column pins as inputs
0795 439B54     588            orl P1MOD, #0b_01010100 ; P1.6, P1.4, P1.2 output
0798 439C01     589            orl P2MOD, #0b_00000001 ; P2.0 output
079B 539CAB     590            anl P2MOD, #0b_10101011 ; P2.6, P2.4, P2.2 input
079E 539DFE     591            anl P3MOD, #0b_11111110 ; P3.0 input
07A1 22         592            ret
07A2            593   
07A2            594   ; This subroutine scans a 4x4 keypad.  If a key is pressed sets the carry
07A2            595   ; to one and returns the key code in register R7.
07A2            596   ; It works with both a default keypad or a modified keypad with the labels
07A2            597   ; rotated 90 deg ccw.  The type of keypad is determined by SW0, which is bit SWA.0
07A2            598   
07A2            599   Keypad:
07A2            600            ; First check the backspace/correction pushbutton.  We use KEY1 for this function.
                600   	$MESSAGE TIP: STOP_BUTTON is the erase key
07A2            602   
07A2 20B73F     603            jb STOP_BUTTON, keypad_L0
07A5 120788     604            lcall Wait25ms ; debounce
07A8 20B739     605            jb STOP_BUTTON, keypad_L0
07AB            606   
07AB 30B7FD     607            jnb STOP_BUTTON, $ ; The key was pressed, wait for release
07AE 120762     608            lcall Shift_Digits_Right
07B1 120281     609       lcall bcd2hex
07B4            610   
07B4 E531       611       mov a, STATE_VAR_2
07B6 B40008     612       cjne a, #0, check_delete_b
07B9            613   
07B9 855B48     614       mov soak_temp_set+0, x+0
07BC 855C49     615       mov soak_temp_set+1, x+1
07BF 8021       616       sjmp delete_done
07C1            617   
07C1            618   check_delete_b:
07C1 B40108     619       cjne a, #1, check_delete_c
07C4            620   
07C4 855B4A     621       mov soak_time_set+0, x+0
07C7 855C4B     622       mov soak_time_set+1, x+1
07CA 8016       623       sjmp delete_done
07CC            624   
07CC            625   check_delete_c:
07CC B40208     626       cjne a, #2, check_delete_d
07CF            627   
07CF 855B4C     628       mov reflow_temp_set+0, x+0
07D2 855C4D     629       mov reflow_temp_set+1, x+1
07D5 800B       630       sjmp delete_done
07D7            631   
07D7            632   check_delete_d:
07D7 B40308     633       cjne a, #3, delete_done
07DA            634   
07DA 855B4E     635       mov reflow_time_set+0, x+0
07DD 855C4F     636       mov reflow_time_set+1, x+1
07E0 8000       637       sjmp delete_done
07E2            638   
07E2            639   delete_done:
07E2            640   
07E2 C3         641            clr c
07E3 22         642            ret
07E4            643   
07E4            644   keypad_L0:
07E4            645   
07E4            646            ; Make all the rows zero.  If any column is zero then a key is pressed.
07E4 C292       647            clr ROW1
07E6 C294       648            clr ROW2
07E8 C296       649            clr ROW3
07EA C2A0       650            clr ROW4
07EC            651   
07EC A2A2       652            mov c, COL1
07EE 82A4       653            anl c, COL2
07F0 82A6       654            anl c, COL3
07F2 82B0       655            anl c, COL4
07F4            656   
07F4 5002       657            jnc Keypad_Debounce
07F6 C3         658            clr c
07F7 22         659            ret
07F8            660   
07F8            661   
07F8            662   Keypad_Debounce:
07F8            663            ; A key maybe pressed.  Wait and check again to discard bounces.
07F8 120788     664            lcall Wait25ms ; debounce
07FB            665   
07FB A2A2       666            mov c, COL1
07FD 82A4       667            anl c, COL2
07FF 82A6       668            anl c, COL3
0801 82B0       669            anl c, COL4
0803            670   
0803 5002       671            jnc Keypad_Key_Code
0805 C3         672            clr c
0806 22         673            ret
0807            674            
0807            675   
0807            676   Keypad_Key_Code:         
0807            677            ; A key is pressed.  Find out which one by checking each possible column and row combination.
0807            678   
0807 D292       679            setb ROW1
0809 D294       680            setb ROW2
080B D296       681            setb ROW3
080D D2A0       682            setb ROW4
080F            683   
080F            684            ; This check section is for an un-modified keypad
080F            685   
080F            686   keypad_default:  
080F            687   
080F            688            ; Check row 1   
080F C292       689            clr ROW1
0811 20A207     690            jb COL1, CHECK_COL_29
0814 7F01       690            mov R7, #01H
0816 30A2FD     690            jnb COL1, $ ; wait for key release
0819 D3         690            setb c
081A 22         690            ret
081B            690   CHECK_COL_29:
081B            690   
081B 20A407     691            jb COL2, CHECK_COL_30
081E 7F02       691            mov R7, #02H
0820 30A4FD     691            jnb COL2, $ ; wait for key release
0823 D3         691            setb c
0824 22         691            ret
0825            691   CHECK_COL_30:
0825 20A607     692            jb COL3, CHECK_COL_31
0828 7F03       692            mov R7, #03H
082A 30A6FD     692            jnb COL3, $ ; wait for key release
082D D3         692            setb c
082E 22         692            ret
082F            692   CHECK_COL_31:
082F 20B007     693            jb COL4, CHECK_COL_32
0832 7F0A       693            mov R7, #0AH
0834 30B0FD     693            jnb COL4, $ ; wait for key release
0837 D3         693            setb c
0838 22         693            ret
0839            693   CHECK_COL_32:
0839            694   
0839 D292       695            setb ROW1
083B            696   
083B            697            ; Check row 2   
083B            698   
083B C294       699            clr ROW2
083D 20A207     700            jb COL1, CHECK_COL_33
0840 7F04       700            mov R7, #04H
0842 30A2FD     700            jnb COL1, $ ; wait for key release
0845 D3         700            setb c
0846 22         700            ret
0847            700   CHECK_COL_33:
0847 20A407     701            jb COL2, CHECK_COL_34
084A 7F05       701            mov R7, #05H
084C 30A4FD     701            jnb COL2, $ ; wait for key release
084F D3         701            setb c
0850 22         701            ret
0851            701   CHECK_COL_34:
0851 20A607     702            jb COL3, CHECK_COL_35
0854 7F06       702            mov R7, #06H
0856 30A6FD     702            jnb COL3, $ ; wait for key release
0859 D3         702            setb c
085A 22         702            ret
085B            702   CHECK_COL_35:
085B 20B007     703            jb COL4, CHECK_COL_36
085E 7F0B       703            mov R7, #0BH
0860 30B0FD     703            jnb COL4, $ ; wait for key release
0863 D3         703            setb c
0864 22         703            ret
0865            703   CHECK_COL_36:
0865            704   
0865 D294       705            setb ROW2
0867            706   
0867            707            ; Check row 3   
0867            708   
0867 C296       709            clr ROW3
0869 20A207     710            jb COL1, CHECK_COL_37
086C 7F07       710            mov R7, #07H
086E 30A2FD     710            jnb COL1, $ ; wait for key release
0871 D3         710            setb c
0872 22         710            ret
0873            710   CHECK_COL_37:
0873 20A407     711            jb COL2, CHECK_COL_38
0876 7F08       711            mov R7, #08H
0878 30A4FD     711            jnb COL2, $ ; wait for key release
087B D3         711            setb c
087C 22         711            ret
087D            711   CHECK_COL_38:
087D 20A607     712            jb COL3, CHECK_COL_39
0880 7F09       712            mov R7, #09H
0882 30A6FD     712            jnb COL3, $ ; wait for key release
0885 D3         712            setb c
0886 22         712            ret
0887            712   CHECK_COL_39:
0887 20B007     713            jb COL4, CHECK_COL_40
088A 7F0C       713            mov R7, #0CH
088C 30B0FD     713            jnb COL4, $ ; wait for key release
088F D3         713            setb c
0890 22         713            ret
0891            713   CHECK_COL_40:
0891            714   
0891 D296       715            setb ROW3
0893            716   
0893            717            ; Check row 4   
0893            718   
0893 C2A0       719            clr ROW4
0895 20A207     720            jb COL1, CHECK_COL_41
0898 7F0E       720            mov R7, #0EH
089A 30A2FD     720            jnb COL1, $ ; wait for key release
089D D3         720            setb c
089E 22         720            ret
089F            720   CHECK_COL_41:
089F 20A407     721            jb COL2, CHECK_COL_42
08A2 7F00       721            mov R7, #00H
08A4 30A4FD     721            jnb COL2, $ ; wait for key release
08A7 D3         721            setb c
08A8 22         721            ret
08A9            721   CHECK_COL_42:
08A9 20A607     722            jb COL3, CHECK_COL_43
08AC 7F0F       722            mov R7, #0FH
08AE 30A6FD     722            jnb COL3, $ ; wait for key release
08B1 D3         722            setb c
08B2 22         722            ret
08B3            722   CHECK_COL_43:
08B3 20B007     723            jb COL4, CHECK_COL_44
08B6 7F0D       723            mov R7, #0DH
08B8 30B0FD     723            jnb COL4, $ ; wait for key release
08BB D3         723            setb c
08BC 22         723            ret
08BD            723   CHECK_COL_44:
08BD            724   
08BD D2A0       725            setb ROW4
08BF            726   
08BF C3         727            clr c
08C0            728   
08C0 22         729            ret
08C1            730   
08C1            731            
08C1            732   ; Look-up table for the 7-seg displays. (Segments are turn on with zero) 
08C1            733   T_7seg:
08C1 C0F9A4B0   734       DB 0xC0, 0xF9, 0xA4, 0xB0, 0x99        ; 0 TO 4
     99
08C6 9282F880   735       DB 0x92, 0x82, 0xF8, 0x80, 0x90        ; 4 TO 9
     90
08CB 8883C6A1   736       DB 0x88, 0x83, 0xC6, 0xA1, 0x86, 0x8E  ; A to F
     868E
08D1            737   
08D1            738   
08D1            739   ; Displays a BCD number in HEX1-HEX0
08D1            740   Display_BCD_7_Seg:
08D1 C0E0       741       push acc
08D3 C0D0       742       push psw
08D5            743   
08D5 85355B     744            mov x+0, TEMP+0
08D8 85365C     745            mov x+1, TEMP+1
08DB 85375D     746       mov x+2, TEMP+2
08DE 120234     747            lcall hex2bcd
08E1            748   
08E1 9008C1     749            mov dptr, #T_7seg
08E4            750   
08E4 E565       751       mov a, bcd+2
08E6 C4         752       swap a
08E7 540F       753       anl a, #0FH
08E9 93         754       movc a, @a+dptr
08EA F58F       755       mov HEX5, a
08EC            756   
08EC E565       757       mov a, bcd+2
08EE 540F       758       anl a, #0FH
08F0 93         759       movc a, @a+dptr
08F1 F58E       760       mov HEX4, a
08F3            761   
08F3 E564       762       mov a, bcd+1
08F5 C4         763       swap a
08F6 540F       764       anl a, #0FH
08F8 93         765       movc a, @a+dptr
08F9 F594       766       mov HEX3, a
08FB            767   
08FB E564       768       mov a, bcd+1
08FD 540F       769       anl a, #0FH
08FF 93         770       movc a, @a+dptr
0900 F593       771       mov HEX2, a
0902            772   
0902 E563       773            mov a, bcd
0904 C4         774            swap a
0905 540F       775            anl a, #0FH
0907 93         776            movc a, @a+dptr
0908 F592       777            mov HEX1, a
090A            778   
090A E563       779            mov a, bcd
090C 540F       780            anl a, #0FH
090E 93         781            movc a, @a+dptr
090F F591       782            mov HEX0, a
0911            783   
0911 D0D0       784       pop psw
0913 D0E0       785       pop acc
0915            786   
0915 22         787            ret
0916            788   
0916            789   
0916            790   Check_Select_Button_Press:
0916 20B40B     791       jb SELECT_BUTTON, Not_Pressed
0919 12069A     792       lcall Wait50ms
091C 20B405     793       jb SELECT_BUTTON, Not_Pressed
091F            794   
091F D203       795       setb SELECT_BUTTON_FLAG
0921            796   
0921 30B4FD     797       jnb SELECT_BUTTON, $
0924            798   
0924            799       Not_Pressed:
0924 22         800           ret
0925            801   
0925            802   
0925            803   Check_Param_Button_Press:
0925 20B30B     804       jb PARAM_BUTTON, Not_Pressed_2
0928 12069A     805       lcall Wait50ms
092B 20B305     806       jb PARAM_BUTTON, Not_Pressed_2
092E            807   
092E D204       808       setb PARAM_BUTTON_FLAG
0930            809   
0930 30B3FD     810       jnb PARAM_BUTTON, $
0933            811   
0933            812       Not_Pressed_2:
0933 22         813           ret
0934            814   
0934            815       ;---------------READ KEYPAD-------------------;
0934            816   
0934            817       ;A Macro essentially works like CHECK_COL(COL#, Literal value coloumn represents)
0934            818       ;If the column is pressed, R7 will contain the column number (1-4)
0934            819       
0934            820   
0934            821   ;**************************PWM**************************;
0934            822   pwm_for_flatstates:
0934            823   ; ---- LOW_LIM = max(0, T_TGT - T_BAND)
0934 E544       824           MOV     A, TARGET          
0936 C3         825           CLR     C                 ;clear carry
0937 9402       826           SUBB    A, #BAND         ; A = A - BAND
0939 5002       827           JNC     flat_low_ok       
093B 7400       828           MOV     A, #00h           
093D            829   flat_low_ok:
093D F555       830           MOV     LOW_LIMIT, A        ; Store low limit in RAM
093F            831   
093F            832           ;compute high limit
093F E544       833           MOV     A, TARGET          
0941 2402       834           ADD     A, #BAND         
0943 5002       835           JNC     flat_high_ok      
0945 74FF       836           MOV     A, #0FFh          
0947            837   flat_high_ok:
0947 F557       838           MOV     HIGH_LIMIT, A       
0949            839   
0949            840           ;turn oven on if curren temp is less than low limit
0949 E535       841           MOV     A, TEMP          ;make sure this variables is right!!!!!!!
094B C3         842           CLR     C               
094C 9555       843           SUBB    A, LOW_LIMIT       
094E            844                                    
094E 400A       845           JC      flat_on       ;temp is less than low limit so turn power on since there is carry
0950            846   
0950            847           ;if current temp is greater than high lim turn off
0950 E535       848           MOV     A, TEMP
0952 C3         849           CLR     C                 
0953 9557       850           SUBB    A, HIGH_LIMIT       
0955            851                                    
0955 6002       852           JZ      flat_done         ; If equal to HIGH_LIMit do nothing
0957 5004       853           JNC     flat_off      ; If no borrow and not zero T_CUR > HIGH_LIM so turn off
0959            854   
0959            855   flat_done:
0959 22         856           RET                       ; Inside band do nothing, holds prev values
095A            857   flat_on:
095A D280       858           SETB p0.0      ;turn power on
095C 22         859           RET
095D            860   
095D            861   flat_off:
095D C280       862           CLR p0.0      ;power off
095F 22         863           RET
0960            864   
0960            865   
0960            866   
0960            867   
0960            868   pwm_for_ramp:
0960 E544       869                    MOV     A, TARGET          
0962 C3         870           CLR     C                 
0963 9414       871           SUBB    A, #LEAD         
0965            872                                    
0965 5002       873           JNC     ramp_thresh_ok    
0967 7400       874           MOV     A, #00h           
0969            875   ramp_thresh_ok:
0969 F559       876           MOV     THRESHOLD, A         
096B            877   
096B            878           ;if less than threshold turn power on 
096B E535       879           MOV     A, TEMP          
096D C3         880           CLR     C                 
096E 9559       881           SUBB    A, THRESHOLD         ; A = curren temp - threshold(target-lead)
0970            882                                    
0970 4004       883           JC      ramp_force_on     ; If below threshold force on and return
0972            884   
0972 020979     885           ljmp     ramp_set_off     
0975            886   
0975            887   
0975            888   ramp_done:
0975 22         889           RET                      
0976            890   
0976            891   ramp_force_on:
0976 D280       892           SETB p0.0      ;power on
0978 22         893           RET
0979            894   
0979            895   ramp_set_off:
0979 C280       896           CLR p0.0
097B 22         897           RET 
097C            898           
097C            899   
097C            900   pwm_for_ramp2:
097C E544       901                    MOV     A, TARGET          
097E C3         902           CLR     C                 
097F 9404       903           SUBB    A, #LEAD2         
0981            904                                    
0981 5002       905           JNC     ramp_thresh_ok2    
0983 7400       906           MOV     A, #00h           
0985            907   ramp_thresh_ok2:
0985 F559       908           MOV     THRESHOLD, A         
0987            909   
0987            910           ;if less than threshold turn power on 
0987 E535       911           MOV     A, TEMP          
0989 C3         912           CLR     C                 
098A 9559       913           SUBB    A, THRESHOLD         ; A = curren temp - threshold(target-lead)
098C            914                                    
098C 4004       915           JC      ramp_force_on2     ; If below threshold force on and return
098E            916   
098E 020995     917           ljmp     ramp_set_off2     
0991            918   
0991            919   
0991            920   ramp_done2:
0991 22         921           RET                      
0992            922   
0992            923   ramp_force_on2:
0992 D280       924           SETB p0.0      ;power on
0994 22         925           RET
0995            926   
0995            927   ramp_set_off2:
0995 C280       928           CLR p0.0
0997 22         929           RET 
0998            930   
0998            931   ;==============SPEAKER FUNCTIONS==============;
0998            932   
0998            933   BeepSpeaker:
0998 D28C       934       setb TR0
099A 7B07       935       mov R3, #7
099C            936   WaitLoop:
099C 12069A     937       lcall Wait50ms
099F DBFB       938       djnz R3, WaitLoop 
09A1            939   UnbeepSpeaker:
09A1 C28C       940       clr TR0
09A3 22         941       ret
09A4            942   
09A4            943   ;=============================================;
09A4            944   
09A4            945   FSM2_Temp_Time_display:
09A4            946       ;print time
09A4 C0E0       947            push acc
09A6 7401       947            mov a, #1
09A8 14         947            dec a
09A9 120217     947            lcall ?Set_Cursor_2 ; Select column and row
09AC D0E0       947            pop acc
09AE C083       948            push dph
09B0 C082       948            push dpl
09B2 C0E0       948            push acc
09B4 900171     948            mov dptr, #TimeLabel
09B7 12020C     948            lcall ?Send_Constant_String
09BA D0E0       948            pop acc
09BC D082       948            pop dpl
09BE D083       948            pop dph
09C0            949   
09C0 853A5B     950       mov x+0, TIME+0
09C3 853B5C     951       mov x+1, TIME+1
09C6 755D00     952       mov x+2, #0
09C9 755E00     953       mov x+3, #0
09CC 120234     954       lcall hex2bcd
09CF            955   
09CF C0E0       956            push acc
09D1 7406       956            mov a, #6
09D3 14         956            dec a
09D4 120217     956            lcall ?Set_Cursor_2 ; Select column and row
09D7 D0E0       956            pop acc
09D9 C000       957            push ar0
09DB A864       957            mov r0, bcd+1
09DD 12021E     957            lcall ?Display_BCD
09E0 D000       957            pop ar0
09E2 C000       958            push ar0
09E4 A863       958            mov r0, bcd+0
09E6 12021E     958            lcall ?Display_BCD
09E9 D000       958            pop ar0
09EB            959       ;print temp
09EB C0E0       960            push acc
09ED 740A       960            mov a, #10
09EF 14         960            dec a
09F0 120217     960            lcall ?Set_Cursor_2 ; Select column and row
09F3 D0E0       960            pop acc
09F5 C083       961            push dph
09F7 C082       961            push dpl
09F9 C0E0       961            push acc
09FB 900177     961            mov dptr, #TempLabel
09FE 12020C     961            lcall ?Send_Constant_String
0A01 D0E0       961            pop acc
0A03 D082       961            pop dpl
0A05 D083       961            pop dph
0A07            962   
0A07 85355B     963       mov x+0, TEMP+0
0A0A 85365C     964       mov x+1, TEMP+1
0A0D 755D00     965       mov x+2, #0
0A10 755E00     966       mov x+3, #0
0A13 120234     967       lcall hex2bcd
0A16            968   
0A16 C0E0       969            push acc
0A18 740D       969            mov a, #16-3
0A1A 14         969            dec a
0A1B 120217     969            lcall ?Set_Cursor_2 ; Select column and row
0A1E D0E0       969            pop acc      
0A20 C000       970            push ar0
0A22 A864       970            mov r0, bcd+1
0A24 12021E     970            lcall ?Display_BCD
0A27 D000       970            pop ar0
0A29 C000       971            push ar0
0A2B A863       971            mov r0, bcd+0
0A2D 12021E     971            lcall ?Display_BCD
0A30 D000       971            pop ar0
0A32 22         972       ret
0A33            973   
0A33            974   ;--- MAIN PROGRAM START ---
0A33            975   
0A33            976   ; **************************************** Initializations ***********************************************
0A33            977   
0A33            978   MAIN:
0A33 75817F     979       mov SP, #0x7F         ; Initialize Stack Pointer (Good practice)
0A36 120687     980       lcall INITIALIZE      ; intialize pins and adc, for now
0A39            981   
0A39 12058A     982       lcall Timer0_Init
0A3C 1205A6     983       lcall Timer2_Init
0A3F D2AF       984       setB EA ; Enable global interrupts
0A41 1201D9     985       lcall ELCD_4BIT ; Intialize LCD
0A44 120526     986       lcall InitSerialPort
0A47            987       
0A47 C202       988       clr seconds_flag
0A49 C200       989       clr START_FLAG
0A4B C205       990       clr KEYPAD_FLAG
0A4D C280       991       clr p0.0 ; Make sure oven is off to start
0A4F C28C       992       clr TR0 ; Start speaker off
0A51 E4         993       clr a
0A52            994   
0A52            995   
0A52 753000     996       mov STATE_VAR_1, #0x0000
0A55 753100     997       mov STATE_VAR_2, #0x0000
0A58 753A00     998       mov TIME, #0
0A5B 753500     999       mov TEMP, #0000
0A5E 753C00    1000       mov POWER, #0
0A61 753E3C    1001       mov DEGREES60, #60
0A64 754096    1002       mov DEGREES150, #150
0A67 7542DC    1003       mov DEGREES220, #220
0A6A 754400    1004       mov TARGET,       #0
0A6D           1005   
0A6D 756300    1006       mov bcd, #0x0000
0A70 755B00    1007       mov x+0, #0x0000
0A73 755C00    1008       mov x+1, #0x0000
0A76 755D00    1009       mov x+2, #0x0000
0A79 755E00    1010       mov x+3, #0x0000
0A7C           1011   
0A7C 754896    1012       mov soak_temp_set+0, #150
0A7F F549      1013       mov soak_temp_set+1, a
0A81           1014   
0A81 754A3C    1015       mov soak_time_set+0, #60
0A84 F54B      1016       mov soak_time_set+1, a
0A86           1017   
0A86 754CDC    1018       mov reflow_temp_set+0, #220
0A89 F54D      1019       mov reflow_temp_set+1, a
0A8B           1020   
0A8B 754E1E    1021       mov reflow_time_set+0, #30
0A8E F54F      1022       mov reflow_time_set+1, a
0A90           1023   
0A90           1024   
0A90           1025   MAIN_LOOP:
0A90           1026   
0A90           1027   ; **************************** Preset Settings **************************************
0A90           1028   
0A90           1029   ;StatePInit:
0A90           1030   ;    Set_Cursor(1,1)
0A90           1031   ;    Send_Constant_String ()
0A90           1032   
0A90           1033   
0A90           1034   
0A90           1035   
0A90           1036   
0A90           1037   PARAM_FSM:
0A90           1038   
0A90           1039   ; **************************** FSM for selecting parameters *************************
0A90           1040   
0A90           1041   ; 4 main states ->  A: select soak temp
0A90           1042   ;                   B: select soak time
0A90           1043   ;                   C: select reflow temp
0A90           1044   ;                   D: select reflow time
0A90           1045   ; move to other FSM when start button turns on start flag
0A90           1046   
0A90           1047   StateAInit:
0A90 C0E0      1048            push acc
0A92 7401      1048            mov a, #1
0A94 14        1048            dec a
0A95 120219    1048            lcall ?Set_Cursor_1 ; Select column and row
0A98 D0E0      1048            pop acc
0A9A C083      1049            push dph
0A9C C082      1049            push dpl
0A9E C0E0      1049            push acc
0AA0 900050    1049            mov dptr, #param_message
0AA3 12020C    1049            lcall ?Send_Constant_String
0AA6 D0E0      1049            pop acc
0AA8 D082      1049            pop dpl
0AAA D083      1049            pop dph
0AAC C0E0      1050            push acc
0AAE 7401      1050            mov a, #1
0AB0 14        1050            dec a
0AB1 120217    1050            lcall ?Set_Cursor_2 ; Select column and row
0AB4 D0E0      1050            pop acc
0AB6 C083      1051            push dph
0AB8 C082      1051            push dpl
0ABA C0E0      1051            push acc
0ABC 900061    1051            mov dptr, #soak_temp_message
0ABF 12020C    1051            lcall ?Send_Constant_String
0AC2 D0E0      1051            pop acc
0AC4 D082      1051            pop dpl
0AC6 D083      1051            pop dph
0AC8           1051   
0AC8           1052   
0AC8 C205      1053       clr KEYPAD_FLAG
0ACA 756B00    1054       mov keypad_digit_count, #0
0ACD           1055   
0ACD           1056   StateA:
0ACD 30B23E    1057       jnb RESET_BUTTON, StateA_ResetToMain
0AD0 E531      1058       mov a, STATE_VAR_2
0AD2 B4003C    1059       cjne a, #0, StateA_B
0AD5           1060   
0AD5 120916    1061       lcall Check_Select_Button_Press
0AD8 200339    1062       jb SELECT_BUTTON_FLAG, StateAtoDone
0ADB           1063   
0ADB 85485B    1064       mov x+0, soak_temp_set+0
0ADE 85495C    1065       mov x+1, soak_temp_set+1
0AE1 755D00    1066       mov x+2, #0
0AE4 755E00    1067       mov x+3, #0
0AE7 120234    1068       lcall hex2bcd
0AEA           1069   
0AEA C0E0      1070            push acc
0AEC 740C      1070            mov a, #12
0AEE 14        1070            dec a
0AEF 120217    1070            lcall ?Set_Cursor_2 ; Select column and row
0AF2 D0E0      1070            pop acc
0AF4 C000      1071            push ar0
0AF6 A864      1071            mov r0, bcd+1
0AF8 12021E    1071            lcall ?Display_BCD
0AFB D000      1071            pop ar0
0AFD C000      1072            push ar0
0AFF A863      1072            mov r0, bcd+0
0B01 12021E    1072            lcall ?Display_BCD
0B04 D000      1072            pop ar0
0B06           1073   
0B06 120925    1074       lcall Check_Param_Button_Press
0B09 20045B    1075       jb PARAM_BUTTON_FLAG, Inc_Soak_Temp
0B0C 8009      1076       sjmp StateA_Keypad
0B0E           1077   
0B0E           1078   StateA_ResetToMain:
0B0E 020A33    1079   ljmp MAIN   
0B11           1080   
0B11           1081   StateA_B:
0B11 020B9A    1082   ljmp StateBInit
0B14           1083   
0B14           1084   StateAtoDone:
0B14 020B8B    1085   ljmp StateADone
0B17           1086   
0B17           1087   StateA_Keypad:
0B17 1207A2    1088       lcall Keypad
0B1A 50B1      1089       jnc StateA
0B1C           1090   
0B1C 20050C    1091       jb KEYPAD_FLAG, StateA_Keypad_Continue
0B1F D205      1092       setb KEYPAD_FLAG
0B21           1093   
0B21 7400      1094       mov a, #0
0B23 F563      1095       mov bcd+0, a
0B25 F564      1096       mov bcd+1, a
0B27 F565      1097       mov bcd+2, a
0B29 F566      1098       mov bcd+3, a
0B2B           1099   
0B2B           1100   StateA_Keypad_Continue:
0B2B 12071D    1101       lcall Shift_Digits_Left
0B2E 509D      1102       jnc StateA
0B30           1103   
0B30 120281    1104       lcall bcd2hex
0B33           1105   
0B33 855B48    1106       mov soak_temp_set+0, x+0
0B36 855C49    1107       mov soak_temp_set+1, x+1
0B39           1108   
0B39 85485B    1109       mov x+0, soak_temp_set+0
0B3C 85495C    1110       mov x+1, soak_temp_set+1
0B3F 755D00    1111       mov x+2, #0
0B42 755E00    1112       mov x+3, #0
0B45 120234    1113       lcall hex2bcd
0B48           1114   
0B48 C0E0      1115            push acc
0B4A 740C      1115            mov a, #12
0B4C 14        1115            dec a
0B4D 120217    1115            lcall ?Set_Cursor_2 ; Select column and row
0B50 D0E0      1115            pop acc
0B52 C000      1116            push ar0
0B54 A864      1116            mov r0, bcd+1
0B56 12021E    1116            lcall ?Display_BCD
0B59 D000      1116            pop ar0
0B5B C000      1117            push ar0
0B5D A863      1117            mov r0, bcd+0
0B5F 12021E    1117            lcall ?Display_BCD
0B62 D000      1117            pop ar0
0B64           1118   
0B64 020ACD    1119       ljmp StateA
0B67           1120   
0B67           1121   
0B67           1122       Inc_Soak_Temp:
0B67 C204      1123           clr PARAM_BUTTON_FLAG
0B69           1124   
0B69 E548      1125           mov a, soak_temp_set
0B6B           1126   
0B6B 20E80B    1127           jb UPDOWN, Dec_Soak_Temp
0B6E 20E904    1128           jb TENS, Inc_Soak_Temp_Tens
0B71           1129   
0B71 2401      1130           add a, #1
0B73 8011      1131           sjmp Soak_Temp_Tens_Done
0B75           1132   
0B75           1133       Inc_Soak_Temp_Tens:
0B75 240A      1134           add a, #10
0B77 800D      1135           sjmp Soak_Temp_Tens_Done
0B79           1136   
0B79           1137       Dec_Soak_Temp:
0B79 20E905    1138           jb TENS, Dec_Soak_Temp_Tens
0B7C           1139   
0B7C C3        1140           clr c
0B7D 9401      1141           subb a, #1
0B7F 8005      1142           sjmp Soak_Temp_Tens_Done
0B81           1143   
0B81           1144       Dec_Soak_Temp_Tens:
0B81 C3        1145           clr c  
0B82 940A      1146           subb a, #10
0B84 8000      1147           sjmp Soak_Temp_Tens_Done
0B86           1148   
0B86           1149       Soak_Temp_Tens_Done:
0B86 F548      1150           mov soak_temp_set, a
0B88 020ACD    1151           ljmp StateA
0B8B           1152   
0B8B           1153   StateADone:
0B8B 120998    1154       lcall BeepSpeaker
0B8E 0531      1155       inc STATE_VAR_2
0B90 C203      1156       clr SELECT_BUTTON_FLAG
0B92 C205      1157       clr KEYPAD_FLAG
0B94 756B00    1158       mov keypad_digit_count, #0
0B97 020ACD    1159       ljmp StateA
0B9A           1160   
0B9A           1161   
0B9A           1162   StateBInit:
0B9A C0E0      1163            push acc
0B9C 7401      1163            mov a, #1
0B9E 14        1163            dec a
0B9F 120217    1163            lcall ?Set_Cursor_2 ; Select column and row
0BA2 D0E0      1163            pop acc
0BA4 C083      1164            push dph
0BA6 C082      1164            push dpl
0BA8 C0E0      1164            push acc
0BAA 900072    1164            mov dptr, #soak_time_message
0BAD 12020C    1164            lcall ?Send_Constant_String
0BB0 D0E0      1164            pop acc
0BB2 D082      1164            pop dpl
0BB4 D083      1164            pop dph
0BB6           1165   
0BB6           1166   StateB:
0BB6 30B236    1167       jnb RESET_BUTTON, StateB_ResetToMain
0BB9 E531      1168       mov a, STATE_VAR_2
0BBB B40134    1169       cjne a, #1, StateB_C
0BBE           1170   
0BBE 120916    1171       lcall Check_Select_Button_Press
0BC1 200331    1172       jb SELECT_BUTTON_FLAG, StateBtoDone
0BC4           1173   
0BC4 854A5B    1174       mov x+0, soak_time_set+0
0BC7 755C00    1175       mov x+1, #0
0BCA 755D00    1176       mov x+2, #0
0BCD 755E00    1177       mov x+3, #0
0BD0 120234    1178       lcall hex2bcd
0BD3           1179   
0BD3 C0E0      1180            push acc
0BD5 740C      1180            mov a, #12
0BD7 14        1180            dec a
0BD8 120217    1180            lcall ?Set_Cursor_2 ; Select column and row
0BDB D0E0      1180            pop acc
0BDD C000      1181            push ar0
0BDF A863      1181            mov r0, bcd+0
0BE1 12021E    1181            lcall ?Display_BCD
0BE4 D000      1181            pop ar0
0BE6           1182   
0BE6 120925    1183       lcall Check_Param_Button_Press
0BE9 200450    1184       jb PARAM_BUTTON_FLAG, Inc_Soak_Time
0BEC 020BF8    1185       ljmp StateB_Keypad
0BEF           1186   
0BEF           1187   StateB_ResetToMain:
0BEF 020A33    1188   ljmp MAIN
0BF2           1189   
0BF2           1190   StateB_C:
0BF2 020C6F    1191   ljmp StateCInit
0BF5           1192   
0BF5           1193   StateBtoDone:
0BF5 020C60    1194   ljmp StateBDone
0BF8           1195   
0BF8           1196   StateB_Keypad:
0BF8 1207A2    1197       lcall Keypad
0BFB 50B9      1198       jnc StateB
0BFD           1199   
0BFD 20050C    1200       jb KEYPAD_FLAG, StateB_Keypad_Continue
0C00 D205      1201       setb KEYPAD_FLAG
0C02           1202   
0C02 7400      1203       mov a, #0
0C04 F563      1204       mov bcd+0, a
0C06 F564      1205       mov bcd+1, a
0C08 F565      1206       mov bcd+2, a
0C0A F566      1207       mov bcd+3, a
0C0C           1208   
0C0C           1209   StateB_Keypad_Continue:
0C0C 12071D    1210       lcall Shift_Digits_Left
0C0F 50A5      1211       jnc StateB
0C11           1212   
0C11 120281    1213       lcall bcd2hex
0C14           1214   
0C14 855B4A    1215       mov soak_time_set+0, x+0
0C17           1216   
0C17 854A5B    1217       mov x+0, soak_time_set+0
0C1A 755C00    1218       mov x+1, #0
0C1D 755D00    1219       mov x+2, #0
0C20 755E00    1220       mov x+3, #0
0C23 120234    1221       lcall hex2bcd
0C26           1222   
0C26 C0E0      1223            push acc
0C28 740C      1223            mov a, #12
0C2A 14        1223            dec a
0C2B 120217    1223            lcall ?Set_Cursor_2 ; Select column and row
0C2E D0E0      1223            pop acc
0C30 C000      1224            push ar0
0C32 A863      1224            mov r0, bcd+0
0C34 12021E    1224            lcall ?Display_BCD
0C37 D000      1224            pop ar0
0C39           1225   
0C39 020BB6    1226       ljmp StateB
0C3C           1227   
0C3C           1228   
0C3C           1229       Inc_Soak_Time:
0C3C C204      1230           clr PARAM_BUTTON_FLAG
0C3E           1231   
0C3E E54A      1232           mov a, soak_time_set
0C40           1233   
0C40 20E80B    1234           jb UPDOWN, Dec_Soak_Time
0C43 20E904    1235           jb TENS, Inc_Soak_Time_Tens
0C46           1236   
0C46 2401      1237           add a, #1
0C48 8011      1238           sjmp Soak_Time_Tens_Done
0C4A           1239   
0C4A           1240       Inc_Soak_Time_Tens:
0C4A 240A      1241           add a, #10
0C4C 800D      1242           sjmp Soak_Time_Tens_Done
0C4E           1243   
0C4E           1244       Dec_Soak_Time:
0C4E 20E905    1245           jb TENS, Dec_Soak_Time_Tens
0C51 C3        1246           clr c
0C52           1247   
0C52 9401      1248           subb a, #1
0C54 8005      1249           sjmp Soak_Time_Tens_Done
0C56           1250   
0C56           1251       Dec_Soak_Time_Tens:
0C56 C3        1252           clr c
0C57           1253   
0C57 940A      1254           subb a, #10
0C59 8000      1255           sjmp Soak_Time_Tens_Done
0C5B           1256   
0C5B           1257       Soak_Time_Tens_Done:
0C5B F54A      1258           mov soak_time_set, a
0C5D 020BB6    1259           ljmp StateB
0C60           1260   
0C60           1261   StateBDone:
0C60 120998    1262       lcall BeepSpeaker
0C63 0531      1263       inc STATE_VAR_2
0C65 C203      1264       clr SELECT_BUTTON_FLAG
0C67 C205      1265       clr KEYPAD_FLAG
0C69 756B00    1266       mov keypad_digit_count, #0
0C6C 020BB6    1267       ljmp StateB
0C6F           1268   
0C6F           1269   
0C6F           1270   StateCInit:
0C6F C0E0      1271            push acc
0C71 7401      1271            mov a, #1
0C73 14        1271            dec a
0C74 120217    1271            lcall ?Set_Cursor_2 ; Select column and row
0C77 D0E0      1271            pop acc
0C79 C083      1272            push dph
0C7B C082      1272            push dpl
0C7D C0E0      1272            push acc
0C7F 900083    1272            mov dptr, #reflow_temp_message
0C82 12020C    1272            lcall ?Send_Constant_String
0C85 D0E0      1272            pop acc
0C87 D082      1272            pop dpl
0C89 D083      1272            pop dph
0C8B           1273   StateC:
0C8B 30B23F    1274       jnb RESET_BUTTON, StateC_ResetToMain
0C8E E531      1275       mov a, STATE_VAR_2
0C90 B4023D    1276       cjne a, #2, StateC_D
0C93           1277   
0C93 120916    1278       lcall Check_Select_Button_Press
0C96 20033A    1279       jb SELECT_BUTTON_FLAG, StateCtoDone
0C99           1280   
0C99 854C5B    1281       mov x+0, reflow_temp_set+0
0C9C 854D5C    1282       mov x+1, reflow_temp_set+1
0C9F 755D00    1283       mov x+2, #0x0000
0CA2 755E00    1284       mov x+3, #0x0000
0CA5           1285   
0CA5 120234    1286       lcall hex2bcd
0CA8           1287   
0CA8 C0E0      1288            push acc
0CAA 740C      1288            mov a, #12
0CAC 14        1288            dec a
0CAD 120217    1288            lcall ?Set_Cursor_2 ; Select column and row
0CB0 D0E0      1288            pop acc
0CB2 C000      1289            push ar0
0CB4 A864      1289            mov r0, bcd+1
0CB6 12021E    1289            lcall ?Display_BCD
0CB9 D000      1289            pop ar0
0CBB C000      1290            push ar0
0CBD A863      1290            mov r0, bcd+0
0CBF 12021E    1290            lcall ?Display_BCD
0CC2 D000      1290            pop ar0
0CC4           1291   
0CC4 120925    1292       lcall Check_Param_Button_Press
0CC7 20045C    1293       jb PARAM_BUTTON_FLAG, Inc_Reflow_Temp
0CCA 020CD6    1294       ljmp StateC_Keypad
0CCD           1295   
0CCD           1296   StateC_ResetToMain:
0CCD 020A33    1297   ljmp MAIN
0CD0           1298   
0CD0           1299   StateC_D:
0CD0 020D59    1300   ljmp StateDInit
0CD3           1301   
0CD3           1302   StateCtoDone:
0CD3 020D4A    1303   ljmp StateCDone
0CD6           1304   
0CD6           1305   StateC_Keypad:
0CD6 1207A2    1306       lcall Keypad
0CD9 50B0      1307       jnc StateC
0CDB           1308   
0CDB 20050C    1309       jb KEYPAD_FLAG, StateC_Keypad_Continue
0CDE D205      1310       setb KEYPAD_FLAG
0CE0           1311   
0CE0 7400      1312       mov a, #0
0CE2 F563      1313       mov bcd+0, a
0CE4 F564      1314       mov bcd+1, a
0CE6 F565      1315       mov bcd+2, a
0CE8 F566      1316       mov bcd+3, a
0CEA           1317   
0CEA           1318   StateC_Keypad_Continue:
0CEA 12071D    1319       lcall Shift_Digits_Left
0CED 509C      1320       jnc StateC
0CEF           1321   
0CEF 120281    1322       lcall bcd2hex
0CF2           1323   
0CF2 855B4C    1324       mov reflow_temp_set+0, x+0
0CF5 855C4D    1325       mov reflow_temp_set+1, x+1
0CF8           1326   
0CF8 854C5B    1327       mov x+0, reflow_temp_set+0
0CFB 854D5C    1328       mov x+1, reflow_temp_set+1
0CFE 755D00    1329       mov x+2, #0
0D01 755E00    1330       mov x+3, #0
0D04 120234    1331       lcall hex2bcd
0D07           1332   
0D07 C0E0      1333            push acc
0D09 740C      1333            mov a, #12
0D0B 14        1333            dec a
0D0C 120217    1333            lcall ?Set_Cursor_2 ; Select column and row
0D0F D0E0      1333            pop acc
0D11 C000      1334            push ar0
0D13 A864      1334            mov r0, bcd+1
0D15 12021E    1334            lcall ?Display_BCD
0D18 D000      1334            pop ar0
0D1A C000      1335            push ar0
0D1C A863      1335            mov r0, bcd+0
0D1E 12021E    1335            lcall ?Display_BCD
0D21 D000      1335            pop ar0
0D23           1336   
0D23 020C8B    1337       ljmp StateC
0D26           1338   
0D26           1339   
0D26           1340       Inc_Reflow_Temp:
0D26 C204      1341           clr PARAM_BUTTON_FLAG
0D28           1342   
0D28 E54C      1343           mov a, reflow_temp_set
0D2A           1344   
0D2A 20E80B    1345           jb UPDOWN, Dec_Reflow_Temp
0D2D 20E904    1346           jb TENS, Inc_Reflow_Temp_Tens
0D30           1347   
0D30 2401      1348           add a, #1
0D32 8011      1349           sjmp Reflow_Temp_Tens_Done
0D34           1350   
0D34           1351       Inc_Reflow_Temp_Tens:
0D34 240A      1352           add a, #10
0D36 800D      1353           sjmp Reflow_Temp_Tens_Done
0D38           1354   
0D38           1355       Dec_Reflow_Temp:
0D38 20E905    1356           jb TENS, Dec_Reflow_Temp_Tens
0D3B           1357   
0D3B C3        1358           clr c
0D3C 9401      1359           subb a, #1
0D3E 8005      1360           sjmp Reflow_Temp_Tens_Done
0D40           1361   
0D40           1362       Dec_Reflow_Temp_Tens:
0D40 C3        1363           clr c
0D41 940A      1364           subb a, #10
0D43 8000      1365           sjmp Reflow_Temp_Tens_Done
0D45           1366   
0D45           1367       Reflow_Temp_Tens_Done:
0D45 F54C      1368           mov reflow_temp_set, a
0D47 020C8B    1369           ljmp StateC
0D4A           1370   
0D4A           1371   StateCDone:
0D4A 120998    1372       lcall BeepSpeaker
0D4D 0531      1373       inc STATE_VAR_2
0D4F C203      1374       clr SELECT_BUTTON_FLAG
0D51 C205      1375       clr KEYPAD_FLAG
0D53 756B00    1376       mov keypad_digit_count, #0
0D56 020C8B    1377       ljmp StateC
0D59           1378   
0D59           1379   
0D59           1380   StateDInit:
0D59 C0E0      1381            push acc
0D5B 7401      1381            mov a, #1
0D5D 14        1381            dec a
0D5E 120217    1381            lcall ?Set_Cursor_2 ; Select column and row
0D61 D0E0      1381            pop acc
0D63 C083      1382            push dph
0D65 C082      1382            push dpl
0D67 C0E0      1382            push acc
0D69 900094    1382            mov dptr, #reflow_time_message
0D6C 12020C    1382            lcall ?Send_Constant_String
0D6F D0E0      1382            pop acc
0D71 D082      1382            pop dpl
0D73 D083      1382            pop dph
0D75           1383   
0D75           1384   StateD:
0D75 30B235    1385       jnb RESET_BUTTON, StateD_ResetToMain
0D78 E531      1386       mov a, STATE_VAR_2
0D7A B40333    1387       cjne a, #3, StateD_R
0D7D           1388   
0D7D 120916    1389       lcall Check_Select_Button_Press
0D80 200330    1390       jb SELECT_BUTTON_FLAG, StateDtoDone
0D83           1391   
0D83 854E5B    1392       mov x+0, reflow_time_set+0
0D86 755C00    1393       mov x+1, #0
0D89 755D00    1394       mov x+2, #0
0D8C 755E00    1395       mov x+3, #0
0D8F 120234    1396       lcall hex2bcd
0D92           1397   
0D92 C0E0      1398            push acc
0D94 740C      1398            mov a, #12
0D96 14        1398            dec a
0D97 120217    1398            lcall ?Set_Cursor_2 ; Select column and row
0D9A D0E0      1398            pop acc
0D9C C000      1399            push ar0
0D9E A863      1399            mov r0, bcd+0
0DA0 12021E    1399            lcall ?Display_BCD
0DA3 D000      1399            pop ar0
0DA5           1400   
0DA5 120925    1401       lcall Check_Param_Button_Press
0DA8 20044F    1402       jb PARAM_BUTTON_FLAG, Inc_Reflow_Time
0DAB 8009      1403       sjmp StateD_Keypad
0DAD           1404   
0DAD           1405   StateD_ResetToMain:
0DAD 020A33    1406   ljmp MAIN
0DB0           1407   
0DB0           1408   StateD_R:
0DB0 020E2D    1409   ljmp ReadyStateInit
0DB3           1410   
0DB3           1411   StateDtoDone:
0DB3 020E1E    1412   ljmp StateDDone
0DB6           1413   
0DB6           1414   StateD_Keypad:
0DB6 1207A2    1415       lcall Keypad 
0DB9 50BA      1416       jnc StateD
0DBB           1417   
0DBB 20050C    1418       jb KEYPAD_FLAG, StateD_Keypad_Continue
0DBE D205      1419       setb KEYPAD_FLAG
0DC0           1420   
0DC0 7400      1421       mov a, #0
0DC2 F563      1422       mov bcd+0, a
0DC4 F564      1423       mov bcd+1, a
0DC6 F565      1424       mov bcd+2, a
0DC8 F566      1425       mov bcd+3, a
0DCA           1426   
0DCA           1427   StateD_Keypad_Continue:
0DCA 12071D    1428       lcall Shift_Digits_Left
0DCD 50A6      1429       jnc StateD
0DCF           1430   
0DCF 120281    1431       lcall bcd2hex
0DD2           1432   
0DD2 855B4E    1433       mov reflow_time_set+0, x+0
0DD5           1434       ;mov reflow_time_set+1, x+1
0DD5           1435   
0DD5 854E5B    1436       mov x+0, reflow_time_set+0
0DD8 755C00    1437       mov x+1, #0
0DDB 755D00    1438       mov x+2, #0
0DDE 755E00    1439       mov x+3, #0
0DE1 120234    1440       lcall hex2bcd
0DE4           1441   
0DE4 C0E0      1442            push acc
0DE6 740C      1442            mov a, #12
0DE8 14        1442            dec a
0DE9 120217    1442            lcall ?Set_Cursor_2 ; Select column and row
0DEC D0E0      1442            pop acc
0DEE           1443       ;Display_BCD(bcd+1)
0DEE C000      1444            push ar0
0DF0 A863      1444            mov r0, bcd+0
0DF2 12021E    1444            lcall ?Display_BCD
0DF5 D000      1444            pop ar0
0DF7           1445   
0DF7 020D75    1446       ljmp StateD
0DFA           1447   
0DFA           1448   
0DFA           1449       Inc_Reflow_Time:        
0DFA C204      1450           clr PARAM_BUTTON_FLAG
0DFC E54E      1451           mov a, reflow_time_set
0DFE           1452   
0DFE 20E80B    1453           jb UPDOWN, Dec_Reflow_Time
0E01 20E904    1454           jb TENS, Inc_Reflow_Time_Tens
0E04           1455   
0E04 2401      1456           add a, #1
0E06 8011      1457           sjmp Reflow_Time_Tens_Done
0E08           1458   
0E08           1459       Inc_Reflow_Time_Tens:
0E08 240A      1460           add a, #10
0E0A 800D      1461           sjmp Reflow_Time_Tens_Done
0E0C           1462   
0E0C           1463       Dec_Reflow_Time:
0E0C 20E905    1464           jb TENS, Dec_Reflow_Time_Tens
0E0F           1465   
0E0F C3        1466           clr c
0E10 9401      1467           subb a, #1
0E12 8005      1468           sjmp Reflow_Time_Tens_Done
0E14           1469   
0E14           1470       Dec_Reflow_Time_Tens:
0E14 C3        1471           clr c
0E15 940A      1472           subb a, #10
0E17 8000      1473           sjmp Reflow_Time_Tens_Done
0E19           1474   
0E19           1475       Reflow_Time_Tens_Done:
0E19 F54E      1476           mov reflow_time_set, a
0E1B 020D75    1477           ljmp StateD
0E1E           1478   
0E1E           1479   StateDDone:
0E1E 120998    1480       lcall BeepSpeaker
0E21 0531      1481       inc STATE_VAR_2
0E23 C203      1482       clr SELECT_BUTTON_FLAG
0E25 C205      1483       clr KEYPAD_FLAG
0E27 756B00    1484       mov keypad_digit_count, #0
0E2A 020D75    1485       ljmp StateD
0E2D           1486   
0E2D           1487   
0E2D           1488   ReadyStateInit:
0E2D C0E0      1489            push acc
0E2F 7401      1489            mov a, #1
0E31 14        1489            dec a
0E32 120219    1489            lcall ?Set_Cursor_1 ; Select column and row
0E35 D0E0      1489            pop acc
0E37 C083      1490            push dph
0E39 C082      1490            push dpl
0E3B C0E0      1490            push acc
0E3D 9000A5    1490            mov dptr, #ready_message
0E40 12020C    1490            lcall ?Send_Constant_String
0E43 D0E0      1490            pop acc
0E45 D082      1490            pop dpl
0E47 D083      1490            pop dph
0E49 C0E0      1491            push acc
0E4B 7401      1491            mov a, #1
0E4D 14        1491            dec a
0E4E 120217    1491            lcall ?Set_Cursor_2 ; Select column and row
0E51 D0E0      1491            pop acc
0E53 C083      1492            push dph
0E55 C082      1492            push dpl
0E57 C0E0      1492            push acc
0E59 90002E    1492            mov dptr, #blank_row
0E5C 12020C    1492            lcall ?Send_Constant_String
0E5F D0E0      1492            pop acc
0E61 D082      1492            pop dpl
0E63 D083      1492            pop dph
0E65           1493   
0E65           1494   ReadyState:
0E65           1495       ;jnb seconds_flag, skipSerial_0 *** not too sure what this does
0E65           1496   
0E65           1497   skipSerial_0:
0E65 20B5FD    1498       jb START_BUTTON, ReadyState
0E68 12069A    1499       lcall wait50ms
0E6B 20B5F7    1500       jb START_BUTTON, ReadyState
0E6E           1501   
0E6E C0E0      1502            push acc
0E70 7401      1502            mov a, #1
0E72 14        1502            dec a
0E73 120219    1502            lcall ?Set_Cursor_1 ; Select column and row
0E76 D0E0      1502            pop acc
0E78 C083      1503            push dph
0E7A C082      1503            push dpl
0E7C C0E0      1503            push acc
0E7E 9000B6    1503            mov dptr, #state0_message
0E81 12020C    1503            lcall ?Send_Constant_String
0E84 D0E0      1503            pop acc
0E86 D082      1503            pop dpl
0E88 D083      1503            pop dph
0E8A           1504   
0E8A D200      1505       setb START_FLAG
0E8C           1506       
0E8C 8000      1507       sjmp State0
0E8E           1508   
0E8E           1509   ;==================Reflow Profile FSM==================;
0E8E           1510   ;Checklist:
0E8E           1511   ; 1. Implement TEMP and TIME variables - DONE
0E8E           1512   ; 2. Implement FSM outputs - DONE
0E8E           1513   ; 3. Implement reset logic - DONE
0E8E           1514   ; 4. Implement abort condition - DONE
0E8E           1515   ; 5. Implement LCD Feedback for Each State - Tentatively Done (Still not tested)
0E8E           1516   ; 6. Speaker beeps for state transitions - DONE
0E8E           1517   ;*Abort condition needs to be in state 1* - FIXED
0E8E           1518   ; 7. Rewrite State Transitions with SUBB - DONE
0E8E           1519   State0:
0E8E 30B70C    1520       jnb STOP_BUTTON, State0_StopReflow
0E91 C280      1521       CLR p0.0 ;oven off
0E93 E530      1522       mov a, STATE_VAR_1
0E95 B40015    1523       cjne a, #0, State1
0E98 200005    1524       jb START_FLAG, State0Done
0E9B 80F1      1525       sjmp State0
0E9D           1526   
0E9D           1527   State0_StopReflow:
0E9D 021094    1528   ljmp StopReflow
0EA0           1529   
0EA0           1530   State0Done:
0EA0 120998    1531       lcall BeepSpeaker
0EA3 0530      1532       inc STATE_VAR_1
0EA5 753C64    1533       mov POWER, #100
0EA8 753A00    1534       mov TIME, #0
0EAB 80E1      1535       sjmp State0
0EAD           1536   State1:
0EAD 30B237    1537       jnb RESET_BUTTON, State1_ResetToMain
0EB0 30B737    1538       jnb STOP_BUTTON, State1_StopReflow
0EB3 E530      1539       mov a, STATE_VAR_1
0EB5 B40148    1540       cjne a, #1, State2
0EB8 C0E0      1541            push acc
0EBA 7401      1541            mov a, #1
0EBC 14        1541            dec a
0EBD 120219    1541            lcall ?Set_Cursor_1 ; Select column and row
0EC0 D0E0      1541            pop acc
0EC2 C083      1542            push dph
0EC4 C082      1542            push dpl
0EC6 C0E0      1542            push acc
0EC8 9000C7    1542            mov dptr, #state1_message
0ECB 12020C    1542            lcall ?Send_Constant_String
0ECE D0E0      1542            pop acc
0ED0 D082      1542            pop dpl
0ED2 D083      1542            pop dph
0ED4 1209A4    1543       lcall FSM2_Temp_Time_display
0ED7 120F4B    1544       lcall CheckAbortCondition ;Must abort if 50 degrees isn't reached in first 60 seconds
0EDA           1545   
0EDA 854844    1546       mov TARGET, SOAK_TEMP_set
0EDD E535      1547       mov a, TEMP
0EDF C3        1548       clr c
0EE0 9544      1549       subb a, TARGET
0EE2 4009      1550       jc CheckCarryState1 ; C = 1, Keep heating
0EE4 020EF3    1551       ljmp GreaterThanState1 ; C = 0, Transition States
0EE7           1552   
0EE7           1553   State1_ResetToMain:
0EE7 02108B    1554   ljmp ResetToMain
0EEA           1555   
0EEA           1556   State1_StopReflow:
0EEA 021094    1557   ljmp StopReflow
0EED           1558   
0EED           1559   CheckCarryState1:
0EED 4002      1560       jc LessThanState1
0EEF 8002      1561       sjmp GreaterThanState1
0EF1           1562   LessThanState1:
0EF1 80BA      1563       sjmp State1
0EF3           1564   GreaterThanState1:
0EF3 120998    1565       lcall BeepSpeaker
0EF6 0530      1566       inc STATE_VAR_1
0EF8 753C14    1567       mov POWER, #20
0EFB 753A00    1568       mov TIME, #0
0EFE 80AD      1569       sjmp State1
0F00           1570   State2:
0F00 30B237    1571       jnb RESET_BUTTON, State2_ResetToMain
0F03 30B737    1572       jnb STOP_BUTTON, State2_StopReflow
0F06 E530      1573       mov a, STATE_VAR_1
0F08 B4022C    1574       cjne a, #2, State2_State3
0F0B C0E0      1575            push acc
0F0D 7401      1575            mov a, #1
0F0F 14        1575            dec a
0F10 120219    1575            lcall ?Set_Cursor_1 ; Select column and row
0F13 D0E0      1575            pop acc
0F15 C083      1576            push dph
0F17 C082      1576            push dpl
0F19 C0E0      1576            push acc
0F1B 9000D8    1576            mov dptr, #state2_message
0F1E 12020C    1576            lcall ?Send_Constant_String
0F21 D0E0      1576            pop acc
0F23 D082      1576            pop dpl
0F25 D083      1576            pop dph
0F27 1209A4    1577       lcall FSM2_Temp_Time_display
0F2A 854A46    1578       mov TARGET_TIME, SOAK_TIME_set
0F2D E53A      1579       mov a, TIME
0F2F C3        1580       clr c
0F30 9546      1581       subb a, TARGET_TIME
0F32 4020      1582       jc CheckCarryState2 ; C = 1, TIME < TARGET_TIME
0F34 020F5A    1583       ljmp GreaterThanState2 ; C = 0, TIME > TARGET_TIME -> transition states
0F37           1584   
0F37           1585   State2_State3:
0F37 020F65    1586       ljmp State3
0F3A           1587   
0F3A           1588   State2_ResetToMain:
0F3A 02108B    1589   ljmp ResetToMain
0F3D           1590   
0F3D           1591   State2_StopReflow:
0F3D 021094    1592   ljmp StopReflow
0F40           1593   
0F40           1594   State1_CheckOven:
0F40 E53A      1595   mov a, TIME
0F42 B43C00    1596   cjne a, #60, State1TimeCheckCarry
0F45           1597   
0F45           1598   State1TimeCheckCarry:
0F45 4003      1599   jc TrampolineState1 ; 60 Seconds haven't passed
0F47 0210D3    1600   ljmp STOPOVEN
0F4A           1601   
0F4A           1602   TrampolineState1:
0F4A 22        1603   ret
0F4B           1604   
0F4B           1605   CheckAbortCondition:
0F4B E535      1606       mov a, TEMP
0F4D B43201    1607       cjne a, #50, CheckAbortCarry
0F50 22        1608       ret
0F51           1609   CheckAbortCarry:
0F51 40ED      1610       jc State1_CheckOven          
0F53 22        1611       ret
0F54           1612   CheckCarryState2:
0F54 4002      1613       jc LessThanState2
0F56 8002      1614       sjmp GreaterThanState2
0F58           1615   LessThanState2:
0F58 80A6      1616       sjmp State2
0F5A           1617   GreaterThanState2:
0F5A 120998    1618       lcall BeepSpeaker
0F5D 0530      1619       inc STATE_VAR_1
0F5F 753C64    1620       mov POWER, #100
0F62 020F00    1621       ljmp State2
0F65           1622   State3:
0F65 30B234    1623       jnb RESET_BUTTON, State3_ResetToMain
0F68 30B734    1624       jnb STOP_BUTTON, State3_StopReflow
0F6B E530      1625       mov a, STATE_VAR_1
0F6D B40345    1626       cjne a, #3, State4
0F70 C0E0      1627            push acc
0F72 7401      1627            mov a, #1
0F74 14        1627            dec a
0F75 120219    1627            lcall ?Set_Cursor_1 ; Select column and row
0F78 D0E0      1627            pop acc
0F7A C083      1628            push dph
0F7C C082      1628            push dpl
0F7E C0E0      1628            push acc
0F80 9000E9    1628            mov dptr, #state3_message
0F83 12020C    1628            lcall ?Send_Constant_String
0F86 D0E0      1628            pop acc
0F88 D082      1628            pop dpl
0F8A D083      1628            pop dph
0F8C 1209A4    1629       lcall FSM2_Temp_Time_display
0F8F 854C44    1630       mov TARGET, reflow_temp_set
0F92 E535      1631       mov a, TEMP
0F94 C3        1632       clr c
0F95 9544      1633       subb a, TARGET
0F97 4009      1634       jc CheckCarryState3 ; C = 1, TEMP < TARGET -> Keep Heating
0F99 020FA8    1635       ljmp GreaterThanState3 ; C = 0, TEMP > TARGET -> Transition States    
0F9C           1636   
0F9C           1637   State3_ResetToMain:
0F9C 02108B    1638   ljmp ResetToMain
0F9F           1639   
0F9F           1640   State3_StopReflow:
0F9F 021094    1641   ljmp StopReflow
0FA2           1642   
0FA2           1643   CheckCarryState3:
0FA2 4002      1644       jc LessThanState3
0FA4 8002      1645       sjmp GreaterThanState3
0FA6           1646   LessThanState3:
0FA6 80BD      1647       sjmp State3
0FA8           1648   GreaterThanState3:
0FA8 120998    1649       lcall BeepSpeaker
0FAB 0530      1650       inc STATE_VAR_1
0FAD 753C14    1651       mov POWER, #20
0FB0 753A00    1652       mov TIME, #0
0FB3 80B0      1653       sjmp State3
0FB5           1654   State4:
0FB5 30B237    1655       jnb RESET_BUTTON, ResetToMainState4
0FB8 30B731    1656       jnb STOP_BUTTON, StopReflowState4
0FBB E530      1657       mov a, STATE_VAR_1
0FBD B40442    1658       cjne a, #4, State5
0FC0 C0E0      1659            push acc
0FC2 7401      1659            mov a, #1
0FC4 14        1659            dec a
0FC5 120219    1659            lcall ?Set_Cursor_1 ; Select column and row
0FC8 D0E0      1659            pop acc
0FCA C083      1660            push dph
0FCC C082      1660            push dpl
0FCE C0E0      1660            push acc
0FD0 9000FA    1660            mov dptr, #state4_message
0FD3 12020C    1660            lcall ?Send_Constant_String
0FD6 D0E0      1660            pop acc
0FD8 D082      1660            pop dpl
0FDA D083      1660            pop dph
0FDC 1209A4    1661       lcall FSM2_Temp_Time_display
0FDF 854E46    1662       mov TARGET_TIME, REFLOW_TIME_set
0FE2 E53A      1663       mov a, TIME
0FE4 C3        1664       clr c
0FE5 9546      1665       subb a, TARGET_TIME
0FE7 4009      1666       jc CheckCarryState4 ; C = 1, TIME < TARGET_TIME -> Keep Going
0FE9 020FF8    1667       ljmp GreaterThanState4 ; C = 0, TIME > TARGET_TIME -> Transition States
0FEC           1668   StopReflowState4:
0FEC 021094    1669       ljmp StopReflow
0FEF           1670   ResetToMainState4:
0FEF 02108B    1671       ljmp ResetToMain
0FF2           1672   CheckCarryState4:
0FF2 4002      1673       jc LessThanState4
0FF4 8002      1674       sjmp GreaterThanState4
0FF6           1675   LessThanState4:
0FF6 80BD      1676       sjmp State4 
0FF8           1677   GreaterThanState4:
0FF8 120998    1678       lcall BeepSpeaker
0FFB 0530      1679       inc STATE_VAR_1
0FFD 753C00    1680       mov POWER, #0
1000 80B3      1681       sjmp State4
1002           1682   State5:
1002 30B233    1683       jnb RESET_BUTTON, ResetToMainState5
1005 30B733    1684       jnb STOP_BUTTON, StopReflowState5
1008 C280      1685       CLR p0.0 ;turn oven off
100A E530      1686       mov a, STATE_VAR_1    
100C B4052F    1687       cjne a, #5, State5toDone
100F 853E44    1688       mov TARGET, DEGREES60
1012 E535      1689       mov a, TEMP
1014 C0E0      1690            push acc
1016 7401      1690            mov a, #1
1018 14        1690            dec a
1019 120219    1690            lcall ?Set_Cursor_1 ; Select column and row
101C D0E0      1690            pop acc
101E C083      1691            push dph
1020 C082      1691            push dpl
1022 C0E0      1691            push acc
1024 90010B    1691            mov dptr, #state5_message
1027 12020C    1691            lcall ?Send_Constant_String
102A D0E0      1691            pop acc
102C D082      1691            pop dpl
102E D083      1691            pop dph
1030 1209A4    1692       lcall FSM2_Temp_Time_display
1033 B43C46    1693       cjne a, #60, CheckCarryState5
1036 80CA      1694       sjmp State5
1038           1695   
1038           1696   ResetToMainState5:
1038 02108B    1697       ljmp ResetToMain
103B           1698   
103B           1699   StopReflowState5:
103B 021094    1700       ljmp StopReflow
103E           1701       
103E           1702   State5toDone:
103E 120998    1703       lcall BeepSpeaker
1041 C0E0      1704            push acc
1043 7401      1704            mov a, #1
1045 14        1704            dec a
1046 120219    1704            lcall ?Set_Cursor_1 ; Select column and row
1049 D0E0      1704            pop acc
104B C083      1705            push dph
104D C082      1705            push dpl
104F C0E0      1705            push acc
1051 90013E    1705            mov dptr, #reflowdone_message
1054 12020C    1705            lcall ?Send_Constant_String
1057 D0E0      1705            pop acc
1059 D082      1705            pop dpl
105B D083      1705            pop dph
105D C0E0      1706            push acc
105F 7401      1706            mov a, #1
1061 14        1706            dec a
1062 120217    1706            lcall ?Set_Cursor_2 ; Select column and row
1065 D0E0      1706            pop acc
1067 C083      1707            push dph
1069 C082      1707            push dpl
106B C0E0      1707            push acc
106D 90014F    1707            mov dptr, #restart_message
1070 12020C    1707            lcall ?Send_Constant_String
1073 D0E0      1707            pop acc
1075 D082      1707            pop dpl
1077 D083      1707            pop dph
1079 021129    1708       ljmp ReflowDone
107C           1709   
107C           1710   CheckCarryState5:
107C 4002      1711       jc LessThanState5
107E 8008      1712       sjmp GreaterThanState5
1080           1713   LessThanState5:
1080 753000    1714       mov STATE_VAR_1, #0
1083 C200      1715       clr START_FLAG
1085 021002    1716       ljmp State5
1088           1717   GreaterThanState5:
1088 021002    1718       ljmp State5
108B           1719   
108B           1720   ResetToMain:
108B 753000    1721       mov STATE_VAR_1, #0
108E 753C00    1722       mov POWER, #0
1091 020A33    1723       ljmp MAIN
1094           1724   
1094           1725   StopReflow:
1094 C0E0      1726            push acc
1096 7401      1726            mov a, #1
1098 14        1726            dec a
1099 120219    1726            lcall ?Set_Cursor_1 ; Select column and row
109C D0E0      1726            pop acc
109E C083      1727            push dph
10A0 C082      1727            push dpl
10A2 C0E0      1727            push acc
10A4 900160    1727            mov dptr, #stop_message
10A7 12020C    1727            lcall ?Send_Constant_String
10AA D0E0      1727            pop acc
10AC D082      1727            pop dpl
10AE D083      1727            pop dph
10B0 C0E0      1728            push acc
10B2 7401      1728            mov a, #1
10B4 14        1728            dec a
10B5 120217    1728            lcall ?Set_Cursor_2 ; Select column and row
10B8 D0E0      1728            pop acc
10BA C083      1729            push dph
10BC C082      1729            push dpl
10BE C0E0      1729            push acc
10C0 90014F    1729            mov dptr, #restart_message
10C3 12020C    1729            lcall ?Send_Constant_String
10C6 D0E0      1729            pop acc
10C8 D082      1729            pop dpl
10CA D083      1729            pop dph
10CC C280      1730       clr P0.0 ; Turn power off
10CE           1731   ForeverStopped:
10CE 30B255    1732       jnb RESET_BUTTON, RestartProcess
10D1 80FB      1733       sjmp ForeverStopped
10D3           1734   
10D3           1735   STOPOVEN:
10D3 C0E0      1736            push acc
10D5 7401      1736            mov a, #1
10D7 14        1736            dec a
10D8 120219    1736            lcall ?Set_Cursor_1 ; Select column and row
10DB D0E0      1736            pop acc
10DD C083      1737            push dph
10DF C082      1737            push dpl
10E1 C0E0      1737            push acc
10E3 90011C    1737            mov dptr, #abortcondition_message
10E6 12020C    1737            lcall ?Send_Constant_String
10E9 D0E0      1737            pop acc
10EB D082      1737            pop dpl
10ED D083      1737            pop dph
10EF C0E0      1738            push acc
10F1 7401      1738            mov a, #1
10F3 14        1738            dec a
10F4 120217    1738            lcall ?Set_Cursor_2 ; Select column and row
10F7 D0E0      1738            pop acc
10F9 C083      1739            push dph
10FB C082      1739            push dpl
10FD C0E0      1739            push acc
10FF 90014F    1739            mov dptr, #restart_message
1102 12020C    1739            lcall ?Send_Constant_String
1105 D0E0      1739            pop acc
1107 D082      1739            pop dpl
1109 D083      1739            pop dph
110B 7C0A      1740       mov R4, #10
110D           1741   STOPOVENSpeakerLoop:
110D 120998    1742       lcall BeepSpeaker
1110 12069A    1743       lcall Wait50ms
1113 12069A    1744       lcall Wait50ms
1116 12069A    1745       lcall Wait50ms
1119 12069A    1746       lcall Wait50ms
111C 12069A    1747       lcall Wait50ms
111F DCEC      1748       djnz R4, STOPOVENSpeakerLoop
1121           1749   ForeverStop:
1121 30B202    1750       jnb RESET_BUTTON, RestartProcess
1124 80FB      1751       sjmp ForeverStop ; Infinite loop to stop the oven if abort condition is met
1126           1752   
1126           1753   RestartProcess:
1126 020A33    1754       ljmp MAIN
1129           1755       
1129           1756   ReflowDone:
1129 7C05      1757       mov R4, #5
112B           1758   SpeakerLoop:
112B 120998    1759       lcall BeepSpeaker
112E 12069A    1760       lcall Wait50ms
1131 12069A    1761       lcall Wait50ms
1134 12069A    1762       lcall Wait50ms
1137 12069A    1763       lcall Wait50ms
113A 12069A    1764       lcall Wait50ms
113D DCEC      1765       djnz R4, SpeakerLoop
113F           1766   Forever:
113F 30B202    1767       jnb RESET_BUTTON, ForeverToMain
1142 80FB      1768       sjmp Forever
1144           1769   ForeverToMain:
1144 02108B    1770            ljmp ResetToMain
1147           1771   END
