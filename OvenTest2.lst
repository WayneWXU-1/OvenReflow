                  2   $LIST
0000              4   
0000              5   CLK           EQU 33333333 ; Microcontroller system crystal frequency in Hz
0000              6   TIMER0_RATE   EQU 4096     ; 2048Hz squarewave (peak amplitude of CEM-1203 speaker)
0000              7   TIMER0_RELOAD EQU ((65536-(CLK/(12*TIMER0_RATE)))) ; The prescaler in the CV-8052 is always 12 unlike the N76E003 where is selectable.
0000              8   TIMER2_RATE   EQU 1000     ; 1000Hz, for a timer tick of 1ms
0000              9   TIMER2_RELOAD EQU ((65536-(CLK/(12*TIMER2_RATE))))
0000             10   BAND          EQU 2 ;for flat states
0000             11   
0000             12   WINDOW      EQU 6     ; burst window length in seconds 
0000             13   
0000             14   BAUD   EQU 57600
0000             15   T1_LOAD EQU 256-(2*CLK) / (32*12*BAUD) ;Load 253 so it counts 3 counts before overflowing, which gives us a 57600 baud rate with a 33.333MHz clock
0000             16   
0000             17   
0000             18   ; ********* Buttons ***********
0000             19   SELECT_BUTTON equ P3_4 ; middle
0000             20   RESET_BUTTON  equ P3_2 ; left
0000             21   START_BUTTON  equ P3_5 ; middle right
0000             22   STOP_BUTTON   equ P3_7 ; right 
0000             23   PARAM_BUTTON  equ P3_3 ; middle left
0000             24   
0000             25   OVEN_PIN      equ P0_0
0000             26   SOUND_OUT     equ P1_5 ; Speaker attached to this pin
0000             27   UPDOWN        equ SWA_0
0000             28   TENS          equ SWA_1
0000             29   PRESET1_SW     equ SWA_7
0000             30   PRESET2_SW     equ SWA_6
0000             31   PRESET3_SW     equ SWA_5
0000             32   PRESET4_SW     equ SWA_4
0000             33   RED_LED       equ P1_0
0000             34   GREEN_LED     equ P3_1
0000             35   
0000             36   ; Reset vector
0000             37   org 0x0000
0000 020AFF      38       ljmp MAIN
0003             39   
0003             40   ; External interrupt 0 vector (not used in this code)
0003             41   org 0x0003
0003 32          42            reti
0004             43   
0004             44   ; Timer/Counter 0 overflow interrupt vector
000B             45   org 0x000B
000B 0205D0      46            ljmp Timer0_ISR
000E             47   
000E             48   ; External interrupt 1 vector (not used in this code)
0013             49   org 0x0013
0013 32          50            reti
0014             51   
0014             52   ; Timer/Counter 1 overflow interrupt vector (not used in this code)
001B             53   org 0x001B
001B 32          54            reti
001C             55   
001C             56   ; Serial port receive/transmit interrupt vector (not used in this code)
0023             57   org 0x0023 
0023 32          58            reti
0024             59            
0024             60   ; Timer/Counter 2 overflow interrupt vector
002B             61   org 0x002B
002B 0205F6      62            ljmp Timer2_ISR
002E             63   
002E             64   
002E             65   ;--- DATA RAM ---
0030             66   dseg at 0x30
0030             67   STATE_VAR_1:     DS 1 
0031             68   STATE_VAR_2:     DS 1
0032             69   SECOND_COUNTER:  DS 1 
0033             70   TEMP_HIGH_BYTE:  DS 1 
0034             71   TEMP_LOW_BYTE:   DS 1 
0035             72   
0035             73   ;---------ADC RELATED-----;
0035             74   ADCREFH:                  DS 1
0036             75   ADCREFL:         DS 1
0037             76   LM335H:          DS 1
0038             77   LM335L:          DS 1
0039             78   TCH:                      DS 1
003A             79   TCL:                      DS 1
003B             80   TH_H:            DS 1
003C             81   TH_L:            DS 1
003D             82   ;----------------------
003D             83   TEMP:            DS 5
0042             84   TIME:            DS 2
0044             85   POWER:           DS 2
0046             86   DEGREES60:       DS 2
0048             87   DEGREES150:      DS 2
004A             88   DEGREES220:      DS 2
004C             89   TARGET:          DS 2
004E             90   TARGET_TIME:     DS 2
0050             91   ;*** Variables ***
0050             92   SOAK_TEMP_set:       ds 2
0052             93   SOAK_TIME_set:       ds 2
0054             94   reflow_temp_set:     ds 2
0056             95   REFLOW_TIME_set:     ds 2
0058             96   
0058             97   soak_time:       ds 2
005A             98   REFLOW_TIME:     ds 2
005C             99   
005C            100   beep_count:      ds 1
005D            101   
005D            102   ; PWM variables
005D            103   LOW_LIMIT:  ds 2
005F            104   HIGH_LIMIT: ds 2
0061            105   THRESHOLD:  ds 2
0063            106   ON_SECS:     ds 1
0064            107   PHASE:       ds 1    ;counter for seconds
0065            108   LEAD:        ds 2 ;for ramp sates
0067            109   
0067            110   x:               ds      4 ;used for 32 bit math for temperature conversion
006B            111   y:               ds      4 ;used for 32 bit math for temperature conversion
006F            112   bcd:    ds  5 ; <--- ADD THIS: math32 needs 5 bytes for BCD conversions
0074            113   
0074            114   ;--ISR RELATED--;
0074            115   Count1ms:     ds 2 ; Used to determine when one second has passed
0076            116   Counter20ms:  ds 1 ; Counts 1ms ticks for 20ms flag
0077            117   Counter50ms:  ds 1 ; Counts 1ms ticks for 50ms flag
0078            118   BCD_counter:  ds 1 ; The BCD counter incrememted in the ISR and displayed in the main loop
0079            119   current_state: ds 1 ; For non-blocking FSM: which state to run next loop iteration
007A            120   
007A            121   ; **** keypad variables ****
007A            122   keypad_digit_count: ds 1
007B            123   
0000            124   bseg
0000            125   START_FLAG:         DBIT 1  ; Use DBIT for single bits in bseg
0001            126   half_seconds_flag:  DBIT 1  ; half second flag
0002            127   SECONDS_FLAG:       DBIT 1  ; one second passed - run 1s tasks in main
0003            128   flag_20ms:          DBIT 1  ; set every 20ms - e.g. run Calculate_ADC in main
0004            129   flag_50ms:          DBIT 1  ; set every 50ms - e.g. run display updates in main
0005            130   SELECT_BUTTON_FLAG: DBIT 1
0006            131   PARAM_BUTTON_FLAG:  DBIT 1
0007            132   KEYPAD_FLAG:        DBIT 1
0008            133   mf:     dbit 1 ; <--- ADD THIS: math32 uses this as a status flag
0009            134   
002E            135   cseg
002E            136   ; These 'equ' must match the hardware wiring
002E            137   ; None of these are implemented yet, we need to match these assignments to the wiring
002E            138   ELCD_RS equ P1.7
002E            139   ;LCD_RW equ PX.X ; Not used in this code, connect the pin to GND
002E            140   ELCD_E equ  P1.1
002E            141   ELCD_D4 equ P0.7
002E            142   ELCD_D5 equ P0.5
002E            143   ELCD_D6 equ P0.3
002E            144   ELCD_D7 equ P0.1
002E            145   
002E            146   ;Keypad pin assignments
002E            147   ROW1 EQU P1.2
002E            148   ROW2 EQU P1.4
002E            149   ROW3 EQU P1.6
002E            150   ROW4 EQU P2.0
002E            151   COL1 EQU P2.2
002E            152   COL2 EQU P2.4
002E            153   COL3 EQU P2.6
002E            154   COL4 EQU P3.0
002E            155   
002E            156   ; Non-blocking FSM state indices (dispatch from MAIN_LOOP)
002E            157   ST_PINIT     EQU 0
002E            158   ST_P         EQU 1
002E            159   ST_P1D       EQU 2
002E            160   ST_P2D       EQU 3
002E            161   ST_P3D       EQU 4
002E            162   ST_P4D       EQU 5
002E            163   ST_READY     EQU 6
002E            164   ST_READY_WAIT EQU 7
002E            165   ST_0         EQU 8
002E            166   ST_1         EQU 9
002E            167   ST_2         EQU 10
002E            168   ST_3         EQU 11
002E            169   ST_4         EQU 12
002E            170   ST_5         EQU 13
002E            171   
002E            172   ;                           1234567890123456
002E 20202020   173   blank_row:              db '                ', 0
     20202020
     20202020
     20202020
     00
003F 50726573   174   preset_message:         db 'Presets: 1 2 3 4', 0
     6574733A
     20312032
     20332034
     00
0050 53454C45   175   stop_to_skip_message:   db 'SELECT to skip. ', 0
     43542074
     6F20736B
     69702E20
     00
0061 73544D50   176   preset_param_message1:  db 'sTMP:xxx sTME:xx', 0
     3A787878
     2073544D
     453A7878
     00
0072 72544D50   177   preset_param_message2:  db 'rTMP:xxx rTME:xx', 0
     3A787878
     2072544D
     453A7878
     00
0083 53656C65   178   param_message:          db 'Select Parameter', 0
     63742050
     6172616D
     65746572
     00
0094 536F616B   179   soak_temp_message:      db 'Soak Temp: xxx C', 0
     2054656D
     703A2078
     78782043
     00
00A5 536F616B   180   soak_time_message:      db 'Soak Time: xx  s', 0
     2054696D
     653A2078
     78202073
     00
00B6 52666C77   181   reflow_temp_message:    db 'Rflw Temp: xxx C', 0
     2054656D
     703A2078
     78782043
     00
00C7 52666C77   182   reflow_time_message:    db 'Rflw Time: xx  s', 0
     2054696D
     653A2078
     78202073
     00
00D8 52656164   183   ready_message:          db 'Ready to Start! ', 0
     7920746F
     20537461
     72742120
     00
00E9 2D2D2D2D   184   state0_message:         db '-----State0-----', 0
     2D537461
     7465302D
     2D2D2D2D
     00
00FA 3D3D5261   185   state1_message:         db '==Ramp To Soak==', 0
     6D702054
     6F20536F
     616B3D3D
     00
010B 3D3D3D3D   186   state2_message:         db '======Soak======', 0
     3D3D536F
     616B3D3D
     3D3D3D3D
     00
011C 3D3D5261   187   state3_message:         db '==Ramp To Peak==', 0
     6D702054
     6F205065
     616B3D3D
     00
012D 3D3D3D3D   188   state4_message:         db '=====Reflow=====', 0
     3D526566
     6C6F773D
     3D3D3D3D
     00
013E 3D3D3D3D   189   state5_message:         db '====Cooling!====', 0
     436F6F6C
     696E6721
     3D3D3D3D
     00
014F 2A2A2A2A   190   abortcondition_message: db '*****ABORT!*****', 0
     2A41424F
     5254212A
     2A2A2A2A
     00
0160 54494D45   191   reflow_message:         db 'TIME:XXXTEMP:XXX', 0
     3A585858
     54454D50
     3A585858
     00
0171 5265666C   192   reflowdone_message:     db 'Reflow Complete!', 0
     6F772043
     6F6D706C
     65746521
     00
0182 52535420   193   restart_message:        db 'RST 2 Bake Again', 0
     32204261
     6B652041
     6761696E
     00
0193            194   
0193 5265666C   195   stop_message:           db 'Reflow Stopped! ', 0
     6F772053
     746F7070
     65642120
     00
01A4            196   
01A4 54494D45   197   TimeLabel: db 'T','I','M','E',':', 0
     3A00
01AA 54454D50   198   TempLabel: db 'T','E','M','P',':', 0
     3A00
01B0            199   
                201   	$LIST
0267            203   
                614   $LIST
                206   $LIST
0559            208   
0559            209   ;-----------------------INTIALIZE SERIAL PORT FOR INPUT OUTUUT-----------------------;
0559            210   ;--Setting baud rate to 57600 with 33.33MHz clock--;
0559            211   ;-----------EXPLANATION------------
0559            212   ;Crystal oscillates at 33.33Mhz, the CV-8052 has a fixed prescaler of 12 for timers
0559            213   ;So the effective clock for timers is 33.33MHz/12 = 2.7775MHzl
0559            214   ;SMOD is set to 1 in PCON so using 1/16th the clock for baud rate generation
0559            215   ;That means the baud rate clock is 2.7775MHz/16 = 173.611kHz
0559            216   ;Since we have 253 out of 256 its three clicks 
0559            217   ;per bit, the baud rate is 173.611kHz/3 = 57.870kbps which is close enough to 57600bps
0559            218   ;-----------------------------------
0559            219   
0559            220   InitSerialPort:
0559            221            ; Configure serial port and baud rate
0559 C28E       222       clr TR1 ; Disable timer 1
055B E589       223       mov a, TMOD
055D 540F       224       anl a, #0x0f ; Clear the bits for timer 1
055F 4420       225       orl a, #0x20 ; Configure timer 1 as 8-bit autoreload
0561 F589       226       mov TMOD, a ; Set timer 1 mode
0563            227   
0563 758DFD     228       mov TH1, #T1_LOAD ; Load the timer value for the desired baud rate
0566 758BFD     229       mov TL1, #T1_LOAD ;Doesnt matter what we load in TL1 because it is in autoreload mode, but we need to load it with something to prevent it from overflowing immediately
0569            230       ;Leave it as you found it, make SMOD = 1 for double baud rate
0569 E587       231       mov a, PCON ; Set SMOD to 1
056B 4480       232       orl a, #0x80
056D F587       233       mov PCON, a
056F D28E       234       setb TR1 ; Enable timer 1
0571 759852     235       mov SCON, #01010010B ; Mode 1, 8-bit UART, enable receiver
0574 22         236            ret
0575            237   
0575            238   Display_Voltage_Serial:
0575 853D67     239            mov x+0, TEMP+0 ; reloads the temp into x which will be converted to bcd
0578 853E68     240       mov x+1, TEMP+1
057B 756900     241       mov x+2, #0
057E 756A00     242       mov x+3, #0
0581 120267     243       lcall hex2bcd ; standard math32.asm function
0584            244       
0584 7454       245            mov a, #'T'
0586 1205B5     246            lcall putchar
0589 743D       247            mov a, #'='
058B 1205B5     248            lcall putchar
058E            249            
058E E570       250            mov a, bcd+1
0590 540F       251            anl a, #0FH
0592 4430       252            orl a, #'0'
0594 1205B5     253            lcall putchar
0597            254   
0597 E56F       255            mov a, bcd+0
0599 C4         256            swap a
059A 540F       257            anl a, #0FH
059C 4430       258            orl a, #'0'
059E 1205B5     259            lcall putchar
05A1            260            
05A1 E56F       261            mov a, bcd+0
05A3 540F       262            anl a, #0FH
05A5 4430       263            orl a, #'0'
05A7 1205B5     264            lcall putchar
05AA            265   
05AA 740D       266            mov a, #'\r'
05AC 1205B5     267            lcall putchar
05AF 740A       268            mov a, #'\n'
05B1 1205B5     269            lcall putchar
05B4            270            
05B4 22         271            ret
05B5            272   
05B5            273   
05B5            274   
05B5            275   ; Function to stransmit accumulator value into the serial buffer register after previous completion
05B5            276   putchar:
05B5 3099FD     277       jnb TI, putchar ; TI is the transmit interrupt, it will loop until it is high and we know the previous bit is sent
05B8            278       
05B8 C299       279       clr TI  ; Reset back to 0 to indicate we are transmitting 
05BA F599       280       mov SBUF, a ; accumulator will have output chharacter already stored on it
05BC 22         281       ret
05BD            282   
05BD            283   
05BD            284   ; ******************************* TIMER ISRS ************************************
05BD            285   
05BD            286   Timer0_Init:
05BD E589       287            mov a, TMOD
05BF 54F0       288            anl a, #0xf0 ; Clear the bits for timer 0
05C1 4401       289            orl a, #0x01 ; Configure timer 0 as 16-timer
05C3 F589       290            mov TMOD, a
05C5 758CFD     291            mov TH0, #high(TIMER0_RELOAD)
05C8 758A5A     292            mov TL0, #low(TIMER0_RELOAD)
05CB            293            ; Enable the timer and interrupts
05CB D2A9       294       setb ET0  ; Enable timer 0 interrupt
05CD D28C       295       setb TR0  ; Start timer 0
05CF 22         296            ret
05D0            297   
05D0            298   ;---------------------------------;
05D0            299   ; ISR for timer 0.  Set to execute;
05D0            300   ; every 1/4096Hz to generate a    ;
05D0            301   ; 2048 Hz square wave at pin P1.5 ;
05D0            302   ;---------------------------------;
05D0            303   Timer0_ISR:
05D0            304            ;clr TF0  ; According to the data sheet this is done for us already.
05D0 758CFD     305            mov TH0, #high(TIMER0_RELOAD) ; Timer 0 doesn't have autoreload in the CV-8052
05D3 758A5A     306            mov TL0, #low(TIMER0_RELOAD)
05D6 B295       307            cpl SOUND_OUT ; Connect speaker to P1.5
05D8 32         308            reti
05D9            309   
05D9            310   ;---------------------------------;
05D9            311   ; Routine to initialize the ISR   ;
05D9            312   ; for timer 2                     ;
05D9            313   ;---------------------------------;
05D9            314   Timer2_Init:
05D9 75C800     315            mov T2CON, #0 ; Stop timer/counter.  Autoreload mode.
05DC 75CDF5     316            mov TH2, #high(TIMER2_RELOAD)
05DF 75CC27     317            mov TL2, #low(TIMER2_RELOAD)
05E2            318            ; Set the reload value
05E2 75CBF5     319            mov RCAP2H, #high(TIMER2_RELOAD)
05E5 75CA27     320            mov RCAP2L, #low(TIMER2_RELOAD)
05E8            321            ; Init One millisecond interrupt counter.  It is a 16-bit variable made with two 8-bit parts
05E8 E4         322            clr a
05E9 F574       323            mov Count1ms+0, a
05EB F575       324            mov Count1ms+1, a
05ED F576       325            mov Counter20ms, a
05EF F577       326            mov Counter50ms, a
05F1            327            ; Enable the timer and interrupts
05F1 D2AD       328       setb ET2  ; Enable timer 2 interrupt
05F3 D2CA       329       setb TR2  ; Enable timer 2
05F5 22         330            ret
05F6            331   
05F6            332   ;---------------------------------;
05F6            333   ; ISR for timer 2 (1 ms tick)     ;
05F6            334   ; LIGHT ISR: only counters + flags ;
05F6            335   ; (no ADC, no LCD, no math) to    ;
05F6            336   ; avoid race conditions. Temp read ;
05F6            337   ; and all heavy work in main.     ;
05F6            338   ;---------------------------------;
05F6            339   Timer2_ISR:
05F6 C2CF       340            clr TF2  ; Timer 2 doesn't clear TF2 automatically. Do it in ISR
05F8 C0E0       341            push acc
05FA C0D0       342            push psw
05FC            343   
05FC            344            ; Increment 16-bit 1 ms counter
05FC 0574       345            inc Count1ms+0
05FE E574       346            mov a, Count1ms+0
0600 7002       347            jnz Timer2_ISR_inc_done
0602 0575       348            inc Count1ms+1
0604            349   Timer2_ISR_inc_done:
0604            350   
0604            351            ; 20 ms flag: increment counter, set flag every 20 ms
0604 0576       352            inc Counter20ms
0606 E576       353            mov a, Counter20ms
0608 B41405     354            cjne a, #20, Timer2_ISR_check_50
060B E4         355            clr a
060C F576       356            mov Counter20ms, a
060E D203       357            setb flag_20ms
0610            358   
0610            359   Timer2_ISR_check_50:
0610            360            ; 50 ms flag: increment counter, set flag every 50 ms
0610 0577       361            inc Counter50ms
0612 E577       362            mov a, Counter50ms
0614 B43205     363            cjne a, #50, Timer2_ISR_check_1s
0617 E4         364            clr a
0618 F577       365            mov Counter50ms, a
061A D204       366            setb flag_50ms
061C            367   
061C            368   Timer2_ISR_check_1s:
061C            369            ; 1 second: reset Count1ms and set seconds_flag (main runs OneSecond_Tasks)
061C E574       370            mov a, Count1ms+0
061E B4E80C     371            cjne a, #low(1000), Timer2_ISR_done
0621 E575       372            mov a, Count1ms+1
0623 B40307     373            cjne a, #high(1000), Timer2_ISR_done
0626 E4         374            clr a
0627 F574       375            mov Count1ms+0, a
0629 F575       376            mov Count1ms+1, a
062B D202       377            setb seconds_flag
062D            378   
062D            379   Timer2_ISR_done:
062D D0D0       380            pop psw
062F D0E0       381            pop acc
0631 32         382            reti
0632            383   
0632            384   ;---------------------------------;
0632            385   ; Run from main when flag_20ms set ;
0632            386   ;---------------------------------;
0632            387   Calculate_ADC:
0632 7402       388            mov a, #00000010b ; voltage reference port 2
0634 F5A1       389            mov ADC_C, a
0636 120767     390            lcall Wait50ms
0639 120851     391            lcall Wait25ms
063C E5A3       392            mov a, ADC_H
063E 540F       393            anl a, #0x0F
0640 F535       394            mov ADCREFH, a
0642 85A236     395            mov ADCREFL, ADC_L
0645 7401       396            mov a, #0x01 ; port for lm335
0647 F5A1       397            mov ADC_C, a
0649 120767     398            lcall Wait50ms
064C 120851     399            lcall Wait25ms
064F E5A3       400            mov a, ADC_H
0651 540F       401            anl a, #0x0F
0653 F537       402            mov LM335H, a
0655 85A238     403            mov LM335L, ADC_L
0658 756A00     404            mov x+3, #0
065B 756900     405            mov x+2, #0
065E 853768     406            mov x+1, LM335H
0661 853867     407            mov x+0, LM335L
0664 756B00     408            mov y+0, #low (4096 % 0x10000) 
0667 756C10     408            mov y+1, #high(4096 % 0x10000) 
066A 756D00     408            mov y+2, #low (4096 / 0x10000) 
066D 756E00     408            mov y+3, #high(4096 / 0x10000) 
0670            408   
0670 1203C5     409            lcall mul32
0673 756E00     410            mov y+3, #0
0676 756D00     411            mov y+2, #0
0679 85356C     412            mov y+1, ADCREFH
067C 85366B     413            mov y+0, ADCREFL
067F 1204B9     414            lcall div32
0682 756BAA     415            mov y+0, #low (2730 % 0x10000) 
0685 756C0A     415            mov y+1, #high(2730 % 0x10000) 
0688 756D00     415            mov y+2, #low (2730 / 0x10000) 
068B 756E00     415            mov y+3, #high(2730 / 0x10000) 
068E 12032F     416            lcall sub32
0691 756B0A     417            mov y+0, #low (10 % 0x10000) 
0694 756C00     417            mov y+1, #high(10 % 0x10000) 
0697 756D00     417            mov y+2, #low (10 / 0x10000) 
069A 756E00     417            mov y+3, #high(10 / 0x10000) 
069D 1204B9     418            lcall div32
06A0 856839     419            mov TCH, x+1
06A3 85673A     420            mov TCL, x+0
06A6 7400       421            mov a, #0x00
06A8 F5A1       422            mov ADC_C, a
06AA 120767     423            lcall Wait50ms
06AD 120851     424            lcall Wait25ms
06B0 E5A3       425            mov a, ADC_H
06B2 540F       426            anl a, #0x0F
06B4 756A00     427            mov x+3, #0
06B7 756900     428            mov x+2, #0
06BA F568       429            mov x+1, a
06BC 85A267     430            mov x+0, ADC_L
06BF 756B4D     431            mov y+0, #low (333 % 0x10000) 
06C2 756C01     431            mov y+1, #high(333 % 0x10000) 
06C5 756D00     431            mov y+2, #low (333 / 0x10000) 
06C8 756E00     431            mov y+3, #high(333 / 0x10000) 
06CB 1203C5     432            lcall mul32
06CE 756E00     433            mov y+3, #0
06D1 756D00     434            mov y+2, #0
06D4 85356C     435            mov y+1, ADCREFH
06D7 85366B     436            mov y+0, ADCREFL
06DA 1204B9     437            lcall div32
06DD 85683B     438            mov TH_H, x+1
06E0 85673C     439            mov TH_L, x+0
06E3 756E00     440            mov y+3, #0
06E6 756D00     441            mov y+2, #0
06E9 85396C     442            mov y+1, TCH
06EC 853A6B     443            mov y+0, TCL
06EF 12030C     444            lcall add32
06F2 85673D     445            mov TEMP+0, x+0
06F5 85683E     446            mov TEMP+1, x+1
06F8 22         447            ret
06F9            448   
06F9            449   ;---------------------------------;
06F9            450   ; Run from main when seconds_flag set ;
06F9            451   ;---------------------------------;
06F9            452   OneSecond_Tasks:
06F9 0542       453            inc TIME
06FB B2E8       454            cpl LEDRA.0
06FD            455            ; PWM based on state
06FD E530       456            mov a, STATE_VAR_1
06FF B40105     457            cjne a, #1, OS_Not_State_1
0702 120A2C     458            lcall RampBurstPWM
0705 8016       459            sjmp OS_PWM_Exit
0707            460   OS_Not_State_1:
0707 B40305     461            cjne a, #3, OS_Not_State_3
070A 120A2C     462            lcall RampBurstPWM
070D 800E       463            sjmp OS_PWM_Exit
070F            464   OS_Not_State_3:
070F B40205     465            cjne a, #2, OS_Not_State_2
0712 120A00     466            lcall pwm_for_flatstates
0715 8006       467            sjmp OS_PWM_Exit
0717            468   OS_Not_State_2:
0717 B40403     469            cjne a, #4, OS_PWM_Exit
071A 120A00     470            lcall pwm_for_flatstates
071D            471   OS_PWM_Exit:
071D            472            ; BCD counter
071D E578       473            mov a, BCD_counter
071F 20E804     474            jb UPDOWN, OS_BCD_decrement
0722 2401       475            add a, #0x01
0724 8002       476            sjmp OS_BCD_da
0726            477   OS_BCD_decrement:
0726 2499       478            add a, #0x99
0728            479   OS_BCD_da:
0728 D4         480            da a
0729 F578       481            mov BCD_counter, a
072B 22         482            ret
072C            483   
072C            484   ; Call from state loops to service timer flags (20ms, 50ms, 1s)
072C            485   Service_Timer_Flags:
072C 200307     486            jb flag_20ms, STF_20
072F 20040C     487            jb flag_50ms, STF_50
0732 200214     488            jb seconds_flag, STF_1s
0735 22         489            ret
0736            490   STF_20:
0736 C203       491            clr flag_20ms
0738 120632     492            lcall Calculate_ADC
073B 02072C     493            ljmp Service_Timer_Flags
073E            494   STF_50:
073E C204       495            clr flag_50ms
0740 120575     496            lcall Display_Voltage_Serial
0743 12099A     497            lcall Display_BCD_7_seg
0746 02072C     498            ljmp Service_Timer_Flags
0749            499   STF_1s:
0749 C202       500            clr seconds_flag
074B 1206F9     501            lcall OneSecond_Tasks
074E 02072C     502            ljmp Service_Timer_Flags
0751            503   
0751            504   INITIALIZE:
0751            505   
0751 759AAB     506            mov P0MOD, #10101011b ; P0.0(OVEN_PIN), P0.1, P0.3, P0.5, P0.7(LCD) are outputs. 
0754 759BF7     507       mov P1MOD, #11110111b ; P1.7, P1.5, P1.1(LCD), 1.2, 1.4, 1.6(ROW) are outputs, P1.0
0757 759C01     508       mov P2MOD, #00000001b ; output: 2.0(ROW) input: 2.2, 2.4, 2.6(COL)
075A 759D02     509       mov P3MOD, #00000010b ; input: 3.0 (COL), 3.2, 3.3, 3.4, 3.5, 3.7 out: 3.1
075D            510       ; for keypad, (ROWS as output-1)1.2, 1.4, 1.6, 2.0 - (COLS as input-0) 2.2, 2.4, 2.6, 3.0
075D 12085E     511       lcall Configure_Keypad_Pins
0760 75A100     512       mov ADC_C, #0x00      ; Select ADC Channel 0
0763 75A180     513       mov ADC_C, #10000000b ; ADC Enable = 1 test******
0766 22         514       ret                   ; Added RET so it doesn't crash after initializing
0767            515   
0767            516   ; ************************** FUNCTIONS ***********************************
0767            517   
0767            518   Wait50ms:
0767            519   ;33.33MHz, 1 clk per cycle: 0.03us
0767 781E       520            mov R0, #30
0769            521   Wait50ms_L3:
0769 794A       522            mov R1, #74
076B            523   Wait50ms_L2:
076B 7AFA       524            mov R2, #250
076D            525   Wait50ms_L1:
076D DAFE       526            djnz R2, Wait50ms_L1 ;3*250*0.03us=22.5us
076F D9FA       527       djnz R1, Wait50ms_L2 ;74*22.5us=1.665ms
0771 D8F6       528       djnz R0, Wait50ms_L3 ;1.665ms*30=50ms
0773 22         529       ret
0774            530   
0774            531   
0774            532   ; **************************** KEYPAD *******************************
0774            533   
0774            534   myLUT:
0774 C0F9A4B0   535       DB 0xC0, 0xF9, 0xA4, 0xB0, 0x99        ; 0 TO 4
     99
0779 9282F880   536       DB 0x92, 0x82, 0xF8, 0x80, 0x90        ; 4 TO 9
     90
077E 8883C6A1   537       DB 0x88, 0x83, 0xC6, 0xA1, 0x86, 0x8E  ; A to F
     868E
0784            538   
                539   showBCD MAC
                540   	; Display LSD
                541       mov A, %0
                542       anl a, #0fh
                543       movc A, @A+dptr
                544       mov %1, A
                545   
                546   	; Display MSD
                547       mov A, %0
                548       swap a
                549       anl a, #0fh
                550       movc A, @A+dptr
                551       mov %2, A
                552   ENDMAC
0784            553   
0784            554   Display:
0784 900774     555            mov dptr, #myLUT
                555   	$MESSAGE TIP: If digits 10, 9, 8, and 7 are not zero, LEDR7: on
0787            557   
0787 E572       558            mov a, bcd+3
0789 4573       559            orl a, bcd+4
078B 6004       560            jz Display_L1
078D D2EF       561            setb LEDRA.7 ; Non-zero digits alert
078F 8002       562            sjmp Display_L2
0791            563   
0791            564   Display_L1:
0791 C2EF       565            clr LEDRA.7
0793            566   
0793            567   Display_L2:
                567   	$MESSAGE TIP: Pressing KEY3, displays the most significant digits of the 10-digit number
0793            569   
0793 30FB2F     570            jnb key.3, Display_high_digits
0796            571            ; Display LSD
0796 E56F       571       mov A, bcd+0
0798 540F       571       anl a, #0fh
079A 93         571       movc A, @A+dptr
079B F591       571       mov HEX0, A
079D            571   
079D            571            ; Display MSD
079D E56F       571       mov A, bcd+0
079F C4         571       swap a
07A0 540F       571       anl a, #0fh
07A2 93         571       movc A, @A+dptr
07A3 F592       571       mov HEX1, A
07A5            572            ; Display LSD
07A5 E570       572       mov A, bcd+1
07A7 540F       572       anl a, #0fh
07A9 93         572       movc A, @A+dptr
07AA F593       572       mov HEX2, A
07AC            572   
07AC            572            ; Display MSD
07AC E570       572       mov A, bcd+1
07AE C4         572       swap a
07AF 540F       572       anl a, #0fh
07B1 93         572       movc A, @A+dptr
07B2 F594       572       mov HEX3, A
07B4            573            ; Display LSD
07B4 E571       573       mov A, bcd+2
07B6 540F       573       anl a, #0fh
07B8 93         573       movc A, @A+dptr
07B9 F58E       573       mov HEX4, A
07BB            573   
07BB            573            ; Display MSD
07BB E571       573       mov A, bcd+2
07BD C4         573       swap a
07BE 540F       573       anl a, #0fh
07C0 93         573       movc A, @A+dptr
07C1 F58F       573       mov HEX5, A
07C3            574   
07C3 8024       575            sjmp Display_end
07C5            576   
07C5            577   Display_high_digits:
07C5            578            ; Display LSD
07C5 E572       578       mov A, bcd+3
07C7 540F       578       anl a, #0fh
07C9 93         578       movc A, @A+dptr
07CA F591       578       mov HEX0, A
07CC            578   
07CC            578            ; Display MSD
07CC E572       578       mov A, bcd+3
07CE C4         578       swap a
07CF 540F       578       anl a, #0fh
07D1 93         578       movc A, @A+dptr
07D2 F592       578       mov HEX1, A
07D4            579            ; Display LSD
07D4 E573       579       mov A, bcd+4
07D6 540F       579       anl a, #0fh
07D8 93         579       movc A, @A+dptr
07D9 F593       579       mov HEX2, A
07DB            579   
07DB            579            ; Display MSD
07DB E573       579       mov A, bcd+4
07DD C4         579       swap a
07DE 540F       579       anl a, #0fh
07E0 93         579       movc A, @A+dptr
07E1 F594       579       mov HEX3, A
07E3 758EFF     580            mov HEX4, #0xff         
07E6 758FFF     581            mov HEX5, #0xff         
07E9            582   
07E9            583   Display_end:
07E9 22         584       ret
07EA            585   
07EA            586   
                587   MYRLC MAC
                588   	mov a, %0
                589   	rlc a
                590   	mov %0, a
                591   ENDMAC
07EA            592   
07EA            593   Shift_Digits_Left:
07EA 7804       594            mov R0, #4 ; shift left four bits
07EC            595   
07EC E531       596       mov a, STATE_VAR_2
07EE B40006     597       cjne a, #0, KCheck_StateC
07F1            598   
07F1 E57A       599       mov a, keypad_digit_count
07F3 B40310     600       cjne a, #3, Shift_Digits_Left_L0
07F6            601   
07F6 22         602       ret
07F7            603   
07F7            604   KCheck_StateC:
07F7 B40206     605       cjne a, #2, KCheck_Time_States
07FA E57A       606       mov a, keypad_digit_count
07FC B40307     607       cjne a, #3, Shift_Digits_Left_L0
07FF 22         608       ret
0800            609   
0800            610   KCheck_Time_States:
0800 E57A       611       mov a, keypad_digit_count
0802 B40201     612       cjne a, #2, Shift_Digits_Left_L0
0805 22         613       ret
0806            614   
0806            615   Shift_Digits_Left_L0:
0806 C3         616            clr c
0807 E56F       617            mov a, bcd+0
0809 33         617            rlc a
080A F56F       617            mov bcd+0, a
080C E570       618            mov a, bcd+1
080E 33         618            rlc a
080F F570       618            mov bcd+1, a
0811 E571       619            mov a, bcd+2
0813 33         619            rlc a
0814 F571       619            mov bcd+2, a
0816 E572       620            mov a, bcd+3
0818 33         620            rlc a
0819 F572       620            mov bcd+3, a
081B E573       621            mov a, bcd+4
081D 33         621            rlc a
081E F573       621            mov bcd+4, a
0820            622   
0820 D8E4       623            djnz R0, Shift_Digits_Left_L0
0822            624            ; R7 has the new bcd digit      
0822 EF         625            mov a, R7
0823 456F       626            orl a, bcd+0
0825 F56F       627            mov bcd+0, a
0827            628   
0827 057A       629       inc keypad_digit_count
0829 D3         630       setb c
082A            631       
082A            632   Shift_Digits_left_exit:
082A 22         633            ret
082B            634   
082B            635            
                636   MYRRC MAC
                637   	mov a, %0
                638   	rrc a
                639   	mov %0, a
                640   ENDMAC
082B            641   
082B            642   Shift_Digits_Right:
082B 7804       643            mov R0, #4 ; shift right four bits
082D            644   
082D            645   Shift_Digits_Right_L0:
082D C3         646            clr c
082E E573       647            mov a, bcd+4
0830 13         647            rrc a
0831 F573       647            mov bcd+4, a
0833 E572       648            mov a, bcd+3
0835 13         648            rrc a
0836 F572       648            mov bcd+3, a
0838 E571       649            mov a, bcd+2
083A 13         649            rrc a
083B F571       649            mov bcd+2, a
083D E570       650            mov a, bcd+1
083F 13         650            rrc a
0840 F570       650            mov bcd+1, a
0842 E56F       651            mov a, bcd+0
0844 13         651            rrc a
0845 F56F       651            mov bcd+0, a
0847            652   
0847 D8E4       653            djnz R0, Shift_Digits_Right_L0
0849            654   
0849 E57A       655       mov a, keypad_digit_count
084B 6003       656       jz Shift_Digits_Right_Ret
084D 157A       657       dec keypad_digit_count
084F            658   
084F D3         659       setb c
0850            660   
0850            661   Shift_Digits_Right_Ret:
0850 22         662            ret
0851            663   
0851            664   
0851            665   Wait25ms:
0851            666   ;33.33MHz, 1 clk per cycle: 0.03us
0851 780F       667            mov R0, #15
0853 794A       668   LL3: mov R1, #74
0855 7AFA       669   LL2: mov R2, #250
0857 DAFE       670   LL1: djnz R2, LL1 ;3*250*0.03us=22.5us
0859 D9FA       671        djnz R1, LL2 ;74*22.5us=1.665ms
085B D8F6       672        djnz R0, LL3 ;1.665ms*15=25ms
085D            673   
085D 22         674       ret
085E            675   
085E            676   
085E            677   
                678   CHECK_COLUMN MAC
                679   	jb %0, CHECK_COL_%M
                680   	mov R7, %1
                681   	jnb %0, $ ; wait for key release
                682   	setb c
                683   	ret
                684   CHECK_COL_%M:
                685   ENDMAC
085E            686   
085E            687   Configure_Keypad_Pins:
085E            688            ; Configure the row pins as output and the column pins as inputs
085E 439B54     689            orl P1MOD, #0b_01010100 ; P1.6, P1.4, P1.2 output
0861 439C01     690            orl P2MOD, #0b_00000001 ; P2.0 output
0864 539CAB     691            anl P2MOD, #0b_10101011 ; P2.6, P2.4, P2.2 input
0867 539DFE     692            anl P3MOD, #0b_11111110 ; P3.0 input
086A 22         693            ret
086B            694   
086B            695   ; This subroutine scans a 4x4 keypad.  If a key is pressed sets the carry
086B            696   ; to one and returns the key code in register R7.
086B            697   ; It works with both a default keypad or a modified keypad with the labels
086B            698   ; rotated 90 deg ccw.  The type of keypad is determined by SW0, which is bit SWA.0
086B            699   
086B            700   Keypad:
086B            701            ; First check the backspace/correction pushbutton.  We use KEY1 for this function.
                701   	$MESSAGE TIP: STOP_BUTTON is the erase key
086B            703   
086B 20B73F     704            jb STOP_BUTTON, keypad_L0
086E 120851     705            lcall Wait25ms ; debounce
0871 20B739     706            jb STOP_BUTTON, keypad_L0
0874            707   
0874 30B7FD     708            jnb STOP_BUTTON, $ ; The key was pressed, wait for release
0877 12082B     709            lcall Shift_Digits_Right
087A 1202B4     710       lcall bcd2hex
087D            711   
087D E531       712       mov a, STATE_VAR_2
087F B40008     713       cjne a, #0, check_delete_b
0882            714   
0882 856750     715       mov soak_temp_set+0, x+0
0885 856851     716       mov soak_temp_set+1, x+1
0888 8021       717       sjmp delete_done
088A            718   
088A            719   check_delete_b:
088A B40108     720       cjne a, #1, check_delete_c
088D            721   
088D 856752     722       mov soak_time_set+0, x+0
0890 856853     723       mov soak_time_set+1, x+1
0893 8016       724       sjmp delete_done
0895            725   
0895            726   check_delete_c:
0895 B40208     727       cjne a, #2, check_delete_d
0898            728   
0898 856754     729       mov reflow_temp_set+0, x+0
089B 856855     730       mov reflow_temp_set+1, x+1
089E 800B       731       sjmp delete_done
08A0            732   
08A0            733   check_delete_d:
08A0 B40308     734       cjne a, #3, delete_done
08A3            735   
08A3 856756     736       mov reflow_time_set+0, x+0
08A6 856857     737       mov reflow_time_set+1, x+1
08A9 8000       738       sjmp delete_done
08AB            739   
08AB            740   delete_done:
08AB            741   
08AB C3         742            clr c
08AC 22         743            ret
08AD            744   
08AD            745   keypad_L0:
08AD            746   
08AD            747            ; Make all the rows zero.  If any column is zero then a key is pressed.
08AD C292       748            clr ROW1
08AF C294       749            clr ROW2
08B1 C296       750            clr ROW3
08B3 C2A0       751            clr ROW4
08B5            752   
08B5 A2A2       753            mov c, COL1
08B7 82A4       754            anl c, COL2
08B9 82A6       755            anl c, COL3
08BB 82B0       756            anl c, COL4
08BD            757   
08BD 5002       758            jnc Keypad_Debounce
08BF C3         759            clr c
08C0 22         760            ret
08C1            761   
08C1            762   
08C1            763   Keypad_Debounce:
08C1            764            ; A key maybe pressed.  Wait and check again to discard bounces.
08C1 120851     765            lcall Wait25ms ; debounce
08C4            766   
08C4 A2A2       767            mov c, COL1
08C6 82A4       768            anl c, COL2
08C8 82A6       769            anl c, COL3
08CA 82B0       770            anl c, COL4
08CC            771   
08CC 5002       772            jnc Keypad_Key_Code
08CE C3         773            clr c
08CF 22         774            ret
08D0            775            
08D0            776   
08D0            777   Keypad_Key_Code:         
08D0            778            ; A key is pressed.  Find out which one by checking each possible column and row combination.
08D0            779   
08D0 D292       780            setb ROW1
08D2 D294       781            setb ROW2
08D4 D296       782            setb ROW3
08D6 D2A0       783            setb ROW4
08D8            784   
08D8            785            ; This check section is for an un-modified keypad
08D8            786   
08D8            787   keypad_default:  
08D8            788   
08D8            789            ; Check row 1   
08D8 C292       790            clr ROW1
08DA 20A207     791            jb COL1, CHECK_COL_28
08DD 7F01       791            mov R7, #01H
08DF 30A2FD     791            jnb COL1, $ ; wait for key release
08E2 D3         791            setb c
08E3 22         791            ret
08E4            791   CHECK_COL_28:
08E4            791   
08E4 20A407     792            jb COL2, CHECK_COL_29
08E7 7F02       792            mov R7, #02H
08E9 30A4FD     792            jnb COL2, $ ; wait for key release
08EC D3         792            setb c
08ED 22         792            ret
08EE            792   CHECK_COL_29:
08EE 20A607     793            jb COL3, CHECK_COL_30
08F1 7F03       793            mov R7, #03H
08F3 30A6FD     793            jnb COL3, $ ; wait for key release
08F6 D3         793            setb c
08F7 22         793            ret
08F8            793   CHECK_COL_30:
08F8 20B007     794            jb COL4, CHECK_COL_31
08FB 7F0A       794            mov R7, #0AH
08FD 30B0FD     794            jnb COL4, $ ; wait for key release
0900 D3         794            setb c
0901 22         794            ret
0902            794   CHECK_COL_31:
0902            795   
0902 D292       796            setb ROW1
0904            797   
0904            798            ; Check row 2   
0904            799   
0904 C294       800            clr ROW2
0906 20A207     801            jb COL1, CHECK_COL_32
0909 7F04       801            mov R7, #04H
090B 30A2FD     801            jnb COL1, $ ; wait for key release
090E D3         801            setb c
090F 22         801            ret
0910            801   CHECK_COL_32:
0910 20A407     802            jb COL2, CHECK_COL_33
0913 7F05       802            mov R7, #05H
0915 30A4FD     802            jnb COL2, $ ; wait for key release
0918 D3         802            setb c
0919 22         802            ret
091A            802   CHECK_COL_33:
091A 20A607     803            jb COL3, CHECK_COL_34
091D 7F06       803            mov R7, #06H
091F 30A6FD     803            jnb COL3, $ ; wait for key release
0922 D3         803            setb c
0923 22         803            ret
0924            803   CHECK_COL_34:
0924 20B007     804            jb COL4, CHECK_COL_35
0927 7F0B       804            mov R7, #0BH
0929 30B0FD     804            jnb COL4, $ ; wait for key release
092C D3         804            setb c
092D 22         804            ret
092E            804   CHECK_COL_35:
092E            805   
092E D294       806            setb ROW2
0930            807   
0930            808            ; Check row 3   
0930            809   
0930 C296       810            clr ROW3
0932 20A207     811            jb COL1, CHECK_COL_36
0935 7F07       811            mov R7, #07H
0937 30A2FD     811            jnb COL1, $ ; wait for key release
093A D3         811            setb c
093B 22         811            ret
093C            811   CHECK_COL_36:
093C 20A407     812            jb COL2, CHECK_COL_37
093F 7F08       812            mov R7, #08H
0941 30A4FD     812            jnb COL2, $ ; wait for key release
0944 D3         812            setb c
0945 22         812            ret
0946            812   CHECK_COL_37:
0946 20A607     813            jb COL3, CHECK_COL_38
0949 7F09       813            mov R7, #09H
094B 30A6FD     813            jnb COL3, $ ; wait for key release
094E D3         813            setb c
094F 22         813            ret
0950            813   CHECK_COL_38:
0950 20B007     814            jb COL4, CHECK_COL_39
0953 7F0C       814            mov R7, #0CH
0955 30B0FD     814            jnb COL4, $ ; wait for key release
0958 D3         814            setb c
0959 22         814            ret
095A            814   CHECK_COL_39:
095A            815   
095A D296       816            setb ROW3
095C            817   
095C            818            ; Check row 4   
095C            819   
095C C2A0       820            clr ROW4
095E 20A207     821            jb COL1, CHECK_COL_40
0961 7F0E       821            mov R7, #0EH
0963 30A2FD     821            jnb COL1, $ ; wait for key release
0966 D3         821            setb c
0967 22         821            ret
0968            821   CHECK_COL_40:
0968 20A407     822            jb COL2, CHECK_COL_41
096B 7F00       822            mov R7, #00H
096D 30A4FD     822            jnb COL2, $ ; wait for key release
0970 D3         822            setb c
0971 22         822            ret
0972            822   CHECK_COL_41:
0972 20A607     823            jb COL3, CHECK_COL_42
0975 7F0F       823            mov R7, #0FH
0977 30A6FD     823            jnb COL3, $ ; wait for key release
097A D3         823            setb c
097B 22         823            ret
097C            823   CHECK_COL_42:
097C 20B007     824            jb COL4, CHECK_COL_43
097F 7F0D       824            mov R7, #0DH
0981 30B0FD     824            jnb COL4, $ ; wait for key release
0984 D3         824            setb c
0985 22         824            ret
0986            824   CHECK_COL_43:
0986            825   
0986 D2A0       826            setb ROW4
0988            827   
0988 C3         828            clr c
0989            829   
0989 22         830            ret
098A            831   
098A            832            
098A            833   ; Look-up table for the 7-seg displays. (Segments are turn on with zero) 
098A            834   T_7seg:
098A C0F9A4B0   835       DB 0xC0, 0xF9, 0xA4, 0xB0, 0x99        ; 0 TO 4
     99
098F 9282F880   836       DB 0x92, 0x82, 0xF8, 0x80, 0x90        ; 4 TO 9
     90
0994 8883C6A1   837       DB 0x88, 0x83, 0xC6, 0xA1, 0x86, 0x8E  ; A to F
     868E
099A            838   
099A            839   
099A            840   ; Displays a BCD number in HEX1-HEX0
099A            841   Display_BCD_7_Seg:
099A C0E0       842       push acc
099C C0D0       843       push psw
099E            844   
099E 853D67     845            mov x+0, TEMP+0
09A1 853E68     846            mov x+1, TEMP+1
09A4 756900     847       mov x+2, #0
09A7 756A00     848       mov x+3, #0
09AA 120267     849            lcall hex2bcd
09AD            850   
09AD 90098A     851            mov dptr, #T_7seg
09B0            852   
09B0 E571       853       mov a, bcd+2
09B2 C4         854       swap a
09B3 540F       855       anl a, #0FH
09B5 93         856       movc a, @a+dptr
09B6 F58F       857       mov HEX5, a
09B8            858   
09B8 E571       859       mov a, bcd+2
09BA 540F       860       anl a, #0FH
09BC 93         861       movc a, @a+dptr
09BD F58E       862       mov HEX4, a
09BF            863   
09BF E570       864       mov a, bcd+1
09C1 C4         865       swap a
09C2 540F       866       anl a, #0FH
09C4 93         867       movc a, @a+dptr
09C5 F594       868       mov HEX3, a
09C7            869   
09C7 E570       870       mov a, bcd+1
09C9 540F       871       anl a, #0FH
09CB 93         872       movc a, @a+dptr
09CC F593       873       mov HEX2, a
09CE            874   
09CE E56F       875            mov a, bcd
09D0 C4         876            swap a
09D1 540F       877            anl a, #0FH
09D3 93         878            movc a, @a+dptr
09D4 F592       879            mov HEX1, a
09D6            880   
09D6 E56F       881            mov a, bcd
09D8 540F       882            anl a, #0FH
09DA 93         883            movc a, @a+dptr
09DB F591       884            mov HEX0, a
09DD            885   
09DD D0D0       886       pop psw
09DF D0E0       887       pop acc
09E1            888   
09E1 22         889            ret
09E2            890   
09E2            891   
09E2            892   Check_Select_Button_Press:
09E2 20B40B     893       jb SELECT_BUTTON, Not_Pressed
09E5 120767     894       lcall Wait50ms
09E8 20B405     895       jb SELECT_BUTTON, Not_Pressed
09EB            896   
09EB D205       897       setb SELECT_BUTTON_FLAG
09ED            898   
09ED 30B4FD     899       jnb SELECT_BUTTON, $
09F0            900   
09F0            901       Not_Pressed:
09F0 22         902           ret
09F1            903   
09F1            904   
09F1            905   Check_Param_Button_Press:
09F1 20B30B     906       jb PARAM_BUTTON, Not_Pressed_2
09F4 120767     907       lcall Wait50ms
09F7 20B305     908       jb PARAM_BUTTON, Not_Pressed_2
09FA            909   
09FA D206       910       setb PARAM_BUTTON_FLAG
09FC            911   
09FC 30B3FD     912       jnb PARAM_BUTTON, $
09FF            913   
09FF            914       Not_Pressed_2:
09FF 22         915           ret
0A00            916   
0A00            917       ;---------------READ KEYPAD-------------------;
0A00            918   
0A00            919       ;A Macro essentially works like CHECK_COL(COL#, Literal value coloumn represents)
0A00            920       ;If the column is pressed, R7 will contain the column number (1-4)
0A00            921       
0A00            922   
0A00            923   ;**************************PWM**************************;
0A00            924   pwm_for_flatstates:
0A00            925   ; ---- LOW_LIM = max(0, T_TGT - T_BAND)
0A00 E54C       926           MOV     A, TARGET          
0A02 C3         927           CLR     C                 ;clear carry
0A03 9402       928           SUBB    A, #BAND         ; A = A - BAND
0A05 5002       929           JNC     flat_low_ok       
0A07 7400       930           MOV     A, #00h           
0A09            931   flat_low_ok:
0A09 F55D       932           MOV     LOW_LIMIT, A        ; Store low limit in RAM
0A0B            933   
0A0B            934           ;compute high limit
0A0B E54C       935           MOV     A, TARGET          
0A0D 2402       936           ADD     A, #BAND         
0A0F 5002       937           JNC     flat_high_ok      
0A11 74FF       938           MOV     A, #0FFh          
0A13            939   flat_high_ok:
0A13 F55F       940           MOV     HIGH_LIMIT, A       
0A15            941   
0A15            942           ;turn oven on if curren temp is less than low limit
0A15 E53D       943           MOV     A, TEMP          ;make sure this variables is right!!!!!!!
0A17 C3         944           CLR     C               
0A18 955D       945           SUBB    A, LOW_LIMIT       
0A1A            946                                    
0A1A 400A       947           JC      flat_on       ;temp is less than low limit so turn power on since there is carry
0A1C            948   
0A1C            949           ;if current temp is greater than high lim turn off
0A1C E53D       950           MOV     A, TEMP
0A1E C3         951           CLR     C                 
0A1F 955F       952           SUBB    A, HIGH_LIMIT       
0A21            953                                    
0A21 6002       954           JZ      flat_done         ; If equal to HIGH_LIMit do nothing
0A23 5004       955           JNC     flat_off      ; If no borrow and not zero T_CUR > HIGH_LIM so turn off
0A25            956   
0A25            957   flat_done:
0A25 22         958           RET                       ; Inside band do nothing, holds prev values
0A26            959   flat_on:
0A26 D280       960           SETB p0.0      ;turn power on
0A28 22         961           RET
0A29            962   
0A29            963   flat_off:
0A29 C280       964           CLR p0.0      ;power off
0A2B 22         965           RET
0A2C            966   
0A2C            967   
0A2C            968   
0A2C            969   RampBurstPWM:
0A2C            970   
0A2C            971           ;increment phase until it equals window then pahse =0
0A2C E564       972           MOV     A, PHASE          
0A2E 04         973           INC     A                 ; A <- A + 1
0A2F B40602     974           CJNE    A, #WINDOW, phase_ok  ; if A != WINDOW, keep it
0A32 7400       975           MOV     A, #00h           ; else wrap to 0
0A34            976   phase_ok:
0A34 F564       977           MOV     PHASE, A          ; store updated phase 
0A36            978   
0A36            979           ; calculate threasheld = target - lead
0A36 E54C       980           MOV     A, TARGET         ; A <- TARGET
0A38 C3         981           CLR     C                 
0A39 9565       982           SUBB    A, LEAD           
0A3B 5002       983           JNC     thresh_ok        
0A3D 7400       984           MOV     A, #00h           
0A3F            985   thresh_ok:
0A3F F561       986           MOV     THRESHOLD, A         
0A41            987   
0A41            988           ;if temp is less than threshold, full power
0A41 E53D       989           MOV     A, TEMP           
0A43 C3         990           CLR     C
0A44 9561       991           SUBB    A, THRESHOLD         
0A46 4010       992           JC      force_on         
0A48            993   
0A48            994           ; if temp is greater than target then off
0A48 E53D       995           MOV     A, TEMP           
0A4A C3         996           CLR     C
0A4B 954C       997           SUBB    A, TARGET         
0A4D 500C       998           JNC     force_off         
0A4F            999   
0A4F           1000           ;else burst pwm 
0A4F           1001           ; CMD_ON = 1 if PHASE < ON_SECS else 0
0A4F E564      1002           MOV     A, PHASE          ; A <- PHASE (0..WINDOW-1)
0A51 C3        1003           CLR     C
0A52 9563      1004           SUBB    A, ON_SECS        ; A <- PHASE - ON_SECS
0A54           1005                                    ; borrow => PHASE < ON_SECS
0A54 4008      1006           JC      burst_on          ; if PHASE < ON_SECS => ON
0A56 8009      1007           SJMP    burst_off         ; else OFF
0A58           1008   
0A58           1009   force_on:
0A58 D280      1010           SETB p0.0      ;less than threshold
0A5A 22        1011           RET
0A5B           1012   
0A5B           1013   force_off:
0A5B C280      1014           CLR p0.0      
0A5D 22        1015           RET
0A5E           1016   
0A5E           1017   burst_on:
0A5E D280      1018           SETB p0.0      ; ON for ON_SECS seconds each window
0A60 22        1019           RET
0A61           1020   
0A61           1021   burst_off:
0A61 C280      1022           CLR p0.0      ; OFF for remaining seconds
0A63 22        1023           RET
0A64           1024   
0A64           1025   
0A64           1026   
0A64           1027   
0A64           1028   ;==============SPEAKER FUNCTIONS==============;
0A64           1029   
0A64           1030   BeepSpeaker:
0A64 D28C      1031       setb TR0
0A66 7B07      1032       mov R3, #7
0A68           1033   WaitLoop:
0A68 120767    1034       lcall Wait50ms
0A6B DBFB      1035       djnz R3, WaitLoop 
0A6D           1036   UnbeepSpeaker:
0A6D C28C      1037       clr TR0
0A6F 22        1038       ret
0A70           1039   
0A70           1040   ;=============================================;
0A70           1041   
0A70           1042   FSM2_Temp_Time_display:
0A70           1043       ;print time
0A70 C0E0      1044            push acc
0A72 7401      1044            mov a, #1
0A74 14        1044            dec a
0A75 12024A    1044            lcall ?Set_Cursor_2 ; Select column and row
0A78 D0E0      1044            pop acc
0A7A C083      1045            push dph
0A7C C082      1045            push dpl
0A7E C0E0      1045            push acc
0A80 9001A4    1045            mov dptr, #TimeLabel
0A83 12023F    1045            lcall ?Send_Constant_String
0A86 D0E0      1045            pop acc
0A88 D082      1045            pop dpl
0A8A D083      1045            pop dph
0A8C           1046   
0A8C 854267    1047       mov x+0, TIME+0
0A8F 854368    1048       mov x+1, TIME+1
0A92 756900    1049       mov x+2, #0
0A95 756A00    1050       mov x+3, #0
0A98 120267    1051       lcall hex2bcd
0A9B           1052   
0A9B C0E0      1053            push acc
0A9D 7406      1053            mov a, #6
0A9F 14        1053            dec a
0AA0 12024A    1053            lcall ?Set_Cursor_2 ; Select column and row
0AA3 D0E0      1053            pop acc
0AA5 C000      1054            push ar0
0AA7 A870      1054            mov r0, bcd+1
0AA9 120251    1054            lcall ?Display_BCD
0AAC D000      1054            pop ar0
0AAE C000      1055            push ar0
0AB0 A86F      1055            mov r0, bcd+0
0AB2 120251    1055            lcall ?Display_BCD
0AB5 D000      1055            pop ar0
0AB7           1056       ;print temp
0AB7 C0E0      1057            push acc
0AB9 740A      1057            mov a, #10
0ABB 14        1057            dec a
0ABC 12024A    1057            lcall ?Set_Cursor_2 ; Select column and row
0ABF D0E0      1057            pop acc
0AC1 C083      1058            push dph
0AC3 C082      1058            push dpl
0AC5 C0E0      1058            push acc
0AC7 9001AA    1058            mov dptr, #TempLabel
0ACA 12023F    1058            lcall ?Send_Constant_String
0ACD D0E0      1058            pop acc
0ACF D082      1058            pop dpl
0AD1 D083      1058            pop dph
0AD3           1059   
0AD3 853D67    1060       mov x+0, TEMP+0
0AD6 853E68    1061       mov x+1, TEMP+1
0AD9 756900    1062       mov x+2, #0
0ADC 756A00    1063       mov x+3, #0
0ADF 120267    1064       lcall hex2bcd
0AE2           1065   
0AE2 C0E0      1066            push acc
0AE4 740D      1066            mov a, #16-3
0AE6 14        1066            dec a
0AE7 12024A    1066            lcall ?Set_Cursor_2 ; Select column and row
0AEA D0E0      1066            pop acc      
0AEC C000      1067            push ar0
0AEE A870      1067            mov r0, bcd+1
0AF0 120251    1067            lcall ?Display_BCD
0AF3 D000      1067            pop ar0
0AF5 C000      1068            push ar0
0AF7 A86F      1068            mov r0, bcd+0
0AF9 120251    1068            lcall ?Display_BCD
0AFC D000      1068            pop ar0
0AFE 22        1069       ret
0AFF           1070   
0AFF           1071   ;--- MAIN PROGRAM START ---
0AFF           1072   
0AFF           1073   ; **************************************** Initializations ***********************************************
0AFF           1074   
0AFF           1075   MAIN:
0AFF 75817F    1076       mov SP, #0x7F         ; Initialize Stack Pointer (Good practice)
0B02 120751    1077       lcall INITIALIZE      ; intialize pins and adc, for now
0B05           1078   
0B05 1205BD    1079       lcall Timer0_Init
0B08 1205D9    1080       lcall Timer2_Init
0B0B D2AF      1081       setB EA ; Enable global interrupts
0B0D 12020C    1082       lcall ELCD_4BIT ; Intialize LCD
0B10 120559    1083       lcall InitSerialPort
0B13           1084       
0B13 C202      1085       clr seconds_flag
0B15 C203      1086       clr flag_20ms
0B17 C204      1087       clr flag_50ms
0B19 C200      1088       clr START_FLAG
0B1B C207      1089       clr KEYPAD_FLAG
0B1D C280      1090       clr p0.0 ; Make sure oven is off to start
0B1F C28C      1091       clr TR0 ; Start speaker off
0B21 E4        1092       clr a
0B22 C290      1093       clr RED_LED
0B24 C2B1      1094       clr GREEN_LED
0B26           1095   
0B26           1096   
0B26 753000    1097       mov STATE_VAR_1, #0x0000
0B29 753100    1098       mov STATE_VAR_2, #0x0000
0B2C 754200    1099       mov TIME, #0
0B2F 753D00    1100       mov TEMP, #0000
0B32 754400    1101       mov POWER, #0
0B35 75463C    1102       mov DEGREES60, #60
0B38 754896    1103       mov DEGREES150, #150
0B3B 754ADC    1104       mov DEGREES220, #220
0B3E 754C00    1105       mov TARGET+0, #0
0B41 754D00    1106       mov TARGET+1, #0
0B44 754E00    1107       mov TARGET_TIME+0, #0
0B47 754F00    1108       mov TARGET_TIME+1, #0
0B4A           1109   
0B4A 756F00    1110       mov bcd, #0x0000
0B4D 756700    1111       mov x+0, #0x0000
0B50 756800    1112       mov x+1, #0x0000
0B53 756900    1113       mov x+2, #0x0000
0B56 756A00    1114       mov x+3, #0x0000
0B59           1115   
0B59 755000    1116       mov soak_temp_set+0, #0
0B5C F551      1117       mov soak_temp_set+1, a
0B5E           1118   
0B5E 755200    1119       mov soak_time_set+0, #0
0B61 F553      1120       mov soak_time_set+1, a
0B63           1121   
0B63 755400    1122       mov reflow_temp_set+0, #0
0B66 F555      1123       mov reflow_temp_set+1, a
0B68           1124   
0B68 755600    1125       mov reflow_time_set+0, #0
0B6B F557      1126       mov reflow_time_set+1, a
0B6D           1127   
0B6D 757900    1128       mov current_state, #ST_PINIT
0B70           1129   
0B70           1130   ; Forever loop: service timer flags (ADC/display/1s), then run one FSM state (non-blocking)
0B70           1131   MAIN_LOOP:
0B70 200362    1132            jb flag_20ms, Do_20ms_Tasks
0B73 200466    1133            jb flag_50ms, Do_50ms_Tasks
0B76 20026D    1134            jb seconds_flag, Do_1s_Tasks
0B79 E579      1135            mov a, current_state
0B7B B40003    1136            cjne a, #ST_PINIT, ML_not_pinit
0B7E 020BED    1137            ljmp StatePInit
0B81           1138   ML_not_pinit:
0B81 B40103    1139            cjne a, #ST_P, ML_not_p
0B84 020C2D    1140            ljmp StateP
0B87           1141   ML_not_p:
0B87 B40203    1142            cjne a, #ST_P1D, ML_not_p1d
0B8A 020C6C    1143            ljmp Preset1_Display
0B8D           1144   ML_not_p1d:
0B8D B40303    1145            cjne a, #ST_P2D, ML_not_p2d
0B90 020CA2    1146            ljmp Preset2_Display
0B93           1147   ML_not_p2d:
0B93 B40403    1148            cjne a, #ST_P3D, ML_not_p3d
0B96 020CD8    1149            ljmp Preset3_Display
0B99           1150   ML_not_p3d:
0B99 B40503    1151            cjne a, #ST_P4D, ML_not_p4d
0B9C 020D0E    1152            ljmp Preset4_Display
0B9F           1153   ML_not_p4d:
0B9F B40603    1154            cjne a, #ST_READY, ML_not_ready
0BA2 02121A    1155            ljmp ReadyStateInit
0BA5           1156   ML_not_ready:
0BA5 B40703    1157            cjne a, #ST_READY_WAIT, ML_not_ready_wait
0BA8 021261    1158            ljmp ReadyStateWait
0BAB           1159   ML_not_ready_wait:
0BAB B40803    1160            cjne a, #ST_0, ML_not_0
0BAE 021294    1161            ljmp State0
0BB1           1162   ML_not_0:
0BB1 B40903    1163            cjne a, #ST_1, ML_not_1
0BB4 0212CA    1164            ljmp State1
0BB7           1165   ML_not_1:
0BB7 B40A03    1166            cjne a, #ST_2, ML_not_2
0BBA 02132B    1167            ljmp State2
0BBD           1168   ML_not_2:
0BBD B40B03    1169            cjne a, #ST_3, ML_not_3
0BC0 0213A6    1170            ljmp State3
0BC3           1171   ML_not_3:
0BC3 B40C03    1172            cjne a, #ST_4, ML_not_4
0BC6 021404    1173            ljmp State4
0BC9           1174   ML_not_4:
0BC9 B40D03    1175            cjne a, #ST_5, ML_default
0BCC 02145C    1176            ljmp State5
0BCF           1177   ML_default:
0BCF 757900    1178            mov current_state, #ST_PINIT
0BD2 020B70    1179            ljmp MAIN_LOOP
0BD5           1180   
0BD5           1181   Do_20ms_Tasks:
0BD5 C203      1182            clr flag_20ms
0BD7 120632    1183            lcall Calculate_ADC
0BDA 8094      1184            sjmp MAIN_LOOP
0BDC           1185   Do_50ms_Tasks:
0BDC C204      1186            clr flag_50ms
0BDE 120575    1187            lcall Display_Voltage_Serial
0BE1 12099A    1188            lcall Display_BCD_7_seg
0BE4 808A      1189            sjmp MAIN_LOOP
0BE6           1190   Do_1s_Tasks:
0BE6 C202      1191            clr seconds_flag
0BE8 1206F9    1192            lcall OneSecond_Tasks
0BEB 8083      1193            sjmp MAIN_LOOP
0BED           1194   
0BED           1195   ; **************************** Preset Settings **************************************
0BED           1196   
0BED           1197   ; **************************** Preset Settings **************************************
0BED           1198   
0BED           1199   StatePInit:
0BED C0E0      1200            push acc
0BEF 7401      1200            mov a, #1
0BF1 14        1200            dec a
0BF2 12024C    1200            lcall ?Set_Cursor_1 ; Select column and row
0BF5 D0E0      1200            pop acc
0BF7 C083      1201            push dph
0BF9 C082      1201            push dpl
0BFB C0E0      1201            push acc
0BFD 90003F    1201            mov dptr, #preset_message
0C00 12023F    1201            lcall ?Send_Constant_String
0C03 D0E0      1201            pop acc
0C05 D082      1201            pop dpl
0C07 D083      1201            pop dph
0C09 C0E0      1202            push acc
0C0B 7401      1202            mov a, #1
0C0D 14        1202            dec a
0C0E 12024A    1202            lcall ?Set_Cursor_2 ; Select column and row
0C11 D0E0      1202            pop acc
0C13 C083      1203            push dph
0C15 C082      1203            push dpl
0C17 C0E0      1203            push acc
0C19 900050    1203            mov dptr, #stop_to_skip_message
0C1C 12023F    1203            lcall ?Send_Constant_String
0C1F D0E0      1203            pop acc
0C21 D082      1203            pop dpl
0C23 D083      1203            pop dph
0C25 C205      1204       clr SELECT_BUTTON_FLAG
0C27 757901    1205       mov current_state, #ST_P
0C2A 020B70    1206       ljmp MAIN_LOOP
0C2D           1207   
0C2D           1208   StateP:
0C2D 12072C    1209       lcall Service_Timer_Flags
0C30 1209E2    1210       lcall Check_Select_Button_Press
0C33 30EF03    1211       jnb PRESET1_SW, StateP_chk2
0C36 020C57    1212       ljmp Presetx1
0C39           1213   StateP_chk2:
0C39 30EE03    1214       jnb PRESET2_SW, StateP_chk3
0C3C 020C8D    1215       ljmp Presetx2
0C3F           1216   StateP_chk3:
0C3F 30ED03    1217       jnb PRESET3_SW, StateP_chk4
0C42 020CC3    1218       ljmp Presetx3
0C45           1219   StateP_chk4:
0C45 30EC03    1220       jnb PRESET4_SW, StateP_chk_sel
0C48 020CF9    1221       ljmp Presetx4
0C4B           1222   StateP_chk_sel:
0C4B 200506    1223       jb SELECT_BUTTON_FLAG, GoToParam
0C4E 757901    1224       mov current_state, #ST_P
0C51 020B70    1225       ljmp MAIN_LOOP
0C54           1226   
0C54           1227   GoToParam:
0C54 020E24    1228   ljmp PARAM_FSM
0C57           1229   
0C57           1230   Presetx1:
0C57 7550AA    1231            mov soak_temp_set, #170
0C5A 75524B    1232            mov soak_time_set, #75
0C5D 7554E6    1233            mov reflow_temp_set, #230
0C60 75562D    1234            mov reflow_time_set, #45
0C63 120A64    1235            lcall BeepSpeaker
0C66 757902    1236            mov current_state, #ST_P1D
0C69 020B70    1237            ljmp MAIN_LOOP
0C6C           1238   
0C6C           1239   Preset1_Display:
0C6C 120D2F    1240       lcall Preset_Displays
0C6F 1209E2    1241       lcall Check_Select_Button_Press
0C72 200512    1242            jb SELECT_BUTTON_FLAG, P1GT0
0C75 30EF06    1243            jnb PRESET1_SW, P1GTI
0C78 757902    1244            mov current_state, #ST_P1D
0C7B 020B70    1245            ljmp MAIN_LOOP
0C7E           1246   
0C7E           1247   P1GTI:
0C7E 120A64    1248            lcall BeepSpeaker
0C81 757900    1249            mov current_state, #ST_PINIT
0C84 020B70    1250            ljmp MAIN_LOOP
0C87           1251   
0C87           1252   P1GT0:
0C87 757906    1253            mov current_state, #ST_READY
0C8A 020B70    1254            ljmp MAIN_LOOP
0C8D           1255   
0C8D           1256   Presetx2:
0C8D 7550A0    1257            mov soak_temp_set, #160
0C90 75525A    1258            mov soak_time_set, #90
0C93 7554E6    1259            mov reflow_temp_set, #230
0C96 75563C    1260            mov reflow_time_set, #60
0C99 120A64    1261            lcall BeepSpeaker
0C9C 757903    1262            mov current_state, #ST_P2D
0C9F 020B70    1263            ljmp MAIN_LOOP
0CA2           1264   
0CA2           1265   Preset2_Display:
0CA2 120D2F    1266       lcall Preset_Displays
0CA5 1209E2    1267       lcall Check_Select_Button_Press
0CA8 200512    1268            jb SELECT_BUTTON_FLAG, P2GT0
0CAB 30EE06    1269            jnb PRESET2_SW, P2GTI
0CAE 757903    1270            mov current_state, #ST_P2D
0CB1 020B70    1271            ljmp MAIN_LOOP
0CB4           1272   
0CB4           1273   P2GTI:
0CB4 120A64    1274            lcall BeepSpeaker
0CB7 757900    1275            mov current_state, #ST_PINIT
0CBA 020B70    1276            ljmp MAIN_LOOP
0CBD           1277   
0CBD           1278   P2GT0:
0CBD 757906    1279            mov current_state, #ST_READY
0CC0 020B70    1280            ljmp MAIN_LOOP
0CC3           1281   
0CC3           1282   Presetx3:
0CC3 755096    1283            mov soak_temp_set, #150
0CC6 755278    1284            mov soak_time_set, #120
0CC9 7554E1    1285            mov reflow_temp_set, #225
0CCC 75563C    1286            mov reflow_time_set, #60
0CCF 120A64    1287            lcall BeepSpeaker
0CD2 757904    1288            mov current_state, #ST_P3D
0CD5 020B70    1289            ljmp MAIN_LOOP
0CD8           1290   
0CD8           1291   Preset3_Display:
0CD8 120D2F    1292       lcall Preset_Displays
0CDB 1209E2    1293       lcall Check_Select_Button_Press
0CDE 200512    1294            jb SELECT_BUTTON_FLAG, P3GT0
0CE1 30ED06    1295            jnb PRESET3_SW, P3GTI
0CE4 757904    1296            mov current_state, #ST_P3D
0CE7 020B70    1297            ljmp MAIN_LOOP
0CEA           1298   
0CEA           1299   P3GTI:
0CEA 120A64    1300            lcall BeepSpeaker
0CED 757900    1301            mov current_state, #ST_PINIT
0CF0 020B70    1302            ljmp MAIN_LOOP
0CF3           1303   
0CF3           1304   P3GT0:
0CF3 757906    1305            mov current_state, #ST_READY
0CF6 020B70    1306            ljmp MAIN_LOOP
0CF9           1307   
0CF9           1308   Presetx4:
0CF9 7550B4    1309            mov soak_temp_set, #180
0CFC 75523C    1310            mov soak_time_set, #60
0CFF 7554EB    1311            mov reflow_temp_set, #235
0D02 75561E    1312            mov reflow_time_set, #30
0D05 120A64    1313            lcall BeepSpeaker
0D08 757905    1314            mov current_state, #ST_P4D
0D0B 020B70    1315            ljmp MAIN_LOOP
0D0E           1316   
0D0E           1317   Preset4_Display:
0D0E 120D2F    1318       lcall Preset_Displays
0D11 1209E2    1319       lcall Check_Select_Button_Press
0D14 200512    1320            jb SELECT_BUTTON_FLAG, P4GT0
0D17 30EC06    1321            jnb PRESET4_SW, P4GTI
0D1A 757905    1322            mov current_state, #ST_P4D
0D1D 020B70    1323            ljmp MAIN_LOOP
0D20           1324   
0D20           1325   P4GTI:
0D20 120A64    1326            lcall BeepSpeaker
0D23 757900    1327            mov current_state, #ST_PINIT
0D26 020B70    1328            ljmp MAIN_LOOP
0D29           1329   
0D29           1330   P4GT0:
0D29 757906    1331            mov current_state, #ST_READY
0D2C 020B70    1332            ljmp MAIN_LOOP
0D2F           1333   
0D2F           1334   
0D2F           1335   Preset_Displays:
0D2F           1336   
0D2F C0E0      1337       push acc
0D31 C0D0      1338       push psw
0D33           1339   
0D33 C0E0      1340            push acc
0D35 7401      1340            mov a, #1
0D37 14        1340            dec a
0D38 12024C    1340            lcall ?Set_Cursor_1 ; Select column and row
0D3B D0E0      1340            pop acc
0D3D C083      1341            push dph
0D3F C082      1341            push dpl
0D41 C0E0      1341            push acc
0D43 900061    1341            mov dptr, #preset_param_message1
0D46 12023F    1341            lcall ?Send_Constant_String
0D49 D0E0      1341            pop acc
0D4B D082      1341            pop dpl
0D4D D083      1341            pop dph
0D4F C0E0      1342            push acc
0D51 7401      1342            mov a, #1
0D53 14        1342            dec a
0D54 12024A    1342            lcall ?Set_Cursor_2 ; Select column and row
0D57 D0E0      1342            pop acc
0D59 C083      1343            push dph
0D5B C082      1343            push dpl
0D5D C0E0      1343            push acc
0D5F 900072    1343            mov dptr, #preset_param_message2
0D62 12023F    1343            lcall ?Send_Constant_String
0D65 D0E0      1343            pop acc
0D67 D082      1343            pop dpl
0D69 D083      1343            pop dph
0D6B           1344   
0D6B 855067    1345            mov x+0, soak_temp_set+0
0D6E 855168    1346            mov x+1, soak_temp_set+1
0D71 120267    1347            lcall hex2bcd
0D74 C0E0      1348            push acc
0D76 7405      1348            mov a, #5
0D78 14        1348            dec a
0D79 12024C    1348            lcall ?Set_Cursor_1 ; Select column and row
0D7C D0E0      1348            pop acc
0D7E C000      1349            push ar0
0D80 A870      1349            mov r0, bcd+1
0D82 120251    1349            lcall ?Display_BCD
0D85 D000      1349            pop ar0
0D87 C000      1350            push ar0
0D89 A86F      1350            mov r0, bcd+0
0D8B 120251    1350            lcall ?Display_BCD
0D8E D000      1350            pop ar0
0D90 C0E0      1351            push acc
0D92 7405      1351            mov a, #5
0D94 14        1351            dec a
0D95 12024C    1351            lcall ?Set_Cursor_1 ; Select column and row
0D98 D0E0      1351            pop acc
0D9A C083      1352            push dph
0D9C C082      1352            push dpl
0D9E C0E0      1352            push acc
0DA0 90003A    1352            mov dptr, #':'
0DA3 12023F    1352            lcall ?Send_Constant_String
0DA6 D0E0      1352            pop acc
0DA8 D082      1352            pop dpl
0DAA D083      1352            pop dph
0DAC           1353   
0DAC 855267    1354            mov x+0, soak_time_set+0
0DAF 120267    1355            lcall hex2bcd
0DB2 C0E0      1356            push acc
0DB4 740F      1356            mov a, #15
0DB6 14        1356            dec a
0DB7 12024C    1356            lcall ?Set_Cursor_1 ; Select column and row
0DBA D0E0      1356            pop acc
0DBC C000      1357            push ar0
0DBE A86F      1357            mov r0, bcd+0
0DC0 120251    1357            lcall ?Display_BCD
0DC3 D000      1357            pop ar0
0DC5           1358   
0DC5 855467    1359            mov x+0, reflow_temp_set+0
0DC8 855568    1360            mov x+1, reflow_temp_set+1
0DCB 120267    1361            lcall hex2bcd
0DCE C0E0      1362            push acc
0DD0 7405      1362            mov a, #5
0DD2 14        1362            dec a
0DD3 12024A    1362            lcall ?Set_Cursor_2 ; Select column and row
0DD6 D0E0      1362            pop acc
0DD8 C000      1363            push ar0
0DDA A870      1363            mov r0, bcd+1
0DDC 120251    1363            lcall ?Display_BCD
0DDF D000      1363            pop ar0
0DE1 C000      1364            push ar0
0DE3 A86F      1364            mov r0, bcd+0
0DE5 120251    1364            lcall ?Display_BCD
0DE8 D000      1364            pop ar0
0DEA C0E0      1365            push acc
0DEC 7405      1365            mov a, #5
0DEE 14        1365            dec a
0DEF 12024A    1365            lcall ?Set_Cursor_2 ; Select column and row
0DF2 D0E0      1365            pop acc
0DF4 C083      1366            push dph
0DF6 C082      1366            push dpl
0DF8 C0E0      1366            push acc
0DFA 90003A    1366            mov dptr, #':'
0DFD 12023F    1366            lcall ?Send_Constant_String
0E00 D0E0      1366            pop acc
0E02 D082      1366            pop dpl
0E04 D083      1366            pop dph
0E06           1367   
0E06 855667    1368            mov x+0, reflow_time_set+0
0E09 120267    1369            lcall hex2bcd
0E0C C0E0      1370            push acc
0E0E 740F      1370            mov a, #15
0E10 14        1370            dec a
0E11 12024A    1370            lcall ?Set_Cursor_2 ; Select column and row
0E14 D0E0      1370            pop acc
0E16 C000      1371            push ar0
0E18 A86F      1371            mov r0, bcd+0
0E1A 120251    1371            lcall ?Display_BCD
0E1D D000      1371            pop ar0
0E1F           1372   
0E1F D0D0      1373       pop psw
0E21 D0E0      1374       pop acc
0E23           1375   
0E23 22        1376            ret
0E24           1377   
0E24           1378   
0E24           1379   PARAM_FSM:
0E24           1380   
0E24           1381   ; **************************** FSM1: PARAMETER ENTRY *************************
0E24           1382   ; User sets soak temp/time, reflow temp/time (before thermocouple in oven).
0E24           1383   ; States: A = soak temp, B = soak time, C = reflow temp, D = reflow time.
0E24           1384   ; Service_Timer_Flags at start of each state -> temp read (Calculate_ADC) every 20ms.
0E24           1385   ; **************************** FSM for selecting parameters *************************
0E24           1386   
0E24           1387   ; 4 main states ->  A: select soak temp
0E24           1388   ;                   B: select soak time
0E24           1389   ;                   C: select reflow temp
0E24           1390   ;                   D: select reflow time
0E24           1391   ; move to other FSM when start button turns on start flag
0E24           1392   
0E24           1393   StateAInit:
0E24 C0E0      1394            push acc
0E26 7401      1394            mov a, #1
0E28 14        1394            dec a
0E29 12024C    1394            lcall ?Set_Cursor_1 ; Select column and row
0E2C D0E0      1394            pop acc
0E2E C083      1395            push dph
0E30 C082      1395            push dpl
0E32 C0E0      1395            push acc
0E34 900083    1395            mov dptr, #param_message
0E37 12023F    1395            lcall ?Send_Constant_String
0E3A D0E0      1395            pop acc
0E3C D082      1395            pop dpl
0E3E D083      1395            pop dph
0E40 C0E0      1396            push acc
0E42 7401      1396            mov a, #1
0E44 14        1396            dec a
0E45 12024A    1396            lcall ?Set_Cursor_2 ; Select column and row
0E48 D0E0      1396            pop acc
0E4A C083      1397            push dph
0E4C C082      1397            push dpl
0E4E C0E0      1397            push acc
0E50 900094    1397            mov dptr, #soak_temp_message
0E53 12023F    1397            lcall ?Send_Constant_String
0E56 D0E0      1397            pop acc
0E58 D082      1397            pop dpl
0E5A D083      1397            pop dph
0E5C           1398   
0E5C C205      1399       clr SELECT_BUTTON_FLAG
0E5E C207      1400       clr KEYPAD_FLAG
0E60 757A00    1401       mov keypad_digit_count, #0
0E63           1402   
0E63           1403   StateA:
0E63 12072C    1404       lcall Service_Timer_Flags
0E66 30B23E    1405       jnb RESET_BUTTON, StateA_ResetToMain
0E69 AE31      1406       mov R6, STATE_VAR_2
0E6B BE003F    1407       cjne R6, #0, StateA_B
0E6E           1408   
0E6E 1209E2    1409       lcall Check_Select_Button_Press
0E71 20053C    1410       jb SELECT_BUTTON_FLAG, StateAtoDone
0E74           1411   
0E74 855067    1412       mov x+0, soak_temp_set+0
0E77 855168    1413       mov x+1, soak_temp_set+1
0E7A 756900    1414       mov x+2, #0
0E7D 756A00    1415       mov x+3, #0
0E80 120267    1416       lcall hex2bcd
0E83           1417   
0E83 C0E0      1418            push acc
0E85 740C      1418            mov a, #12
0E87 14        1418            dec a
0E88 12024A    1418            lcall ?Set_Cursor_2 ; Select column and row
0E8B D0E0      1418            pop acc
0E8D C000      1419            push ar0
0E8F A870      1419            mov r0, bcd+1
0E91 120251    1419            lcall ?Display_BCD
0E94 D000      1419            pop ar0
0E96 C000      1420            push ar0
0E98 A86F      1420            mov r0, bcd+0
0E9A 120251    1420            lcall ?Display_BCD
0E9D D000      1420            pop ar0
0E9F           1421   
0E9F 1209F1    1422       lcall Check_Param_Button_Press
0EA2 200667    1423       jb PARAM_BUTTON_FLAG, Inc_Soak_Temp
0EA5 800C      1424       sjmp StateA_Keypad
0EA7           1425   
0EA7           1426   StateA_ResetToMain:
0EA7 757900    1427            mov current_state, #ST_PINIT
0EAA 020B70    1428            ljmp MAIN_LOOP   
0EAD           1429   
0EAD           1430   StateA_B:
0EAD 020F3F    1431   ljmp StateBInit
0EB0           1432   
0EB0           1433   StateAtoDone:
0EB0 020F30    1434   ljmp StateADone
0EB3           1435   
0EB3           1436   StateA_Keypad:
0EB3 12086B    1437       lcall Keypad
0EB6 50AB      1438       jnc StateA
0EB8           1439       ; Only accept decimal digits 0-9 (reject A-F)
0EB8 EF        1440       mov a, R7
0EB9 B40A03    1441       cjne a, #10, StateA_Keypad_not10
0EBC 020E63    1442       ljmp StateA
0EBF           1443   StateA_Keypad_not10:
0EBF 50A2      1444       jnc StateA
0EC1 20070C    1445       jb KEYPAD_FLAG, StateA_Keypad_Continue
0EC4 D207      1446       setb KEYPAD_FLAG
0EC6           1447   
0EC6 7400      1448       mov a, #0
0EC8 F56F      1449       mov bcd+0, a
0ECA F570      1450       mov bcd+1, a
0ECC F571      1451       mov bcd+2, a
0ECE F572      1452       mov bcd+3, a
0ED0           1453   
0ED0           1454   StateA_Keypad_Continue:
0ED0 1207EA    1455       lcall Shift_Digits_Left
0ED3 508E      1456       jnc StateA
0ED5           1457   
0ED5 1202B4    1458       lcall bcd2hex
0ED8           1459   
0ED8 856750    1460       mov soak_temp_set+0, x+0
0EDB 856851    1461       mov soak_temp_set+1, x+1
0EDE           1462   
0EDE 855067    1463       mov x+0, soak_temp_set+0
0EE1 855168    1464       mov x+1, soak_temp_set+1
0EE4 756900    1465       mov x+2, #0
0EE7 756A00    1466       mov x+3, #0
0EEA 120267    1467       lcall hex2bcd
0EED           1468   
0EED C0E0      1469            push acc
0EEF 740C      1469            mov a, #12
0EF1 14        1469            dec a
0EF2 12024A    1469            lcall ?Set_Cursor_2 ; Select column and row
0EF5 D0E0      1469            pop acc
0EF7 C000      1470            push ar0
0EF9 A870      1470            mov r0, bcd+1
0EFB 120251    1470            lcall ?Display_BCD
0EFE D000      1470            pop ar0
0F00 C000      1471            push ar0
0F02 A86F      1471            mov r0, bcd+0
0F04 120251    1471            lcall ?Display_BCD
0F07 D000      1471            pop ar0
0F09           1472   
0F09 020E63    1473       ljmp StateA
0F0C           1474   
0F0C           1475   
0F0C           1476       Inc_Soak_Temp:
0F0C C206      1477           clr PARAM_BUTTON_FLAG
0F0E           1478   
0F0E E550      1479           mov a, soak_temp_set
0F10           1480   
0F10 20E80B    1481           jb UPDOWN, Dec_Soak_Temp
0F13 20E904    1482           jb TENS, Inc_Soak_Temp_Tens
0F16           1483   
0F16 2401      1484           add a, #1
0F18 8011      1485           sjmp Soak_Temp_Tens_Done
0F1A           1486   
0F1A           1487       Inc_Soak_Temp_Tens:
0F1A 240A      1488           add a, #10
0F1C 800D      1489           sjmp Soak_Temp_Tens_Done
0F1E           1490   
0F1E           1491       Dec_Soak_Temp:
0F1E 20E905    1492           jb TENS, Dec_Soak_Temp_Tens
0F21           1493   
0F21 C3        1494           clr c
0F22 9401      1495           subb a, #1
0F24 8005      1496           sjmp Soak_Temp_Tens_Done
0F26           1497   
0F26           1498       Dec_Soak_Temp_Tens:
0F26 C3        1499           clr c  
0F27 940A      1500           subb a, #10
0F29 8000      1501           sjmp Soak_Temp_Tens_Done
0F2B           1502   
0F2B           1503       Soak_Temp_Tens_Done:
0F2B F550      1504           mov soak_temp_set, a
0F2D 020E63    1505           ljmp StateA
0F30           1506   
0F30           1507   StateADone:
0F30 120A64    1508       lcall BeepSpeaker
0F33 0531      1509       inc STATE_VAR_2
0F35 C205      1510       clr SELECT_BUTTON_FLAG
0F37 C207      1511       clr KEYPAD_FLAG
0F39 757A00    1512       mov keypad_digit_count, #0
0F3C 020E63    1513       ljmp StateA
0F3F           1514   
0F3F           1515   
0F3F           1516   StateBInit:
0F3F C0E0      1517            push acc
0F41 7401      1517            mov a, #1
0F43 14        1517            dec a
0F44 12024A    1517            lcall ?Set_Cursor_2 ; Select column and row
0F47 D0E0      1517            pop acc
0F49 C083      1518            push dph
0F4B C082      1518            push dpl
0F4D C0E0      1518            push acc
0F4F 9000A5    1518            mov dptr, #soak_time_message
0F52 12023F    1518            lcall ?Send_Constant_String
0F55 D0E0      1518            pop acc
0F57 D082      1518            pop dpl
0F59 D083      1518            pop dph
0F5B           1519   
0F5B C205      1520       clr SELECT_BUTTON_FLAG
0F5D C207      1521       clr KEYPAD_FLAG
0F5F 757A00    1522       mov keypad_digit_count, #0
0F62           1523   
0F62           1524   StateB:
0F62 12072C    1525       lcall Service_Timer_Flags
0F65 30B236    1526       jnb RESET_BUTTON, StateB_ResetToMain
0F68 AE31      1527       mov R6, STATE_VAR_2
0F6A BE0137    1528       cjne R6, #1, StateB_C
0F6D           1529   
0F6D 1209E2    1530       lcall Check_Select_Button_Press
0F70 200534    1531       jb SELECT_BUTTON_FLAG, StateBtoDone
0F73           1532   
0F73 855267    1533       mov x+0, soak_time_set+0
0F76 756800    1534       mov x+1, #0
0F79 756900    1535       mov x+2, #0
0F7C 756A00    1536       mov x+3, #0
0F7F 120267    1537       lcall hex2bcd
0F82           1538   
0F82 C0E0      1539            push acc
0F84 740C      1539            mov a, #12
0F86 14        1539            dec a
0F87 12024A    1539            lcall ?Set_Cursor_2 ; Select column and row
0F8A D0E0      1539            pop acc
0F8C C000      1540            push ar0
0F8E A86F      1540            mov r0, bcd+0
0F90 120251    1540            lcall ?Display_BCD
0F93 D000      1540            pop ar0
0F95           1541   
0F95 1209F1    1542       lcall Check_Param_Button_Press
0F98 20065F    1543       jb PARAM_BUTTON_FLAG, Inc_Soak_Time
0F9B 020FAA    1544       ljmp StateB_Keypad
0F9E           1545   
0F9E           1546   StateB_ResetToMain:
0F9E 757900    1547            mov current_state, #ST_PINIT
0FA1 020B70    1548            ljmp MAIN_LOOP
0FA4           1549   
0FA4           1550   StateB_C:
0FA4 02102D    1551   ljmp StateCInit
0FA7           1552   
0FA7           1553   StateBtoDone:
0FA7 02101E    1554   ljmp StateBDone
0FAA           1555   
0FAA           1556   StateB_Keypad:
0FAA 12086B    1557       lcall Keypad
0FAD 50B3      1558       jnc StateB
0FAF EF        1559       mov a, R7
0FB0 B40A03    1560       cjne a, #10, StateB_Keypad_not10
0FB3 020F62    1561       ljmp StateB
0FB6           1562   StateB_Keypad_not10:
0FB6 50AA      1563       jnc StateB
0FB8 20070C    1564       jb KEYPAD_FLAG, StateB_Keypad_Continue
0FBB D207      1565       setb KEYPAD_FLAG
0FBD           1566   
0FBD 7400      1567       mov a, #0
0FBF F56F      1568       mov bcd+0, a
0FC1 F570      1569       mov bcd+1, a
0FC3 F571      1570       mov bcd+2, a
0FC5 F572      1571       mov bcd+3, a
0FC7           1572   
0FC7           1573   StateB_Keypad_Continue:
0FC7 1207EA    1574       lcall Shift_Digits_Left
0FCA 5096      1575       jnc StateB
0FCC           1576   
0FCC 1202B4    1577       lcall bcd2hex
0FCF           1578   
0FCF 856752    1579       mov soak_time_set+0, x+0
0FD2 755300    1580       mov soak_time_set+1, #0
0FD5           1581   
0FD5 855267    1582       mov x+0, soak_time_set+0
0FD8 756800    1583       mov x+1, #0
0FDB 756900    1584       mov x+2, #0
0FDE 756A00    1585       mov x+3, #0
0FE1 120267    1586       lcall hex2bcd
0FE4           1587   
0FE4 C0E0      1588            push acc
0FE6 740C      1588            mov a, #12
0FE8 14        1588            dec a
0FE9 12024A    1588            lcall ?Set_Cursor_2 ; Select column and row
0FEC D0E0      1588            pop acc
0FEE C000      1589            push ar0
0FF0 A86F      1589            mov r0, bcd+0
0FF2 120251    1589            lcall ?Display_BCD
0FF5 D000      1589            pop ar0
0FF7           1590   
0FF7 020F62    1591       ljmp StateB
0FFA           1592   
0FFA           1593   
0FFA           1594       Inc_Soak_Time:
0FFA C206      1595           clr PARAM_BUTTON_FLAG
0FFC           1596   
0FFC E552      1597           mov a, soak_time_set
0FFE           1598   
0FFE 20E80B    1599           jb UPDOWN, Dec_Soak_Time
1001 20E904    1600           jb TENS, Inc_Soak_Time_Tens
1004           1601   
1004 2401      1602           add a, #1
1006 8011      1603           sjmp Soak_Time_Tens_Done
1008           1604   
1008           1605       Inc_Soak_Time_Tens:
1008 240A      1606           add a, #10
100A 800D      1607           sjmp Soak_Time_Tens_Done
100C           1608   
100C           1609       Dec_Soak_Time:
100C 20E905    1610           jb TENS, Dec_Soak_Time_Tens
100F C3        1611           clr c
1010           1612   
1010 9401      1613           subb a, #1
1012 8005      1614           sjmp Soak_Time_Tens_Done
1014           1615   
1014           1616       Dec_Soak_Time_Tens:
1014 C3        1617           clr c
1015           1618   
1015 940A      1619           subb a, #10
1017 8000      1620           sjmp Soak_Time_Tens_Done
1019           1621   
1019           1622       Soak_Time_Tens_Done:
1019 F552      1623           mov soak_time_set, a
101B 020F62    1624           ljmp StateB
101E           1625   
101E           1626   StateBDone:
101E 120A64    1627       lcall BeepSpeaker
1021 0531      1628       inc STATE_VAR_2
1023 C205      1629       clr SELECT_BUTTON_FLAG
1025 C207      1630       clr KEYPAD_FLAG
1027 757A00    1631       mov keypad_digit_count, #0
102A 020F62    1632       ljmp StateB
102D           1633   
102D           1634   
102D           1635   StateCInit:
102D C0E0      1636            push acc
102F 7401      1636            mov a, #1
1031 14        1636            dec a
1032 12024A    1636            lcall ?Set_Cursor_2 ; Select column and row
1035 D0E0      1636            pop acc
1037 C083      1637            push dph
1039 C082      1637            push dpl
103B C0E0      1637            push acc
103D 9000B6    1637            mov dptr, #reflow_temp_message
1040 12023F    1637            lcall ?Send_Constant_String
1043 D0E0      1637            pop acc
1045 D082      1637            pop dpl
1047 D083      1637            pop dph
1049           1638   
1049 C205      1639       clr SELECT_BUTTON_FLAG
104B C207      1640       clr KEYPAD_FLAG
104D 757A00    1641       mov keypad_digit_count, #0
1050           1642   
1050           1643   StateC:
1050 12072C    1644       lcall Service_Timer_Flags
1053 30B23F    1645       jnb RESET_BUTTON, StateC_ResetToMain
1056 AE31      1646       mov R6, STATE_VAR_2
1058 BE0240    1647       cjne R6, #2, StateC_D
105B           1648   
105B 1209E2    1649       lcall Check_Select_Button_Press
105E 20053D    1650       jb SELECT_BUTTON_FLAG, StateCtoDone
1061           1651   
1061 855467    1652       mov x+0, reflow_temp_set+0
1064 855568    1653       mov x+1, reflow_temp_set+1
1067 756900    1654       mov x+2, #0x0000
106A 756A00    1655       mov x+3, #0x0000
106D           1656   
106D 120267    1657       lcall hex2bcd
1070           1658   
1070 C0E0      1659            push acc
1072 740C      1659            mov a, #12
1074 14        1659            dec a
1075 12024A    1659            lcall ?Set_Cursor_2 ; Select column and row
1078 D0E0      1659            pop acc
107A C000      1660            push ar0
107C A870      1660            mov r0, bcd+1
107E 120251    1660            lcall ?Display_BCD
1081 D000      1660            pop ar0
1083 C000      1661            push ar0
1085 A86F      1661            mov r0, bcd+0
1087 120251    1661            lcall ?Display_BCD
108A D000      1661            pop ar0
108C           1662   
108C 1209F1    1663       lcall Check_Param_Button_Press
108F 200668    1664       jb PARAM_BUTTON_FLAG, Inc_Reflow_Temp
1092 0210A1    1665       ljmp StateC_Keypad
1095           1666   
1095           1667   StateC_ResetToMain:
1095 757900    1668            mov current_state, #ST_PINIT
1098 020B70    1669            ljmp MAIN_LOOP
109B           1670   
109B           1671   StateC_D:
109B 02112D    1672   ljmp StateDInit
109E           1673   
109E           1674   StateCtoDone:
109E 02111E    1675   ljmp StateCDone
10A1           1676   
10A1           1677   StateC_Keypad:
10A1 12086B    1678       lcall Keypad
10A4 50AA      1679       jnc StateC
10A6 EF        1680       mov a, R7
10A7 B40A03    1681       cjne a, #10, StateC_Keypad_not10
10AA 021050    1682       ljmp StateC
10AD           1683   StateC_Keypad_not10:
10AD 50A1      1684       jnc StateC
10AF 20070C    1685       jb KEYPAD_FLAG, StateC_Keypad_Continue
10B2 D207      1686       setb KEYPAD_FLAG
10B4           1687   
10B4 7400      1688       mov a, #0
10B6 F56F      1689       mov bcd+0, a
10B8 F570      1690       mov bcd+1, a
10BA F571      1691       mov bcd+2, a
10BC F572      1692       mov bcd+3, a
10BE           1693   
10BE           1694   StateC_Keypad_Continue:
10BE 1207EA    1695       lcall Shift_Digits_Left
10C1 508D      1696       jnc StateC
10C3           1697   
10C3 1202B4    1698       lcall bcd2hex
10C6           1699   
10C6 856754    1700       mov reflow_temp_set+0, x+0
10C9 856855    1701       mov reflow_temp_set+1, x+1
10CC           1702   
10CC 855467    1703       mov x+0, reflow_temp_set+0
10CF 855568    1704       mov x+1, reflow_temp_set+1
10D2 756900    1705       mov x+2, #0
10D5 756A00    1706       mov x+3, #0
10D8 120267    1707       lcall hex2bcd
10DB           1708   
10DB C0E0      1709            push acc
10DD 740C      1709            mov a, #12
10DF 14        1709            dec a
10E0 12024A    1709            lcall ?Set_Cursor_2 ; Select column and row
10E3 D0E0      1709            pop acc
10E5 C000      1710            push ar0
10E7 A870      1710            mov r0, bcd+1
10E9 120251    1710            lcall ?Display_BCD
10EC D000      1710            pop ar0
10EE C000      1711            push ar0
10F0 A86F      1711            mov r0, bcd+0
10F2 120251    1711            lcall ?Display_BCD
10F5 D000      1711            pop ar0
10F7           1712   
10F7 021050    1713       ljmp StateC
10FA           1714   
10FA           1715   
10FA           1716       Inc_Reflow_Temp:
10FA C206      1717           clr PARAM_BUTTON_FLAG
10FC           1718   
10FC E554      1719           mov a, reflow_temp_set
10FE           1720   
10FE 20E80B    1721           jb UPDOWN, Dec_Reflow_Temp
1101 20E904    1722           jb TENS, Inc_Reflow_Temp_Tens
1104           1723   
1104 2401      1724           add a, #1
1106 8011      1725           sjmp Reflow_Temp_Tens_Done
1108           1726   
1108           1727       Inc_Reflow_Temp_Tens:
1108 240A      1728           add a, #10
110A 800D      1729           sjmp Reflow_Temp_Tens_Done
110C           1730   
110C           1731       Dec_Reflow_Temp:
110C 20E905    1732           jb TENS, Dec_Reflow_Temp_Tens
110F           1733   
110F C3        1734           clr c
1110 9401      1735           subb a, #1
1112 8005      1736           sjmp Reflow_Temp_Tens_Done
1114           1737   
1114           1738       Dec_Reflow_Temp_Tens:
1114 C3        1739           clr c
1115 940A      1740           subb a, #10
1117 8000      1741           sjmp Reflow_Temp_Tens_Done
1119           1742   
1119           1743       Reflow_Temp_Tens_Done:
1119 F554      1744           mov reflow_temp_set, a
111B 021050    1745           ljmp StateC
111E           1746   
111E           1747   StateCDone:
111E 120A64    1748       lcall BeepSpeaker
1121 0531      1749       inc STATE_VAR_2
1123 C205      1750       clr SELECT_BUTTON_FLAG
1125 C207      1751       clr KEYPAD_FLAG
1127 757A00    1752       mov keypad_digit_count, #0
112A 021050    1753       ljmp StateC
112D           1754   
112D           1755   
112D           1756   StateDInit:
112D C0E0      1757            push acc
112F 7401      1757            mov a, #1
1131 14        1757            dec a
1132 12024A    1757            lcall ?Set_Cursor_2 ; Select column and row
1135 D0E0      1757            pop acc
1137 C083      1758            push dph
1139 C082      1758            push dpl
113B C0E0      1758            push acc
113D 9000C7    1758            mov dptr, #reflow_time_message
1140 12023F    1758            lcall ?Send_Constant_String
1143 D0E0      1758            pop acc
1145 D082      1758            pop dpl
1147 D083      1758            pop dph
1149           1759   
1149 C205      1760       clr SELECT_BUTTON_FLAG
114B C207      1761       clr KEYPAD_FLAG
114D 757A00    1762       mov keypad_digit_count, #0
1150           1763   
1150           1764   StateD:
1150 12072C    1765       lcall Service_Timer_Flags
1153 30B235    1766       jnb RESET_BUTTON, StateD_ResetToMain
1156 AE31      1767       mov R6, STATE_VAR_2
1158 BE0336    1768       cjne R6, #3, StateD_R
115B           1769   
115B 1209E2    1770       lcall Check_Select_Button_Press
115E 200533    1771       jb SELECT_BUTTON_FLAG, StateDtoDone
1161           1772   
1161 855667    1773       mov x+0, reflow_time_set+0
1164 756800    1774       mov x+1, #0
1167 756900    1775       mov x+2, #0
116A 756A00    1776       mov x+3, #0
116D 120267    1777       lcall hex2bcd
1170           1778   
1170 C0E0      1779            push acc
1172 740C      1779            mov a, #12
1174 14        1779            dec a
1175 12024A    1779            lcall ?Set_Cursor_2 ; Select column and row
1178 D0E0      1779            pop acc
117A C000      1780            push ar0
117C A86F      1780            mov r0, bcd+0
117E 120251    1780            lcall ?Display_BCD
1181 D000      1780            pop ar0
1183           1781   
1183 1209F1    1782       lcall Check_Param_Button_Press
1186 20065E    1783       jb PARAM_BUTTON_FLAG, Inc_Reflow_Time
1189 800C      1784       sjmp StateD_Keypad
118B           1785   
118B           1786   StateD_ResetToMain:
118B 757900    1787            mov current_state, #ST_PINIT
118E 020B70    1788            ljmp MAIN_LOOP
1191           1789   
1191           1790   StateD_R:
1191 02121A    1791   ljmp ReadyStateInit
1194           1792   
1194           1793   StateDtoDone:
1194 02120B    1794   ljmp StateDDone
1197           1795   
1197           1796   StateD_Keypad:
1197 12086B    1797       lcall Keypad
119A 50B4      1798       jnc StateD
119C EF        1799       mov a, R7
119D B40A03    1800       cjne a, #10, StateD_Keypad_not10
11A0 021150    1801       ljmp StateD
11A3           1802   StateD_Keypad_not10:
11A3 50AB      1803       jnc StateD
11A5 20070C    1804       jb KEYPAD_FLAG, StateD_Keypad_Continue
11A8 D207      1805       setb KEYPAD_FLAG
11AA           1806   
11AA 7400      1807       mov a, #0
11AC F56F      1808       mov bcd+0, a
11AE F570      1809       mov bcd+1, a
11B0 F571      1810       mov bcd+2, a
11B2 F572      1811       mov bcd+3, a
11B4           1812   
11B4           1813   StateD_Keypad_Continue:
11B4 1207EA    1814       lcall Shift_Digits_Left
11B7 5097      1815       jnc StateD
11B9           1816   
11B9 1202B4    1817       lcall bcd2hex
11BC           1818   
11BC 856756    1819       mov reflow_time_set+0, x+0
11BF 755700    1820       mov reflow_time_set+1, #0
11C2           1821   
11C2 855667    1822       mov x+0, reflow_time_set+0
11C5 756800    1823       mov x+1, #0
11C8 756900    1824       mov x+2, #0
11CB 756A00    1825       mov x+3, #0
11CE 120267    1826       lcall hex2bcd
11D1           1827   
11D1 C0E0      1828            push acc
11D3 740C      1828            mov a, #12
11D5 14        1828            dec a
11D6 12024A    1828            lcall ?Set_Cursor_2 ; Select column and row
11D9 D0E0      1828            pop acc
11DB           1829       ;Display_BCD(bcd+1)
11DB C000      1830            push ar0
11DD A86F      1830            mov r0, bcd+0
11DF 120251    1830            lcall ?Display_BCD
11E2 D000      1830            pop ar0
11E4           1831   
11E4 021150    1832       ljmp StateD
11E7           1833   
11E7           1834   
11E7           1835       Inc_Reflow_Time:        
11E7 C206      1836           clr PARAM_BUTTON_FLAG
11E9 E556      1837           mov a, reflow_time_set
11EB           1838   
11EB 20E80B    1839           jb UPDOWN, Dec_Reflow_Time
11EE 20E904    1840           jb TENS, Inc_Reflow_Time_Tens
11F1           1841   
11F1 2401      1842           add a, #1
11F3 8011      1843           sjmp Reflow_Time_Tens_Done
11F5           1844   
11F5           1845       Inc_Reflow_Time_Tens:
11F5 240A      1846           add a, #10
11F7 800D      1847           sjmp Reflow_Time_Tens_Done
11F9           1848   
11F9           1849       Dec_Reflow_Time:
11F9 20E905    1850           jb TENS, Dec_Reflow_Time_Tens
11FC           1851   
11FC C3        1852           clr c
11FD 9401      1853           subb a, #1
11FF 8005      1854           sjmp Reflow_Time_Tens_Done
1201           1855   
1201           1856       Dec_Reflow_Time_Tens:
1201 C3        1857           clr c
1202 940A      1858           subb a, #10
1204 8000      1859           sjmp Reflow_Time_Tens_Done
1206           1860   
1206           1861       Reflow_Time_Tens_Done:
1206 F556      1862           mov reflow_time_set, a
1208 021150    1863           ljmp StateD
120B           1864   
120B           1865   StateDDone:
120B 120A64    1866       lcall BeepSpeaker
120E 0531      1867       inc STATE_VAR_2
1210 C205      1868       clr SELECT_BUTTON_FLAG
1212 C207      1869       clr KEYPAD_FLAG
1214 757A00    1870       mov keypad_digit_count, #0
1217 021150    1871       ljmp StateD
121A           1872   
121A           1873   
121A           1874   ReadyStateInit:
121A C0E0      1875            push acc
121C 7401      1875            mov a, #1
121E 14        1875            dec a
121F 12024C    1875            lcall ?Set_Cursor_1 ; Select column and row
1222 D0E0      1875            pop acc
1224 C083      1876            push dph
1226 C082      1876            push dpl
1228 C0E0      1876            push acc
122A 9000D8    1876            mov dptr, #ready_message
122D 12023F    1876            lcall ?Send_Constant_String
1230 D0E0      1876            pop acc
1232 D082      1876            pop dpl
1234 D083      1876            pop dph
1236 C0E0      1877            push acc
1238 7401      1877            mov a, #1
123A 14        1877            dec a
123B 12024A    1877            lcall ?Set_Cursor_2 ; Select column and row
123E D0E0      1877            pop acc
1240 C083      1878            push dph
1242 C082      1878            push dpl
1244 C0E0      1878            push acc
1246 90002E    1878            mov dptr, #blank_row
1249 12023F    1878            lcall ?Send_Constant_String
124C D0E0      1878            pop acc
124E D082      1878            pop dpl
1250 D083      1878            pop dph
1252 C205      1879       clr SELECT_BUTTON_FLAG
1254 C206      1880       clr PARAM_BUTTON_FLAG
1256 C207      1881       clr KEYPAD_FLAG
1258 757A00    1882       mov keypad_digit_count, #0
125B 757907    1883       mov current_state, #ST_READY_WAIT
125E 020B70    1884       ljmp MAIN_LOOP
1261           1885   
1261           1886   ; Non-blocking wait for START button (called every MAIN_LOOP iteration)
1261           1887   ReadyStateWait:
1261 20B52A    1888       jb START_BUTTON, ReadyStateWait_stay
1264 120767    1889       lcall Wait50ms
1267 20B524    1890       jb START_BUTTON, ReadyStateWait_stay
126A C0E0      1891            push acc
126C 7401      1891            mov a, #1
126E 14        1891            dec a
126F 12024C    1891            lcall ?Set_Cursor_1 ; Select column and row
1272 D0E0      1891            pop acc
1274 C083      1892            push dph
1276 C082      1892            push dpl
1278 C0E0      1892            push acc
127A 9000E9    1892            mov dptr, #state0_message
127D 12023F    1892            lcall ?Send_Constant_String
1280 D0E0      1892            pop acc
1282 D082      1892            pop dpl
1284 D083      1892            pop dph
1286 D200      1893       setb START_FLAG
1288 757908    1894       mov current_state, #ST_0
128B 020B70    1895       ljmp MAIN_LOOP
128E           1896   ReadyStateWait_stay:
128E 757907    1897       mov current_state, #ST_READY_WAIT
1291 020B70    1898       ljmp MAIN_LOOP
1294           1899   
1294           1900   ;================== FSM2: REFLOW PROFILE (thermocouple in oven) ==================;
1294           1901   ; State0=idle, State1=Ramp To Soak, State2=Soak, State3=Ramp To Peak,
1294           1902   ; State4=Reflow, State5=Cooling. Temp read every 20ms via Service_Timer_Flags.
1294           1903   ;==================Reflow Profile FSM==================;
1294           1904   ;Checklist:
1294           1905   ; 1. Implement TEMP and TIME variables - DONE
1294           1906   ; 2. Implement FSM outputs - DONE
1294           1907   ; 3. Implement reset logic - DONE
1294           1908   ; 4. Implement abort condition - DONE
1294           1909   ; 5. Implement LCD Feedback for Each State - Tentatively Done (Still not tested)
1294           1910   ; 6. Speaker beeps for state transitions - DONE
1294           1911   ;*Abort condition needs to be in state 1* - FIXED
1294           1912   ; 7. Rewrite State Transitions with SUBB - DONE
1294           1913   State0:
1294 12072C    1914       lcall Service_Timer_Flags
1297 30B713    1915       jnb STOP_BUTTON, State0_StopReflow
129A C280      1916       CLR p0.0 ;oven off
129C E530      1917       mov a, STATE_VAR_1
129E 754200    1918       mov TIME, #0
12A1 B40026    1919       cjne a, #0, State1
12A4 200009    1920       jb START_FLAG, State0Done
12A7 757908    1921       mov current_state, #ST_0
12AA 020B70    1922       ljmp MAIN_LOOP
12AD           1923   
12AD           1924   State0_StopReflow:
12AD 021501    1925            ljmp StopReflow
12B0           1926   
12B0           1927   State0Done:
12B0 120A64    1928       lcall BeepSpeaker
12B3 756400    1929       MOV PHASE, #00h
12B6 756303    1930       MOV ON_SECS, #3
12B9 756514    1931       MOV LEAD, #20
12BC 0530      1932       inc STATE_VAR_1
12BE 754464    1933       mov POWER, #100
12C1 754200    1934       mov TIME, #0
12C4 757908    1935       mov current_state, #ST_0
12C7 020B70    1936       ljmp MAIN_LOOP
12CA           1937   State1:
12CA 12072C    1938       lcall Service_Timer_Flags
12CD 30B23A    1939       jnb RESET_BUTTON, State1_ResetToMain
12D0 30B73A    1940       jnb STOP_BUTTON, State1_StopReflow
12D3 E530      1941       mov a, STATE_VAR_1
12D5 B40153    1942       cjne a, #1, State2
12D8 C0E0      1943            push acc
12DA 7401      1943            mov a, #1
12DC 14        1943            dec a
12DD 12024C    1943            lcall ?Set_Cursor_1 ; Select column and row
12E0 D0E0      1943            pop acc
12E2 C083      1944            push dph
12E4 C082      1944            push dpl
12E6 C0E0      1944            push acc
12E8 9000FA    1944            mov dptr, #state1_message
12EB 12023F    1944            lcall ?Send_Constant_String
12EE D0E0      1944            pop acc
12F0 D082      1944            pop dpl
12F2 D083      1944            pop dph
12F4 120A70    1945       lcall FSM2_Temp_Time_display
12F7 12137C    1946       lcall CheckAbortCondition ;Must abort if 50 degrees isn't reached in first 60 seconds
12FA           1947   
12FA 85504C    1948       mov TARGET+0, SOAK_TEMP_set+0
12FD 85514D    1949       mov TARGET+1, SOAK_TEMP_set+1
1300 E53D      1950       mov a, TEMP+0
1302 C3        1951       clr c
1303 954C      1952       subb a, TARGET+0
1305 4009      1953       jc CheckCarryState1 ; C = 1, Keep heating
1307 02131A    1954       ljmp GreaterThanState1 ; C = 0, Transition States
130A           1955   
130A           1956   State1_ResetToMain:
130A 0214F5    1957   ljmp ResetToMain
130D           1958   
130D           1959   State1_StopReflow:
130D 021501    1960   ljmp StopReflow
1310           1961   
1310           1962   CheckCarryState1:
1310 4002      1963       jc LessThanState1
1312 8006      1964       sjmp GreaterThanState1
1314           1965   LessThanState1:
1314 757909    1966       mov current_state, #ST_1
1317 020B70    1967       ljmp MAIN_LOOP
131A           1968   GreaterThanState1:
131A 120A64    1969       lcall BeepSpeaker
131D 0530      1970       inc STATE_VAR_1
131F 754414    1971       mov POWER, #20
1322 754200    1972       mov TIME, #0
1325 757909    1973       mov current_state, #ST_1
1328 020B70    1974       ljmp MAIN_LOOP
132B           1975   State2:
132B 12072C    1976       lcall Service_Timer_Flags
132E 30B23A    1977       jnb RESET_BUTTON, State2_ResetToMain
1331 30B73A    1978       jnb STOP_BUTTON, State2_StopReflow
1334 E530      1979       mov a, STATE_VAR_1
1336 B4022F    1980       cjne a, #2, State2_State3
1339 C0E0      1981            push acc
133B 7401      1981            mov a, #1
133D 14        1981            dec a
133E 12024C    1981            lcall ?Set_Cursor_1 ; Select column and row
1341 D0E0      1981            pop acc
1343 C083      1982            push dph
1345 C082      1982            push dpl
1347 C0E0      1982            push acc
1349 90010B    1982            mov dptr, #state2_message
134C 12023F    1982            lcall ?Send_Constant_String
134F D0E0      1982            pop acc
1351 D082      1982            pop dpl
1353 D083      1982            pop dph
1355 120A70    1983       lcall FSM2_Temp_Time_display
1358 85524E    1984       mov TARGET_TIME+0, SOAK_TIME_set+0
135B 85534F    1985       mov TARGET_TIME+1, SOAK_TIME_set+1
135E E542      1986       mov a, TIME+0
1360 C3        1987       clr c
1361 954E      1988       subb a, TARGET_TIME+0
1363 4020      1989       jc CheckCarryState2 ; C = 1, TIME < TARGET_TIME
1365 02138F    1990       ljmp GreaterThanState2 ; C = 0, TIME > TARGET_TIME -> transition states
1368           1991   
1368           1992   State2_State3:
1368 0213A6    1993       ljmp State3
136B           1994   
136B           1995   State2_ResetToMain:
136B 0214F5    1996   ljmp ResetToMain
136E           1997   
136E           1998   State2_StopReflow:
136E 021501    1999   ljmp StopReflow
1371           2000   
1371           2001   State1_CheckOven:
1371 E542      2002   mov a, TIME
1373 B43C00    2003   cjne a, #60, State1TimeCheckCarry
1376           2004   
1376           2005   State1TimeCheckCarry:
1376 4003      2006   jc TrampolineState1 ; 60 Seconds haven't passed
1378 021545    2007   ljmp STOPOVEN
137B           2008   
137B           2009   TrampolineState1:
137B 22        2010   ret
137C           2011   
137C           2012   CheckAbortCondition:
137C E53D      2013       mov a, TEMP
137E B43201    2014       cjne a, #50, CheckAbortCarry
1381 22        2015       ret
1382           2016   CheckAbortCarry:
1382 40ED      2017       jc State1_CheckOven          
1384 22        2018       ret
1385           2019   CheckCarryState2:
1385 4002      2020       jc LessThanState2
1387 8006      2021       sjmp GreaterThanState2
1389           2022   LessThanState2:
1389 75790A    2023       mov current_state, #ST_2
138C 020B70    2024       ljmp MAIN_LOOP
138F           2025   GreaterThanState2:
138F 120A64    2026       lcall BeepSpeaker
1392 756400    2027       MOV PHASE, #00h
1395 756303    2028       MOV ON_SECS, #3
1398 75650A    2029       MOV LEAD, #10
139B 0530      2030       inc STATE_VAR_1
139D 754464    2031       mov POWER, #100
13A0 75790A    2032       mov current_state, #ST_2
13A3 020B70    2033       ljmp MAIN_LOOP
13A6           2034   State3:
13A6 12072C    2035       lcall Service_Timer_Flags
13A9 30B237    2036       jnb RESET_BUTTON, State3_ResetToMain
13AC 30B737    2037       jnb STOP_BUTTON, State3_StopReflow
13AF E530      2038       mov a, STATE_VAR_1
13B1 B40350    2039       cjne a, #3, State4
13B4 C0E0      2040            push acc
13B6 7401      2040            mov a, #1
13B8 14        2040            dec a
13B9 12024C    2040            lcall ?Set_Cursor_1 ; Select column and row
13BC D0E0      2040            pop acc
13BE C083      2041            push dph
13C0 C082      2041            push dpl
13C2 C0E0      2041            push acc
13C4 90011C    2041            mov dptr, #state3_message
13C7 12023F    2041            lcall ?Send_Constant_String
13CA D0E0      2041            pop acc
13CC D082      2041            pop dpl
13CE D083      2041            pop dph
13D0 120A70    2042       lcall FSM2_Temp_Time_display
13D3 85544C    2043       mov TARGET+0, reflow_temp_set+0
13D6 85554D    2044       mov TARGET+1, reflow_temp_set+1
13D9 E53D      2045       mov a, TEMP+0
13DB C3        2046       clr c
13DC 954C      2047       subb a, TARGET+0
13DE 4009      2048       jc CheckCarryState3 ; C = 1, TEMP < TARGET -> Keep Heating
13E0 0213F3    2049       ljmp GreaterThanState3 ; C = 0, TEMP > TARGET -> Transition States    
13E3           2050   
13E3           2051   State3_ResetToMain:
13E3 0214F5    2052   ljmp ResetToMain
13E6           2053   
13E6           2054   State3_StopReflow:
13E6 021501    2055   ljmp StopReflow
13E9           2056   
13E9           2057   CheckCarryState3:
13E9 4002      2058       jc LessThanState3
13EB 8006      2059       sjmp GreaterThanState3
13ED           2060   LessThanState3:
13ED 75790B    2061       mov current_state, #ST_3
13F0 020B70    2062       ljmp MAIN_LOOP
13F3           2063   GreaterThanState3:
13F3 120A64    2064       lcall BeepSpeaker
13F6 0530      2065       inc STATE_VAR_1
13F8 754414    2066       mov POWER, #20
13FB 754200    2067       mov TIME, #0
13FE 75790B    2068       mov current_state, #ST_3
1401 020B70    2069       ljmp MAIN_LOOP
1404           2070   State4:
1404 30B23A    2071       jnb RESET_BUTTON, ResetToMainState4
1407 30B734    2072       jnb STOP_BUTTON, StopReflowState4
140A E530      2073       mov a, STATE_VAR_1
140C B4044D    2074       cjne a, #4, State5
140F C0E0      2075            push acc
1411 7401      2075            mov a, #1
1413 14        2075            dec a
1414 12024C    2075            lcall ?Set_Cursor_1 ; Select column and row
1417 D0E0      2075            pop acc
1419 C083      2076            push dph
141B C082      2076            push dpl
141D C0E0      2076            push acc
141F 90012D    2076            mov dptr, #state4_message
1422 12023F    2076            lcall ?Send_Constant_String
1425 D0E0      2076            pop acc
1427 D082      2076            pop dpl
1429 D083      2076            pop dph
142B 120A70    2077       lcall FSM2_Temp_Time_display
142E 85564E    2078       mov TARGET_TIME+0, REFLOW_TIME_set+0
1431 85574F    2079       mov TARGET_TIME+1, REFLOW_TIME_set+1
1434 E542      2080       mov a, TIME+0
1436 C3        2081       clr c
1437 954E      2082       subb a, TARGET_TIME+0
1439 4009      2083       jc CheckCarryState4 ; C = 1, TIME < TARGET_TIME -> Keep Going
143B 02144E    2084       ljmp GreaterThanState4 ; C = 0, TIME > TARGET_TIME -> Transition States
143E           2085   StopReflowState4:
143E 021501    2086       ljmp StopReflow
1441           2087   ResetToMainState4:
1441 0214F5    2088       ljmp ResetToMain
1444           2089   CheckCarryState4:
1444 4002      2090       jc LessThanState4
1446 8006      2091       sjmp GreaterThanState4
1448           2092   LessThanState4:
1448 75790C    2093       mov current_state, #ST_4
144B 020B70    2094       ljmp MAIN_LOOP
144E           2095   GreaterThanState4:
144E 120A64    2096       lcall BeepSpeaker
1451 0530      2097       inc STATE_VAR_1
1453 754400    2098       mov POWER, #0
1456 75790C    2099       mov current_state, #ST_4
1459 020B70    2100       ljmp MAIN_LOOP
145C           2101   State5:
145C 12072C    2102       lcall Service_Timer_Flags
145F 30B23A    2103       jnb RESET_BUTTON, ResetToMainState5
1462 30B73A    2104       jnb STOP_BUTTON, StopReflowState5
1465 C280      2105       CLR p0.0 ;turn oven off
1467 E530      2106       mov a, STATE_VAR_1    
1469 B40536    2107       cjne a, #5, State5toDone
146C 85464C    2108       mov TARGET+0, DEGREES60+0
146F 85474D    2109       mov TARGET+1, DEGREES60+1
1472 E53D      2110       mov a, TEMP+0
1474 C0E0      2111            push acc
1476 7401      2111            mov a, #1
1478 14        2111            dec a
1479 12024C    2111            lcall ?Set_Cursor_1 ; Select column and row
147C D0E0      2111            pop acc
147E C083      2112            push dph
1480 C082      2112            push dpl
1482 C0E0      2112            push acc
1484 90013E    2112            mov dptr, #state5_message
1487 12023F    2112            lcall ?Send_Constant_String
148A D0E0      2112            pop acc
148C D082      2112            pop dpl
148E D083      2112            pop dph
1490 120A70    2113       lcall FSM2_Temp_Time_display
1493 B43C4A    2114       cjne a, #60, CheckCarryState5
1496 75790D    2115       mov current_state, #ST_5
1499 020B70    2116       ljmp MAIN_LOOP
149C           2117   
149C           2118   ResetToMainState5:
149C 0214F5    2119       ljmp ResetToMain
149F           2120   
149F           2121   StopReflowState5:
149F 021501    2122       ljmp StopReflow
14A2           2123       
14A2           2124   State5toDone:
14A2 120A64    2125       lcall BeepSpeaker
14A5 C0E0      2126            push acc
14A7 7401      2126            mov a, #1
14A9 14        2126            dec a
14AA 12024C    2126            lcall ?Set_Cursor_1 ; Select column and row
14AD D0E0      2126            pop acc
14AF C083      2127            push dph
14B1 C082      2127            push dpl
14B3 C0E0      2127            push acc
14B5 900171    2127            mov dptr, #reflowdone_message
14B8 12023F    2127            lcall ?Send_Constant_String
14BB D0E0      2127            pop acc
14BD D082      2127            pop dpl
14BF D083      2127            pop dph
14C1 C0E0      2128            push acc
14C3 7401      2128            mov a, #1
14C5 14        2128            dec a
14C6 12024A    2128            lcall ?Set_Cursor_2 ; Select column and row
14C9 D0E0      2128            pop acc
14CB C083      2129            push dph
14CD C082      2129            push dpl
14CF C0E0      2129            push acc
14D1 900182    2129            mov dptr, #restart_message
14D4 12023F    2129            lcall ?Send_Constant_String
14D7 D0E0      2129            pop acc
14D9 D082      2129            pop dpl
14DB D083      2129            pop dph
14DD 02159D    2130       ljmp ReflowDone
14E0           2131   
14E0           2132   CheckCarryState5:
14E0 4002      2133       jc LessThanState5
14E2 800B      2134       sjmp GreaterThanState5
14E4           2135   LessThanState5:
14E4 753000    2136       mov STATE_VAR_1, #0
14E7 C200      2137       clr START_FLAG
14E9 75790D    2138       mov current_state, #ST_5
14EC 020B70    2139       ljmp MAIN_LOOP
14EF           2140   GreaterThanState5:
14EF 75790D    2141       mov current_state, #ST_5
14F2 020B70    2142       ljmp MAIN_LOOP
14F5           2143   
14F5           2144   ResetToMain:
14F5 753000    2145       mov STATE_VAR_1, #0
14F8 754400    2146       mov POWER, #0
14FB 757900    2147       mov current_state, #ST_PINIT
14FE 020B70    2148       ljmp MAIN_LOOP
1501           2149   
1501           2150   StopReflow:
1501 D290      2151       setb RED_LED
1503 C0E0      2152            push acc
1505 7401      2152            mov a, #1
1507 14        2152            dec a
1508 12024C    2152            lcall ?Set_Cursor_1 ; Select column and row
150B D0E0      2152            pop acc
150D C083      2153            push dph
150F C082      2153            push dpl
1511 C0E0      2153            push acc
1513 900193    2153            mov dptr, #stop_message
1516 12023F    2153            lcall ?Send_Constant_String
1519 D0E0      2153            pop acc
151B D082      2153            pop dpl
151D D083      2153            pop dph
151F C0E0      2154            push acc
1521 7401      2154            mov a, #1
1523 14        2154            dec a
1524 12024A    2154            lcall ?Set_Cursor_2 ; Select column and row
1527 D0E0      2154            pop acc
1529 C083      2155            push dph
152B C082      2155            push dpl
152D C0E0      2155            push acc
152F 900182    2155            mov dptr, #restart_message
1532 12023F    2155            lcall ?Send_Constant_String
1535 D0E0      2155            pop acc
1537 D082      2155            pop dpl
1539 D083      2155            pop dph
153B 120A64    2156       lcall BeepSpeaker
153E C280      2157       clr OVEN_PIN ; Turn power off
1540           2158   ForeverStopped:
1540 30B257    2159       jnb RESET_BUTTON, RestartProcess
1543 80FB      2160       sjmp ForeverStopped
1545           2161   
1545           2162   STOPOVEN:
1545 D290      2163       setb RED_LED
1547 C0E0      2164            push acc
1549 7401      2164            mov a, #1
154B 14        2164            dec a
154C 12024C    2164            lcall ?Set_Cursor_1 ; Select column and row
154F D0E0      2164            pop acc
1551 C083      2165            push dph
1553 C082      2165            push dpl
1555 C0E0      2165            push acc
1557 90014F    2165            mov dptr, #abortcondition_message
155A 12023F    2165            lcall ?Send_Constant_String
155D D0E0      2165            pop acc
155F D082      2165            pop dpl
1561 D083      2165            pop dph
1563 C0E0      2166            push acc
1565 7401      2166            mov a, #1
1567 14        2166            dec a
1568 12024A    2166            lcall ?Set_Cursor_2 ; Select column and row
156B D0E0      2166            pop acc
156D C083      2167            push dph
156F C082      2167            push dpl
1571 C0E0      2167            push acc
1573 900182    2167            mov dptr, #restart_message
1576 12023F    2167            lcall ?Send_Constant_String
1579 D0E0      2167            pop acc
157B D082      2167            pop dpl
157D D083      2167            pop dph
157F 7C0A      2168       mov R4, #10
1581           2169   STOPOVENSpeakerLoop:
1581 120A64    2170       lcall BeepSpeaker
1584 120767    2171       lcall Wait50ms
1587 120767    2172       lcall Wait50ms
158A 120767    2173       lcall Wait50ms
158D 120767    2174       lcall Wait50ms
1590 120767    2175       lcall Wait50ms
1593 DCEC      2176       djnz R4, STOPOVENSpeakerLoop
1595           2177   ForeverStop:
1595 30B202    2178       jnb RESET_BUTTON, RestartProcess
1598 80FB      2179       sjmp ForeverStop ; Infinite loop to stop the oven if abort condition is met
159A           2180   
159A           2181   RestartProcess:
159A 020AFF    2182       ljmp MAIN
159D           2183       
159D           2184   ReflowDone:
159D D2B1      2185       setb GREEN_LED
159F 7C05      2186       mov R4, #5
15A1           2187   SpeakerLoop:
15A1 120A64    2188       lcall BeepSpeaker
15A4 120767    2189       lcall Wait50ms
15A7 120767    2190       lcall Wait50ms
15AA 120767    2191       lcall Wait50ms
15AD 120767    2192       lcall Wait50ms
15B0 120767    2193       lcall Wait50ms
15B3 DCEC      2194       djnz R4, SpeakerLoop
15B5           2195   Forever:
15B5 30B202    2196       jnb RESET_BUTTON, ForeverToMain
15B8 80FB      2197       sjmp Forever
15BA           2198   ForeverToMain:
15BA 0214F5    2199            ljmp ResetToMain
15BD           2200   END
